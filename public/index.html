<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NÃ¶bet Robotu Pro v2</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  <script src="https://unpkg.com/read-excel-file@5.x/bundle/read-excel-file.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC7w00A_jYCCBrnDASD1RjoYHjyKsKeLBI",
      authDomain: "nobetyap-29acf.firebaseapp.com",
      projectId: "nobetyap-29acf",
      storageBucket: "nobetyap-29acf.firebasestorage.app",
      messagingSenderId: "208653465494",
      appId: "1:208653465494:web:1b821ca6dc73cf27a10fb7"
    };
    try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); } catch(e) { console.warn("Firebase init error:", e); }
  </script>
  <style>
    :root {
      --primary: #2563eb;
      --success: #16a34a;
      --warning: #f59e0b;
      --danger: #ef4444;
      --muted: #64748b;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #f8fafc; margin: 0; padding: 20px; color: #334155; }
    .container { max-width: 1400px; margin: 0 auto; background: #fff; border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,.1); overflow: hidden; }
    .header { background: #1e293b; color: #fff; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { margin: 0; font-size: 20px; }
    
    /* Login */
    #login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
    .login-card { background: #fff; padding: 40px; border-radius: 20px; text-align: center; width: 90%; max-width: 420px; }
    .btn-google { background: #fff; border: 2px solid #e2e8f0; padding: 12px; border-radius: 12px; width: 100%; cursor: pointer; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 12px; }
    .btn-guest { border: 2px dashed #94a3b8; color: #64748b; }
    
    /* Steps */
    .steps { display: flex; justify-content: space-between; padding: 15px 20px; background: #f1f5f9; border-bottom: 1px solid #e2e8f0; overflow-x: auto; gap: 5px; }
    .step { display: flex; align-items: center; gap: 6px; opacity: .5; font-weight: 700; white-space: nowrap; cursor: pointer; font-size: 13px; }
    .step.active { opacity: 1; color: var(--primary); }
    .step-num { background: #cbd5e1; color: #fff; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
    .step.active .step-num { background: var(--primary); }
    .step-content { display: none; padding: 25px; animation: fadeIn .25s; }
    .step-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Form */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .input-group label { display: block; font-size: 11px; font-weight: 800; color: var(--muted); margin-bottom: 4px; text-transform: uppercase; }
    .input-group input, .input-group select { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; }
    
    /* Table */
    .table-responsive { overflow-x: auto; margin-top: 15px; }
    .custom-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .custom-table th { background: #f8fafc; padding: 10px 8px; border: 1px solid #e2e8f0; font-size: 11px; color: #475569; text-align: center; }
    .custom-table td { border: 1px solid #e2e8f0; padding: 6px; text-align: center; }
    .custom-table tbody tr:hover { background: #f8fafc; }
    .inp-cell { width: 100%; border: none; text-align: center; font-weight: 700; font-size: 12px; background: transparent; padding: 4px; }
    .inp-cell:focus { background: #eff6ff; outline: 2px solid var(--primary); border-radius: 4px; }
    
    /* Number input spin button'larÄ±nÄ± gizle (hÄ±zlÄ± sayÄ± sayma sorununu Ã¶nler) */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
    
    /* Buttons */
    .btn { padding: 10px 16px; border-radius: 10px; border: none; font-weight: 800; cursor: pointer; font-size: 13px; display: inline-flex; align-items: center; gap: 6px; transition: all .2s; }
    .btn:hover { transform: translateY(-1px); }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-success { background: var(--success); color: #fff; }
    .btn-warning { background: var(--warning); color: #fff; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-secondary { background: #e2e8f0; color: #475569; }
    .btn-sm { padding: 6px 10px; font-size: 11px; }
    
    /* Badges */
    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 5px 10px; border-radius: 999px; font-weight: 800; font-size: 11px; }
    .badge-ok { background: #dcfce7; color: #166534; }
    .badge-warn { background: #fef3c7; color: #92400e; }
    .badge-bad { background: #fee2e2; color: #991b1b; }
    .badge-info { background: #dbeafe; color: #1e40af; }
    
    /* Rule Box */
    .rule-box { border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px; margin-bottom: 15px; background: #fff; }
    
    /* Calendar Grid */
    .cal-grid { display: grid; grid-template-columns: 180px repeat(31, minmax(28px, 1fr)); gap: 1px; background: #e2e8f0; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; font-size: 11px; max-height: 400px; overflow-y: auto; }
    .cal-cell { background: #fff; padding: 4px; text-align: center; min-height: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; user-select: none; }
    .cal-header { background: #f8fafc; font-weight: 800; position: sticky; top: 0; z-index: 10; }
    .cal-name { justify-content: flex-start; padding-left: 8px; font-weight: 700; position: sticky; left: 0; background: #f9fafb; z-index: 5; }
    .cal-weekend { background: #fef3c7 !important; }
    .cal-tatil { background: #fee2e2 !important; }
    .cal-selected { background: #bfdbfe !important; outline: 2px solid var(--primary); z-index: 2; }
    .cal-mazeret { background: #fbbf24 !important; color: #000; font-weight: 800; }
    .cal-yillik { background: #ef4444 !important; color: #fff; font-weight: 800; }
    .cal-nobetizni { background: #f97316 !important; color: #fff; font-weight: 800; }
    .cal-sabit { background: #22c55e !important; color: #fff; font-weight: 800; }
    
    /* Footer */
    .footer { padding: 15px 25px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; }
    
    /* Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10000; overflow: auto; }
    .modal.active { display: flex; align-items: flex-start; justify-content: center; padding: 30px; }
    .modal-content { background: #fff; border-radius: 16px; width: 100%; max-width: 1000px; max-height: 90vh; overflow: auto; }
    .modal-header { padding: 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #fff; z-index: 10; }
    .modal-body { padding: 20px; }
    
    /* Helpers */
    .help { color: #64748b; font-weight: 600; font-size: 12px; margin-top: 5px; line-height: 1.4; }
    .text-center { text-align: center; }
    .mt-3 { margin-top: 15px; }
    .mb-3 { margin-bottom: 15px; }
    .flex { display: flex; }
    .gap-2 { gap: 10px; }
    .gap-1 { gap: 5px; }
    .flex-wrap { flex-wrap: wrap; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    
    /* Step 5 Editable */
    .editable-cell { cursor: pointer; position: relative; }
    .editable-cell:hover { background: #eff6ff; }
    .editable-cell input { position: absolute; inset: 0; width: 100%; height: 100%; border: 2px solid var(--primary); text-align: center; font-weight: 700; }
    
    /* Devir Icon */
    .devir-icon { 
      color: var(--warning); 
      cursor: help; 
      margin-left: 4px; 
      font-size: 12px;
      position: relative;
    }
    .devir-icon:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #1e293b;
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 11px;
      white-space: nowrap;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    /* Preview Table */
    .preview-table { font-size: 11px; }
    .preview-table th { padding: 6px 4px; font-size: 10px; }
    .preview-table td { padding: 4px; }
    .preview-weekend { background: #fef3c7; }
    .preview-empty { color: #cbd5e1; }
  </style>
</head>
<body>

  <!-- Login Screen -->
  <div id="login-screen">
    <div class="login-card">
      <div style="font-size:50px;">ğŸ¤–</div>
      <h2 style="margin:10px 0 0;">NÃ¶bet Robotu Pro v2</h2>
      <p class="help">Saat bazlÄ± dengeli nÃ¶bet daÄŸÄ±tÄ±m sistemi</p>
      <button class="btn-google" onclick="girisYap()"><i class="fa-brands fa-google"></i> Google ile GiriÅŸ</button>
      <button class="btn-google btn-guest" onclick="misafirGiris()"><i class="fa-solid fa-user"></i> Misafir Modu</button>
    </div>
  </div>

  <!-- Main App -->
  <div class="container" id="main-app" style="display:none;">
    <div class="header">
      <h1><i class="fas fa-robot"></i> NÃ¶bet Robotu Pro v2</h1>
      <div id="user-info" style="display:flex; align-items:center; gap:10px;">
        <span id="user-name" style="font-size:13px;"></span>
        <button class="btn btn-sm btn-danger" onclick="cikisYap()">Ã‡Ä±kÄ±ÅŸ</button>
      </div>
    </div>

    <div class="steps">
      <div class="step active" onclick="goStep(1)" id="step-ind-1"><div class="step-num">1</div> Genel</div>
      <div class="step" onclick="goStep(2)" id="step-ind-2"><div class="step-num">2</div> GÃ¶revler</div>
      <div class="step" onclick="goStep(3)" id="step-ind-3"><div class="step-num">3</div> Personel</div>
      <div class="step" onclick="goStep(4)" id="step-ind-4"><div class="step-num">4</div> KÄ±sÄ±tlar</div>
      <div class="step" onclick="goStep(5)" id="step-ind-5"><div class="step-num">5</div> Hedefler</div>
      <div class="step" onclick="goStep(6)" id="step-ind-6"><div class="step-num">6</div> Ã–nizleme</div>
    </div>

    <!-- STEP 1: Genel Ayarlar -->
    <div class="step-content active" id="step-1">
      <h2>ğŸ“… DÃ¶nem AyarlarÄ±</h2>
      <div class="form-grid">
        <div class="input-group">
          <label>YÄ±l</label>
          <input type="number" id="inp-yil" value="2025">
        </div>
        <div class="input-group">
          <label>Ay</label>
          <select id="inp-ay">
            <option value="1">Ocak</option><option value="2">Åubat</option><option value="3">Mart</option>
            <option value="4">Nisan</option><option value="5">MayÄ±s</option><option value="6">Haziran</option>
            <option value="7">Temmuz</option><option value="8">AÄŸustos</option><option value="9">EylÃ¼l</option>
            <option value="10">Ekim</option><option value="11">KasÄ±m</option><option value="12" selected>AralÄ±k</option>
          </select>
        </div>
        <div class="input-group">
          <label>GÃ¼nlÃ¼k NÃ¶betÃ§i SayÄ±sÄ±</label>
          <input type="number" id="inp-gunluk" value="5" min="1">
        </div>
        <div class="input-group">
          <label>Min. Ara GÃ¼n</label>
          <input type="number" id="inp-aragun" value="2" min="0">
          <div class="help">Ä°ki nÃ¶bet arasÄ± minimum gÃ¼n</div>
        </div>
      </div>

      <div class="rule-box mt-3">
        <h4>ğŸŒ Resmi Tatiller</h4>
        <div class="help mb-3">TAM TATÄ°L = Pazar gibi (16 saat), YARIM GÃœN = Cumartesi gibi (24 saat)</div>
        <div class="flex gap-2 flex-wrap items-center">
          <input type="number" id="rt-gun" placeholder="GÃ¼n" style="width:80px; padding:8px; border:2px solid #e2e8f0; border-radius:8px;">
          <select id="rt-tip" style="padding:8px; border:2px solid #e2e8f0; border-radius:8px;">
            <option value="cum">Cuma (16 saat)</option>
            <option value="cmt">Cumartesi (24 saat)</option>
            <option value="pzr">Pazar (16 saat)</option>
          </select>
          <button class="btn btn-primary btn-sm" onclick="tatilEkle()"><i class="fa-solid fa-plus"></i> Ekle</button>
        </div>
        <div id="tatil-liste" class="mt-3"></div>
      </div>

      <div class="rule-box">
        <h4>â° Saat DeÄŸerleri</h4>
        <div class="help">NÃ¶bet daÄŸÄ±tÄ±mÄ±nda kullanÄ±lan saat deÄŸerleri (deÄŸiÅŸtirilebilir)</div>
        <div class="form-grid mt-3">
          <div class="input-group"><label>Hafta Ä°Ã§i (Pzt-Sal-Ã‡ar)</label><input type="number" id="saat-hici" value="8"></div>
          <div class="input-group"><label>PerÅŸembe</label><input type="number" id="saat-prs" value="8"></div>
          <div class="input-group"><label>Cuma</label><input type="number" id="saat-cum" value="16"></div>
          <div class="input-group"><label>Cumartesi</label><input type="number" id="saat-cmt" value="24"></div>
          <div class="input-group"><label>Pazar</label><input type="number" id="saat-pzr" value="16"></div>
        </div>
      </div>
    </div>

    <!-- STEP 2: GÃ¶rev Yerleri -->
    <div class="step-content" id="step-2">
      <h2>ğŸ¥ GÃ¶rev Yerleri</h2>
      <div class="help mb-3">Her gÃ¶rev iÃ§in isim ve Ã¶zel gÃ¶rev durumunu belirleyin (Ã¶rn: Mavi Kod, Amatem). Az slotlu gÃ¶revler otomatik Ã¶nceliklendirilir.</div>
      <div id="gorev-listesi" class="form-grid"></div>
    </div>

    <!-- STEP 3: Personel -->
    <div class="step-content" id="step-3">
      <div class="flex justify-between items-center flex-wrap gap-2">
        <div>
          <h2 style="margin:0;">ğŸ‘¥ Personel Listesi</h2>
          <div class="help">Personel ekleyin ve yÄ±llÄ±k geÃ§miÅŸ verilerini girin</div>
        </div>
        <div class="flex gap-1">
          <button class="btn btn-success btn-sm" onclick="document.getElementById('excel-upload').click()">
            <i class="fas fa-file-excel"></i> Excel YÃ¼kle
          </button>
          <input type="file" id="excel-upload" hidden accept=".xlsx,.xls" onchange="excelYukle(this)">
          <button class="btn btn-primary btn-sm" onclick="gecmisModalAc()">
            <i class="fa-solid fa-calendar-days"></i> GeÃ§miÅŸ Detay
          </button>
        </div>
      </div>

      <!-- YÄ±llÄ±k Dengeleme Bilgisi -->
      <div id="devir-uyari" class="rule-box mt-3" style="display:none; background:#dbeafe; border-color:#3b82f6;">
        <strong>&#128202; Yillik Dengeleme Aktif</strong>
        <div id="devir-detay" class="help"></div>
      </div>

      <div class="table-responsive mt-3">
        <table class="custom-table" id="personel-table">
          <thead id="personel-thead"></thead>
          <tbody id="personel-tbody"></tbody>
        </table>
      </div>
      <button class="btn btn-secondary btn-sm mt-3" onclick="personelEkle()">
        <i class="fa-solid fa-plus"></i> Personel Ekle
      </button>

      <!-- YÄ±llÄ±k Ã–zet -->
      <div class="mt-3">
        <h4>ğŸ“Š YÄ±llÄ±k Toplam Ã–zet</h4>
        <div class="table-responsive">
          <table class="custom-table" id="ozet-table">
            <thead id="ozet-thead"></thead>
            <tbody id="ozet-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- STEP 4: KÄ±sÄ±tlar -->
    <div class="step-content" id="step-4">
      <h2>â›” KÄ±sÄ±tlamalar ve Mazeretler</h2>
      
      <div class="form-grid">
        <div class="rule-box" style="border-left:4px solid #ef4444;">
          <h4>ğŸš« Birlikte Tutamazlar</h4>
          <div class="flex gap-1 flex-wrap">
            <select id="ayri-p1" class="p-select" style="flex:1; min-width:120px; padding:8px; border:2px solid #e2e8f0; border-radius:8px;"></select>
            <select id="ayri-p2" class="p-select" style="flex:1; min-width:120px; padding:8px; border:2px solid #e2e8f0; border-radius:8px;"></select>
            <button class="btn btn-danger btn-sm" onclick="kuralEkle('ayri')"><i class="fa-solid fa-plus"></i></button>
          </div>
          <ul id="ayri-liste" style="list-style:none; padding:0; margin-top:10px;"></ul>
        </div>

        <div class="rule-box" style="border-left:4px solid #16a34a;">
          <h4>ğŸ¤ Birlikte TutmalÄ±lar</h4>
          <div class="flex gap-1 flex-wrap">
            <select id="birlikte-p1" class="p-select" style="flex:1; min-width:80px; padding:8px; border:2px solid #e2e8f0; border-radius:8px;"></select>
            <select id="birlikte-p2" class="p-select" style="flex:1; min-width:80px; padding:8px; border:2px solid #e2e8f0; border-radius:8px;"></select>
            <select id="birlikte-p3" class="p-select" style="flex:1; min-width:80px; padding:8px; border:2px solid #e2e8f0; border-radius:8px;"></select>
            <button class="btn btn-success btn-sm" onclick="kuralEkle('birlikte')"><i class="fa-solid fa-plus"></i></button>
          </div>
          <ul id="birlikte-liste" style="list-style:none; padding:0; margin-top:10px;"></ul>
        </div>
      </div>

      <!-- Manuel NÃ¶bet AtamasÄ± -->
      <div class="rule-box mt-3" style="border-left:4px solid #2563eb;">
        <h4>ğŸ“Œ Manuel NÃ¶bet AtamasÄ±</h4>
        <div class="help mb-3">Belirli gÃ¼nlere sabit atama yapÄ±n. Bu atamalar deÄŸiÅŸtirilemez ve hedef hesabÄ±na dahil edilir.</div>
        <div class="flex gap-2 flex-wrap items-center">
          <select id="manuel-personel" class="p-select" style="min-width:150px; padding:8px; border:2px solid #e2e8f0; border-radius:8px;"></select>
          <input type="number" id="manuel-gun" placeholder="GÃ¼n" min="1" max="31" style="width:80px; padding:8px; border:2px solid #e2e8f0; border-radius:8px;">
          <select id="manuel-gorev" style="min-width:150px; padding:8px; border:2px solid #e2e8f0; border-radius:8px;"></select>
          <button class="btn btn-primary btn-sm" onclick="manuelAtamaEkle()"><i class="fa-solid fa-plus"></i> Ata</button>
        </div>
        <div id="manuel-atama-liste" class="mt-3"></div>
      </div>

      <!-- KiÅŸi-GÃ¶rev KÄ±sÄ±tlamasÄ± -->
      <div class="rule-box mt-3" style="border-left:4px solid #8b5cf6;">
        <h4>ğŸ¯ KiÅŸi-GÃ¶rev KÄ±sÄ±tlamasÄ±</h4>
        <div class="help mb-3">Bir kiÅŸiyi sadece belirli bir gÃ¶reve atayÄ±n. TÃ¼m nÃ¶betleri o gÃ¶revde tutacak.</div>
        <div class="flex gap-2 flex-wrap items-center">
          <select id="kisitlama-personel" class="p-select" style="min-width:150px; padding:8px; border:2px solid #e2e8f0; border-radius:8px;"></select>
          <span style="font-weight:700;">â†’ sadece â†’</span>
          <select id="kisitlama-gorev" style="min-width:150px; padding:8px; border:2px solid #e2e8f0; border-radius:8px;"></select>
          <button class="btn btn-sm" style="background:#8b5cf6; color:#fff;" onclick="gorevKisitlamasiEkle()"><i class="fa-solid fa-plus"></i> Ekle</button>
        </div>
        <div class="mt-3" style="background:#f5f3ff; padding:10px; border-radius:8px;">
          <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
            <input type="checkbox" id="kisitlama-exclusive" onchange="kisitlamaExclusiveDegisti()">
            <span style="font-weight:700; color:#7c3aed;">ğŸ”’ Sadece kendi aralarÄ±nda dÃ¶nsÃ¼n</span>
          </label>
          <div class="help" style="margin-left:24px;">Aktifse: KÄ±sÄ±tlamalÄ± kiÅŸiler gÃ¶revin TÃœM kapasitesini paylaÅŸÄ±r, diÄŸer kiÅŸiler bu gÃ¶reve atanamaz.</div>
        </div>
        <div id="gorev-kisitlama-liste" class="mt-3"></div>
      </div>

      <div class="flex justify-between items-center mt-3">
        <h4 style="margin:0;">ğŸ—“ï¸ Mazeret Takvimi</h4>
        <div class="flex gap-1">
          <button class="btn btn-sm btn-success" onclick="document.getElementById('mazeret-excel').click()" 
            title="Excel FormatÄ±:&#10;â€¢ 1. sÃ¼tun: Ad Soyad&#10;â€¢ 2-32. sÃ¼tunlar: 1-31. gÃ¼nler&#10;&#10;HÃ¼cre DeÄŸerleri:&#10;â€¢ MZ veya M = Mazeret&#10;â€¢ YÄ° veya Y = YÄ±llÄ±k Ä°zin&#10;â€¢ NÄ° veya NÃ–BET Ä°ZNÄ° = NÃ¶bet Ä°zni&#10;â€¢ 08:00-08:00 = NÃ¶bet (gÃ¶rev seÃ§imi sorulur)&#10;&#10;Renk:&#10;â€¢ SarÄ± arka plan (#FFC000) = Mazeret&#10;â€¢ BoÅŸ hÃ¼cre = MÃ¼sait">
            <i class="fas fa-file-excel"></i> Mazeret Excel YÃ¼kle
          </button>
          <input type="file" id="mazeret-excel" hidden accept=".xlsx,.xls" onchange="mazeretExcelYukle(this)">
        </div>
      </div>
      <div class="help mb-3" style="background:#f0fdf4; padding:10px; border-radius:8px; border:1px solid #bbf7d0;">
        <strong>ğŸ“‹ Excel FormatÄ±:</strong> 1. sÃ¼tun Ad Soyad, 2-32. sÃ¼tunlar gÃ¼nler (1-31)<br>
        <strong>DeÄŸerler:</strong> MZ=Mazeret, YÄ°=YÄ±llÄ±k Ä°zin, NÄ°=NÃ¶bet Ä°zni, 08:00-08:00=NÃ¶bet<br>
        <strong>Renk:</strong> SarÄ± arka plan (#FFC000) â†’ Mazeret olarak algÄ±lanÄ±r
      </div>
      
      <div class="flex gap-2 flex-wrap items-center mb-3">
        <button class="btn btn-sm" style="background:#ef4444; color:#fff;" onclick="mazeretUygula('yillik')">
          <i class="fa-solid fa-plane"></i> YÄ±llÄ±k Ä°zin
        </button>
        <button class="btn btn-sm" style="background:#fbbf24; color:#000;" onclick="mazeretUygula('mazeret')">
          <i class="fa-solid fa-exclamation"></i> Mazeret
        </button>
        <button class="btn btn-sm" style="background:#f97316; color:#fff;" onclick="mazeretUygula('nobetizni')">
          <i class="fa-solid fa-bed"></i> NÃ¶bet Ä°zni
        </button>
        <button class="btn btn-sm btn-secondary" onclick="mazeretUygula('temizle')">
          <i class="fa-solid fa-eraser"></i> Temizle
        </button>
      </div>
      <div id="mazeret-grid" class="cal-grid"></div>
    </div>

    <!-- STEP 5: Hedefler -->
    <div class="step-content" id="step-5">
      <div class="flex justify-between items-center flex-wrap gap-2">
        <div>
          <h2 style="margin:0;">ğŸ¯ Hedef Belirleme</h2>
          <div class="help">Otomatik hesaplanan hedefleri dÃ¼zenleyebilirsiniz. HÃ¼crelere tÄ±klayarak deÄŸiÅŸtirin.</div>
        </div>
        <div class="flex gap-1">
          <button class="btn btn-primary btn-sm" onclick="hedefleriHesapla()">
            <i class="fa-solid fa-calculator"></i> Yeniden Hesapla
          </button>
          <button class="btn btn-warning btn-sm" onclick="verileriSifirla()" title="TÃ¼m hesaplamalarÄ± ve cache'i temizle">
            <i class="fa-solid fa-trash-can"></i> SÄ±fÄ±rla
          </button>
        </div>
      </div>

      <!-- Ã–zet Bilgi -->
      <div id="hedef-ozet" class="flex gap-2 flex-wrap mt-3"></div>

      <!-- UyarÄ±lar -->
      <div id="hedef-uyarilar" class="mt-3"></div>

      <!-- Hedef Tablosu -->
      <div class="table-responsive mt-3">
        <table class="custom-table" id="hedef-table">
          <thead>
            <tr>
              <th rowspan="2">Personel</th>
              <th colspan="5">GÃœN TÄ°PÄ° HEDEFLERÄ°</th>
              <th rowspan="2">Toplam</th>
              <th rowspan="2">Saat</th>
              <th id="ozel-gorev-header" colspan="0"></th>
              <th rowspan="2">Durum</th>
            </tr>
            <tr>
              <th title="8 saat">H.Ä°Ã§i</th>
              <th title="8 saat">PrÅŸ</th>
              <th title="16 saat">Cum</th>
              <th title="24 saat">Cmt</th>
              <th title="16 saat">Pzr</th>
            </tr>
          </thead>
          <tbody id="hedef-tbody"></tbody>
          <tfoot id="hedef-tfoot"></tfoot>
        </table>
      </div>

      <!-- Ã–zel GÃ¶rev AtamasÄ± -->
      <div id="ozel-gorev-section" class="rule-box mt-3" style="display:none;">
        <div class="flex justify-between items-center mb-3">
          <div>
            <h4 style="margin:0;">ğŸ–ï¸ Ã–zel GÃ¶rev KotalarÄ± (Bu Ay)</h4>
            <div class="help">Kapasite ve gÃ¼n tipi daÄŸÄ±lÄ±mÄ±nÄ± ayarlayabilirsiniz</div>
          </div>
          <button class="btn btn-primary btn-sm" onclick="ozelGorevKotalariniYenidenDagit()">
            <i class="fa-solid fa-sync"></i> KotalarÄ± Yeniden DaÄŸÄ±t
          </button>
        </div>
        
        <!-- GÃ¶rev Kapasite AyarlarÄ± -->
        <div id="gorev-kapasite-ayar" class="mb-3"></div>
        
        <!-- Personel KotalarÄ± -->
        <div class="table-responsive">
          <table class="custom-table" id="ozel-gorev-table">
            <thead id="ozel-gorev-thead"></thead>
            <tbody id="ozel-gorev-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- STEP 6: Ã–nizleme -->
    <div class="step-content" id="step-6">
      <div class="flex justify-between items-center flex-wrap gap-2">
        <div>
          <h2 style="margin:0;">ğŸ“‹ NÃ¶bet Listesi Ã–nizleme</h2>
          <div class="help">OluÅŸturulan listeyi kontrol edin ve indirin</div>
        </div>
        <div class="flex gap-1">
          <button class="btn btn-primary" onclick="listeOlustur()">
            <i class="fa-solid fa-sync"></i> Listeyi OluÅŸtur
          </button>
          <button class="btn btn-warning" onclick="verileriSifirla()" title="TÃ¼m hesaplamalarÄ± ve cache'i temizle">
            <i class="fa-solid fa-trash-can"></i> SÄ±fÄ±rla
          </button>
          <button class="btn btn-success" onclick="listeyiIndir()">
            <i class="fa-solid fa-download"></i> Excel Ä°ndir
          </button>
        </div>
      </div>

      <!-- OR-Tools AyarÄ± -->
      <div class="rule-box mt-3" style="background:#eff6ff; border-left:4px solid #3b82f6;">
        <div class="card" style="background:linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color:white;">
          <div>
            <h4 style="margin:0;">ğŸ¤– OR-Tools Optimizasyon</h4>
            <div class="help" style="color:#93c5fd;">âœ… Aktif - Matematiksel optimizasyon ile en iyi daÄŸÄ±lÄ±m saÄŸlanÄ±r</div>
          </div>
          <span style="font-weight:700; color:#10b981;">âœ“ Aktif</span>
        </div>
      </div>

      <!-- Ä°statistikler -->
      <div class="form-grid mt-3">
        <div class="rule-box text-center">
          <div style="font-size:24px; font-weight:900; color:var(--primary);" id="stat-toplam">0</div>
          <div class="help">Toplam NÃ¶bet</div>
        </div>
        <div class="rule-box text-center">
          <div style="font-size:24px; font-weight:900; color:var(--success);" id="stat-doluluk">%0</div>
          <div class="help">Doluluk OranÄ±</div>
        </div>
        <div class="rule-box text-center">
          <div style="font-size:24px; font-weight:900; color:var(--warning);" id="stat-devir">0</div>
          <div class="help">Eksik Atama</div>
        </div>
      </div>

      <!-- Eksik Atama Listesi -->
      <div id="devir-listesi" class="rule-box mt-3" style="display:none; background:#fef3c7;">
        <h4>âš ï¸ Eksik Atamalar</h4>
        <div id="devir-icerik"></div>
      </div>

      <!-- Ã–nizleme Tablosu -->
      <div class="table-responsive mt-3">
        <table class="custom-table preview-table" id="preview-table">
          <thead id="preview-thead"></thead>
          <tbody id="preview-tbody"></tbody>
        </table>
      </div>

      <!-- KiÅŸi BazlÄ± Ã–zet -->
      <div class="mt-3">
        <h4>ğŸ‘¤ KiÅŸi BazlÄ± Ã–zet</h4>
        <div class="table-responsive">
          <table class="custom-table" id="kisi-ozet-table">
            <thead>
              <tr>
                <th>Personel</th>
                <th>H.Ä°Ã§i</th>
                <th>PrÅŸ</th>
                <th>Cum</th>
                <th>Cmt</th>
                <th>Pzr</th>
                <th>Toplam</th>
                <th>Saat</th>
                <th>Durum</th>
              </tr>
            </thead>
            <tbody id="kisi-ozet-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="footer">
      <button class="btn btn-secondary" id="btn-geri" onclick="stepDegistir(-1)">
        <i class="fa-solid fa-arrow-left"></i> Geri
      </button>
      <button class="btn btn-primary" id="btn-ileri" onclick="stepDegistir(1)">
        Ä°leri <i class="fa-solid fa-arrow-right"></i>
      </button>
    </div>
  </div>

  <!-- GeÃ§miÅŸ Detay Modal -->
  <div class="modal" id="gecmis-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 style="margin:0;">ğŸ“… YÄ±llÄ±k GeÃ§miÅŸ DetaylarÄ±</h3>
        <button class="btn btn-secondary btn-sm" onclick="gecmisModalKapat()">
          <i class="fa-solid fa-times"></i> Kapat
        </button>
      </div>
      <div class="modal-body">
        <div class="flex gap-2 items-center mb-3">
          <label style="font-weight:800;">Personel:</label>
          <select id="gecmis-personel" onchange="gecmisTabloGuncelle()" style="padding:8px; border:2px solid #e2e8f0; border-radius:8px; min-width:200px;"></select>
          <label style="font-weight:800; margin-left:15px;">YÄ±l:</label>
          <select id="gecmis-yil" onchange="gecmisTabloGuncelle()" style="padding:8px; border:2px solid #e2e8f0; border-radius:8px;"></select>
        </div>
        <div class="table-responsive">
          <table class="custom-table" id="gecmis-table">
            <thead id="gecmis-thead"></thead>
            <tbody id="gecmis-tbody"></tbody>
            <tfoot id="gecmis-tfoot"></tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
// ============================================
// GLOBAL STATE
// ============================================
let currentStep = 1;
let personelListesi = [];
let resmiTatiller = [];
let kurallar = [];
let gorevler = [];
let manuelAtamalar = []; // { personelId, gun, gorevId, gorevIdx, gorevAdi }
let gorevKisitlamalari = []; // { personelId, gorevAdi } - kiÅŸi sadece bu gÃ¶reve atanÄ±r
let gorevKapasiteAyar = {}; // { gorevAdi: { toplam: X, hici: X, prs: X, cum: X, cmt: X, pzr: X } }
let kisitlamaExclusive = false; // true = kÄ±sÄ±tlamalÄ± kiÅŸiler kendi aralarÄ±nda dÃ¶ner
let selectedCells = [];
let isMouseDown = false;
let hesaplananListe = null;
let atananlar = {}; // Step 6 Ã¶nizleme iÃ§in (hesaplananListe.atanan ile senkron)
let devirListesi = [];
let personelIdCounter = 0;

// Saat deÄŸerleri
const SAAT_DEGER = { hici: 8, prs: 8, cum: 16, cmt: 24, pzr: 16 };
const GUN_TIPI_LABEL = { hici: 'H.Ä°Ã§i', prs: 'PrÅŸ', cum: 'Cum', cmt: 'Cmt', pzr: 'Pzr' };
const GUN_TIPLERI = ['hici', 'prs', 'cum', 'cmt', 'pzr'];
const AY_ISIMLERI = ['', 'Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];

// WE/WD AYRIMI: Cuma artÄ±k Hafta Sonu (WE) kategorisinde
const WE_TIPLERI = ['cum', 'cmt', 'pzr'];  // Hafta Sonu = Cuma + Cumartesi + Pazar
const WD_TIPLERI = ['hici', 'prs'];        // Hafta Ä°Ã§i = Pazartesi-PerÅŸembe

// GÃ¼n tipi alternatifleri - aynÄ± zorluk seviyesindeki gÃ¼nler
const GUN_TIPI_ALTERNATIFLERI = {
  hici: ['prs'],      // H.Ä°Ã§i (8s) <-> PrÅŸ (8s)
  prs: ['hici'],      // PrÅŸ (8s) <-> H.Ä°Ã§i (8s)
  cum: ['pzr', 'cmt'], // Cum (16s) -> Pzr (16s) -> Cmt (24s)
  pzr: ['cum', 'cmt'], // Pzr (16s) -> Cum (16s) -> Cmt (24s)
  cmt: ['pzr', 'cum']  // Cmt (24s) -> Pzr (16s) -> Cum (16s)
};

// WE/WD yardÄ±mcÄ± fonksiyonlarÄ±
function isWEGun(tip) { return WE_TIPLERI.includes(tip); }
function isWDGun(tip) { return WD_TIPLERI.includes(tip); }

// BUG FIX (D): XSS korumasÄ± iÃ§in HTML escape fonksiyonu
function escapeHtml(text) {
  if (text === null || text === undefined) return '';
  const str = String(text);
  const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
  return str.replace(/[&<>"']/g, m => map[m]);
}

function yeniPersonelId() {
  let aday = 0;
  do {
    personelIdCounter = (personelIdCounter + 1) % 1000;
    aday = Date.now() * 1000 + personelIdCounter;
  } while (personelListesi.some(p => String(p.id) === String(aday)));
  return aday;
}

// Firebase
let auth = null;
try { auth = firebase.auth(); } catch(e) { console.warn('Firebase unavailable'); }

// ============================================
// AUTH
// ============================================
if (auth) {
  auth.onAuthStateChanged(user => {
    if (user) {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('main-app').style.display = 'block';
      document.getElementById('user-name').textContent = user.isAnonymous ? 'Misafir' : (user.displayName || 'KullanÄ±cÄ±');
      yukle();
    } else {
      document.getElementById('login-screen').style.display = 'flex';
      document.getElementById('main-app').style.display = 'none';
    }
  });
} else {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('main-app').style.display = 'block';
  yukle();
}

function girisYap() {
  if (!auth) return alert('Firebase yÃ¼klenemedi');
  auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
}

function misafirGiris() {
  if (!auth) return alert('Firebase yÃ¼klenemedi');
  auth.signInAnonymously();
}

function cikisYap() {
  if (auth) auth.signOut();
  location.reload();
}

// ============================================
// NAVIGATION
// ============================================
function goStep(s) {
  if (s < 1 || s > 6) return;
  
  // Validasyonlar
  if (currentStep === 1 && s > 1) {
    const gunluk = parseInt(document.getElementById('inp-gunluk').value) || 0;
    if (gunluk <= 0) return alert('GÃ¼nlÃ¼k nÃ¶betÃ§i sayÄ±sÄ± giriniz!');
  }
  
  document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
  
  currentStep = s;
  document.getElementById(`step-${s}`).classList.add('active');
  document.getElementById(`step-ind-${s}`).classList.add('active');
  
  // Step'e gÃ¶re render
  if (s === 2) gorevleriGuncelle();
  if (s === 3) { personelTablosuGuncelle(); ozetTablosuGuncelle(); }
  if (s === 4) { selectleriGuncelle(); mazeretGridOlustur(); }
  if (s === 5) hedefleriHesapla();
  // Step 6: Sadece Ã¶nizleme tablosunu gÃ¼ncelle, listeyi otomatik oluÅŸturma
  if (s === 6) {
    // EÄŸer daha Ã¶nce liste oluÅŸturulmuÅŸsa sadece tabloyu gÃ¼ncelle
    if (hesaplananListe?.atanan && Object.keys(hesaplananListe.atanan).length > 0) {
      atananlar = hesaplananListe.atanan;
      onizlemeGuncelle();
    }
    // Aksi halde kullanÄ±cÄ± "Listeyi OluÅŸtur" butonuna tÄ±klamalÄ±
  }
  
  // Buton gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼
  document.getElementById('btn-geri').style.display = s === 1 ? 'none' : 'flex';
  document.getElementById('btn-ileri').style.display = s === 6 ? 'none' : 'flex';
  
  kaydet();
}

function stepDegistir(dir) {
  goStep(currentStep + dir);
}

// ============================================
// HELPERS
// ============================================
function getYilAy() {
  return {
    yil: parseInt(document.getElementById('inp-yil').value) || new Date().getFullYear(),
    ay: parseInt(document.getElementById('inp-ay').value) || (new Date().getMonth() + 1)
  };
}

function getGunSayisi(yil, ay) {
  return new Date(yil, ay, 0).getDate();
}

function getGunTipi(yil, ay, gun) {
  const tatil = resmiTatiller.find(t => t.gun === gun);
  if (tatil) return tatil.tip;
  
  const tarih = new Date(yil, ay - 1, gun);
  const dow = tarih.getDay();
  if (dow === 0) return 'pzr';
  if (dow === 6) return 'cmt';
  if (dow === 5) return 'cum';
  if (dow === 4) return 'prs';
  return 'hici';
}

function getSaatDeger(tip) {
  return parseInt(document.getElementById(`saat-${tip}`)?.value) || SAAT_DEGER[tip];
}

function debounce(fn, wait = 500) {
  let t = null;
  return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
}

const kaydetDebounced = debounce(() => kaydet(), 500);

// ============================================
// VERÄ°LERÄ° SIFIRLA - Cache ve hesaplamalarÄ± temizle
// ============================================
function verileriSifirla() {
  if (!confirm('TÃ¼m hesaplamalar ve hedefler sÄ±fÄ±rlanacak. Personel, gÃ¶rev ve mazeret verileri korunacak. Devam etmek istiyor musunuz?')) {
    return;
  }
  
  console.log('ğŸ”„ Veriler sÄ±fÄ±rlanÄ±yor...');
  
  // Hesaplanan listeyi temizle
  hesaplananListe = null;
  atananlar = {};
  
  // Personel hedeflerini sÄ±fÄ±rla
  personelListesi.forEach(p => {
    p.hedef = { hici: 0, prs: 0, cum: 0, cmt: 0, pzr: 0 };
    p.gorevKotalari = {};
    p.manuelAtamaSayisi = 0;
  });
  
  // Ã–zel gÃ¶rev kapasite ayarlarÄ±nÄ± temizle
  gorevKapasiteAyar = {};
  
  // Devir listesini temizle
  devirListesi = [];
  
  // UI'larÄ± gÃ¼ncelle
  hedefTablosuGuncelle();
  ozelGorevSectionGuncelle();
  
  // Step 6 tablosunu temizle
  const tbody = document.querySelector('#liste-table tbody');
  if (tbody) tbody.innerHTML = '';
  
  // Ä°statistikleri sÄ±fÄ±rla
  document.getElementById('stat-toplam').textContent = '0';
  document.getElementById('stat-doluluk').textContent = '%0';
  document.getElementById('stat-devir').textContent = '0';
  
  // Kaydet
  kaydetDebounced();
  
  alert('âœ… Veriler sÄ±fÄ±rlandÄ±. "Yeniden Hesapla" veya "Listeyi OluÅŸtur" butonuna tÄ±klayarak yeniden hesaplayabilirsiniz.');
  console.log('âœ… SÄ±fÄ±rlama tamamlandÄ±');
}

// ============================================
// STEP 1: TATÄ°LLER
// ============================================
function tatilEkle() {
  const gun = parseInt(document.getElementById('rt-gun').value);
  const tip = document.getElementById('rt-tip').value;
  if (!gun || gun < 1 || gun > 31) return alert('GeÃ§erli bir gÃ¼n giriniz');
  
  if (!resmiTatiller.find(t => t.gun === gun)) {
    resmiTatiller.push({ gun, tip });
    tatilListesiGuncelle();
    kaydetDebounced();
  }
  document.getElementById('rt-gun').value = '';
}

function tatilSil(gun) {
  resmiTatiller = resmiTatiller.filter(t => t.gun !== gun);
  tatilListesiGuncelle();
  kaydetDebounced();
}

function tatilListesiGuncelle() {
  const container = document.getElementById('tatil-liste');
  if (resmiTatiller.length === 0) {
    container.innerHTML = '<span class="help">Tatil eklenmedi</span>';
    return;
  }
  
  const tipLabel = { cum: 'Cuma (16s)', cmt: 'Cmt (24s)', pzr: 'Pazar (16s)' };
  const tipClass = { cum: 'badge-warn', cmt: 'badge-bad', pzr: 'badge-info' };
  
  container.innerHTML = resmiTatiller
    .sort((a, b) => a.gun - b.gun)
    .map(t => `<span class="badge ${tipClass[t.tip] || 'badge-warn'}" style="margin:2px; cursor:pointer;" onclick="tatilSil(${t.gun})">${t.gun}. gÃ¼n â†’ ${tipLabel[t.tip] || t.tip} âœ•</span>`)
    .join('');
}

// ============================================
// STEP 2: GÃ–REVLER
// ============================================
function gorevleriGuncelle() {
  const container = document.getElementById('gorev-listesi');
  const detayli = true; // Her zaman detaylÄ± mod etkin
  const gunluk = parseInt(document.getElementById('inp-gunluk').value) || 5;
  
  container.innerHTML = '';
  
  // BUG FIX (C): Mevcut gÃ¶revleri kopyala, sonra sÄ±fÄ±rla
  const eskiGorevler = [...gorevler];
  gorevler = [];
  
  for (let i = 1; i <= gunluk; i++) {
    const mevcut = eskiGorevler[i - 1] || {};
    const varsayilanAd = `NÃ¶bet Yeri ${i}`;
    const gorevAdi = mevcut.ad || varsayilanAd;
    
    // BUG FIX (H): GÃ¶rev tipini explicit olarak belirle
    // "NÃ¶bet Yeri" veya "NÃ¶betÃ§i" ile baÅŸlayanlar normal, diÄŸerleri Ã¶zel
    const isOzel = !gorevAdi.startsWith('NÃ¶bet Yeri') && !gorevAdi.startsWith('NÃ¶betÃ§i');
    
    if (detayli) {
      const div = document.createElement('div');
      div.className = 'rule-box';
      div.innerHTML = `
        <div class="input-group">
          <label>${i}. GÃ¶rev AdÄ±</label>
          <input type="text" class="gorev-adi" data-idx="${i-1}" value="${escapeHtml(gorevAdi)}" onchange="gorevDegisti()">
        </div>
        <div class="input-group mt-3">
          <label>
            <input type="checkbox" class="gorev-ozel" data-idx="${i-1}" ${mevcut.ozel || isOzel ? 'checked' : ''} onchange="gorevDegisti()">
            Ã–zel GÃ¶rev (kota gerektirir)
          </label>
        </div>
      `;
      container.appendChild(div);
    }
    
    gorevler.push({
      id: mevcut.id || i,
      ad: gorevAdi,
      ozel: mevcut.ozel !== undefined ? mevcut.ozel : isOzel
    });
  }
  
  kaydetDebounced();
}

function gorevDegisti() {
  document.querySelectorAll('.gorev-adi').forEach(inp => {
    const idx = parseInt(inp.dataset.idx);
    if (gorevler[idx]) {
      gorevler[idx].ad = inp.value || `NÃ¶bet Yeri ${idx + 1}`;
      // Ad deÄŸiÅŸince ozel durumunu gÃ¼ncelle (checkbox yoksa)
      const checkbox = document.querySelector(`.gorev-ozel[data-idx="${idx}"]`);
      if (!checkbox) {
        const ad = gorevler[idx].ad;
        gorevler[idx].ozel = !ad.startsWith('NÃ¶bet Yeri') && !ad.startsWith('NÃ¶betÃ§i');
      }
    }
  });
  // Ã–zel gÃ¶rev checkbox'Ä±nÄ± oku
  document.querySelectorAll('.gorev-ozel').forEach(inp => {
    const idx = parseInt(inp.dataset.idx);
    if (gorevler[idx]) gorevler[idx].ozel = inp.checked;
  });
  kaydetDebounced();
}

// BUG FIX (H): Ã–zel gÃ¶rev tespiti artÄ±k explicit 'ozel' alanÄ±nÄ± kullanÄ±yor
function getOzelGorevler() {
  // Benzersiz Ã¶zel gÃ¶rev isimleri (baseName varsa onu kullan - solver base_name ile Ã§alÄ±ÅŸÄ±yor)
  const ozeller = gorevler
    .filter(g => g.ozel === true || (!g.ozel && !g.ad.startsWith('NÃ¶bet Yeri') && !g.ad.startsWith('NÃ¶betÃ§i')))
    .map(g => g.baseName || g.ad);
  return [...new Set(ozeller)]; // Duplicate'leri kaldÄ±r
}

function getBenzersizGorevler() {
  return [...new Set(gorevler.map(g => g.ad))];
}

// Bir gÃ¶rev adÄ±nÄ±n kaÃ§ sÃ¼tunda olduÄŸunu hesapla
function gorevSutunSayisi(gorevAdi) {
  return gorevler.filter(g => g.ad === gorevAdi).length;
}
</script>

<script>
// ============================================
// STEP 3: PERSONEL
// ============================================
function personelEkle(ad = '', gecmis = null) {
  personelListesi.push({
    id: yeniPersonelId(),
    ad: ad,
    // YÄ±llÄ±k geÃ§miÅŸ: { 2024: { 1: {hici:0, prs:0, ...}, 2: {...}, ... }, 2025: {...} }
    yillikGecmis: gecmis || {},
    // Bu ay iÃ§in
    mazeretler: [],
    yillikIzinler: [],
    nobetIzinleri: [],
    sabitler: [],
    // Hedefler (Step 5'te hesaplanÄ±r)
    hedef: { hici: 0, prs: 0, cum: 0, cmt: 0, pzr: 0 },
    gorevKotalari: {},
    // Devir bilgisi
    devir: {}
  });
  personelTablosuGuncelle();
  ozetTablosuGuncelle();
  kaydetDebounced();
}

function personelSil(id) {
  personelListesi = personelListesi.filter(p => p.id !== id);
  personelTablosuGuncelle();
  ozetTablosuGuncelle();
  kaydetDebounced();
}

function personelTablosuGuncelle() {
  const thead = document.getElementById('personel-thead');
  const tbody = document.getElementById('personel-tbody');
  
  // Devir uyarÄ±sÄ±nÄ± kontrol et
  devirUyarisiGoster();
  
  thead.innerHTML = `
    <tr>
      <th style="width:40px;">No</th>
      <th style="min-width:150px;">Ad Soyad</th>
      <th style="width:100px;">YÄ±llÄ±k Ã–zet</th>
      <th style="width:60px;">Sil</th>
    </tr>
  `;
  
  tbody.innerHTML = '';
  
  personelListesi.forEach((p, idx) => {
    const yillikToplam = yillikToplamHesapla(p);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td><input type="text" class="inp-cell" value="${escapeHtml(p.ad)}" onchange="personelAdDegisti(${idx}, this.value)" style="text-align:left;"></td>
      <td><span class="badge badge-info">${yillikToplam.toplam} nÃ¶bet</span></td>
      <td><button class="btn btn-danger btn-sm" onclick="personelSil(${p.id})"><i class="fa-solid fa-trash"></i></button></td>
    `;
    tbody.appendChild(tr);
  });
}

function personelAdDegisti(idx, ad) {
  personelListesi[idx].ad = ad;
  kaydetDebounced();
}

function yillikToplamHesapla(personel) {
  const toplam = { hici: 0, prs: 0, cum: 0, cmt: 0, pzr: 0, toplam: 0, saat: 0 };
  const gecmis = personel.yillikGecmis || {};
  
  Object.values(gecmis).forEach(yilData => {
    Object.values(yilData).forEach(ayData => {
      GUN_TIPLERI.forEach(tip => {
        const val = ayData[tip] || 0;
        toplam[tip] += val;
        toplam.toplam += val;
        toplam.saat += val * getSaatDeger(tip);
      });
    });
  });
  
  return toplam;
}

function ozetTablosuGuncelle() {
  const thead = document.getElementById('ozet-thead');
  const tbody = document.getElementById('ozet-tbody');
  const ozelGorevler = getOzelGorevler();
  
  let headerHtml = `
    <tr>
      <th>Personel</th>
      <th>H.Ä°Ã§i</th>
      <th>PrÅŸ</th>
      <th>Cum</th>
      <th>Cmt</th>
      <th>Pzr</th>
      <th>Toplam</th>
      <th>Saat</th>
  `;
  ozelGorevler.forEach(g => {
    headerHtml += `<th style="background:#dbeafe; color:#1e40af; font-size:10px;">${g}</th>`;
  });
  headerHtml += '</tr>';
  thead.innerHTML = headerHtml;
  
  tbody.innerHTML = '';
  
  personelListesi.forEach(p => {
    const toplam = yillikToplamHesapla(p);
    const tr = document.createElement('tr');
    let html = `
      <td style="font-weight:700;">${p.ad || '(isimsiz)'}</td>
      <td>${toplam.hici}</td>
      <td>${toplam.prs}</td>
      <td>${toplam.cum}</td>
      <td>${toplam.cmt}</td>
      <td>${toplam.pzr}</td>
      <td><strong>${toplam.toplam}</strong></td>
      <td>${toplam.saat}s</td>
    `;
    ozelGorevler.forEach(g => {
      const gorevToplam = yillikGorevToplamHesapla(p, g);
      html += `<td style="background:#eff6ff;">${gorevToplam}</td>`;
    });
    tr.innerHTML = html;
    tbody.appendChild(tr);
  });
}

function yillikGorevToplamHesapla(personel, gorevAdi) {
  let toplam = 0;
  const gecmis = personel.yillikGecmis || {};
  
  Object.values(gecmis).forEach(yilData => {
    Object.values(yilData).forEach(ayData => {
      if (ayData.gorevler && ayData.gorevler[gorevAdi]) {
        toplam += ayData.gorevler[gorevAdi];
      }
    });
  });
  
  return toplam;
}

// Devir uyarÄ±sÄ± gÃ¶ster (Ã¶nceki aydan kalan eksikler)
function devirUyarisiGoster() {
  const uyariDiv = document.getElementById('devir-uyari');
  const detayDiv = document.getElementById('devir-detay');
  
  // YÄ±llÄ±k toplam analizi yap
  let enAz = Infinity;
  let enCok = 0;
  const yilliklar = [];
  
  personelListesi.forEach(p => {
    const yillik = yillikToplamHesapla(p);
    const toplam = GUN_TIPLERI.reduce((s, t) => s + yillik[t], 0);
    yilliklar.push({ ad: p.ad, toplam, yillik });
    if (toplam < enAz) enAz = toplam;
    if (toplam > enCok) enCok = toplam;
  });
  
  // EÄŸer yÄ±llÄ±k veri varsa gÃ¶ster
  if (yilliklar.length === 0 || enCok === 0) {
    uyariDiv.style.display = 'none';
    return;
  }
  
  // En az ve en Ã§ok tutanlarÄ± bul
  const azTutanlar = yilliklar.filter(y => y.toplam <= enAz + 5).slice(0, 5);
  const cokTutanlar = yilliklar.filter(y => y.toplam >= enCok - 5).slice(0, 5);
  
  uyariDiv.style.display = 'block';
  
  detayDiv.innerHTML = `
    <div style="margin-top:8px;">
      YÄ±llÄ±k nÃ¶bet daÄŸÄ±lÄ±mÄ± otomatik dengeleniyor. Az tutan kiÅŸilere Ã¶ncelik verilir.
    </div>
    <div style="margin-top:10px; display:flex; gap:20px; flex-wrap:wrap;">
      <div>
        <strong style="color:#16a34a;">ğŸ“‰ Az Tutanlar:</strong>
        ${azTutanlar.map(y => `<div style="font-size:11px;">${y.ad}: ${y.toplam} nÃ¶bet</div>`).join('')}
      </div>
      <div>
        <strong style="color:#dc2626;">ğŸ“ˆ Ã‡ok Tutanlar:</strong>
        ${cokTutanlar.map(y => `<div style="font-size:11px;">${y.ad}: ${y.toplam} nÃ¶bet</div>`).join('')}
      </div>
    </div>
  `;
}

// ============================================
// GEÃ‡MÄ°Å MODAL
// ============================================
function gecmisModalAc() {
  const modal = document.getElementById('gecmis-modal');
  modal.classList.add('active');
  
  // Personel select
  const personelSelect = document.getElementById('gecmis-personel');
  personelSelect.innerHTML = personelListesi.map(p => 
    `<option value="${p.id}">${p.ad || '(isimsiz)'}</option>`
  ).join('');
  
  // YÄ±l select
  const yilSelect = document.getElementById('gecmis-yil');
  const buYil = new Date().getFullYear();
  yilSelect.innerHTML = '';
  for (let y = buYil - 2; y <= buYil + 1; y++) {
    yilSelect.innerHTML += `<option value="${y}" ${y === buYil ? 'selected' : ''}>${y}</option>`;
  }
  
  gecmisTabloGuncelle();
}

function gecmisModalKapat() {
  document.getElementById('gecmis-modal').classList.remove('active');
}

function gecmisTabloGuncelle() {
  const personelId = document.getElementById('gecmis-personel').value;
  const yil = parseInt(document.getElementById('gecmis-yil').value);
  const personel = personelListesi.find(p => p.id == personelId);
  
  if (!personel) return;
  
  const ozelGorevler = getOzelGorevler();
  const thead = document.getElementById('gecmis-thead');
  const tbody = document.getElementById('gecmis-tbody');
  const tfoot = document.getElementById('gecmis-tfoot');
  
  // Header
  let headerHtml = '<tr><th>Ay</th><th>H.Ä°Ã§i</th><th>PrÅŸ</th><th>Cum</th><th>Cmt</th><th>Pzr</th><th>Toplam</th>';
  ozelGorevler.forEach(g => {
    headerHtml += `<th style="background:#dbeafe; color:#1e40af; font-size:10px;">${g}</th>`;
  });
  headerHtml += '</tr>';
  thead.innerHTML = headerHtml;
  
  // Body
  tbody.innerHTML = '';
  const yilToplam = { hici: 0, prs: 0, cum: 0, cmt: 0, pzr: 0, toplam: 0 };
  const gorevToplam = {};
  ozelGorevler.forEach(g => gorevToplam[g] = 0);
  
  for (let ay = 1; ay <= 12; ay++) {
    const ayData = personel.yillikGecmis?.[yil]?.[ay] || {};
    const tr = document.createElement('tr');
    
    let ayToplam = 0;
    GUN_TIPLERI.forEach(tip => {
      ayToplam += ayData[tip] || 0;
      yilToplam[tip] += ayData[tip] || 0;
    });
    yilToplam.toplam += ayToplam;
    
    let html = `<td style="font-weight:700;">${AY_ISIMLERI[ay]}</td>`;
    GUN_TIPLERI.forEach(tip => {
      html += `<td><input type="number" class="inp-cell" value="${ayData[tip] || 0}" min="0" 
        onblur="gecmisGuncelle(${personel.id}, ${yil}, ${ay}, '${tip}', this.value)"></td>`;
    });
    html += `<td><strong>${ayToplam}</strong></td>`;
    
    ozelGorevler.forEach(g => {
      const val = ayData.gorevler?.[g] || 0;
      gorevToplam[g] += val;
      html += `<td style="background:#eff6ff;"><input type="number" class="inp-cell" value="${val}" min="0" style="background:#eff6ff;"
        onblur="gecmisGorevGuncelle(${personel.id}, ${yil}, ${ay}, '${g}', this.value)"></td>`;
    });
    
    tr.innerHTML = html;
    tbody.appendChild(tr);
  }
  
  // Footer (Toplam)
  let footHtml = '<tr style="background:#f1f5f9; font-weight:700;"><td>TOPLAM</td>';
  GUN_TIPLERI.forEach(tip => {
    footHtml += `<td>${yilToplam[tip]}</td>`;
  });
  footHtml += `<td><strong>${yilToplam.toplam}</strong></td>`;
  ozelGorevler.forEach(g => {
    footHtml += `<td style="background:#dbeafe;">${gorevToplam[g]}</td>`;
  });
  footHtml += '</tr>';
  tfoot.innerHTML = footHtml;
}

function gecmisGuncelle(personelId, yil, ay, tip, deger) {
  const personel = personelListesi.find(p => p.id == personelId);
  if (!personel) return;
  
  if (!personel.yillikGecmis) personel.yillikGecmis = {};
  if (!personel.yillikGecmis[yil]) personel.yillikGecmis[yil] = {};
  if (!personel.yillikGecmis[yil][ay]) personel.yillikGecmis[yil][ay] = {};
  
  personel.yillikGecmis[yil][ay][tip] = parseInt(deger) || 0;
  ozetTablosuGuncelle();
  kaydetDebounced();
}

function gecmisGorevGuncelle(personelId, yil, ay, gorevAdi, deger) {
  const personel = personelListesi.find(p => p.id == personelId);
  if (!personel) return;
  
  if (!personel.yillikGecmis) personel.yillikGecmis = {};
  if (!personel.yillikGecmis[yil]) personel.yillikGecmis[yil] = {};
  if (!personel.yillikGecmis[yil][ay]) personel.yillikGecmis[yil][ay] = {};
  if (!personel.yillikGecmis[yil][ay].gorevler) personel.yillikGecmis[yil][ay].gorevler = {};
  
  personel.yillikGecmis[yil][ay].gorevler[gorevAdi] = parseInt(deger) || 0;
  ozetTablosuGuncelle();
  kaydetDebounced();
}

function excelYukle(input) {
  if (!input.files[0]) return;
  readXlsxFile(input.files[0]).then(rows => {
    rows.slice(1).forEach(r => {
      if (r[0]) personelEkle(String(r[0]));
    });
    input.value = '';
    alert('Liste yÃ¼klendi!');
  }).catch(e => {
    console.error(e);
    alert('Excel hatasÄ±: ' + e.message);
  });
}
</script>

<script>
// ============================================
// STEP 4: KISITLAR VE MAZERETLER
// ============================================
function selectleriGuncelle() {
  const selects = document.querySelectorAll('.p-select');
  const options = '<option value="">SeÃ§iniz...</option>' + 
    personelListesi.map(p => `<option value="${p.id}">${p.ad || '(isimsiz)'}</option>`).join('');
  selects.forEach(sel => sel.innerHTML = options);
  
  // Manuel gÃ¶rev select
  const gorevSelect = document.getElementById('manuel-gorev');
  if (gorevSelect) {
    gorevSelect.innerHTML = gorevler.map((g, idx) => 
      `<option value="${idx}">${g.ad}</option>`
    ).join('');
  }
  
  // KÄ±sÄ±tlama gÃ¶rev select (benzersiz gÃ¶revler)
  const kisitlamaGorevSelect = document.getElementById('kisitlama-gorev');
  if (kisitlamaGorevSelect) {
    const benzersizGorevler = getOzelGorevler();
    kisitlamaGorevSelect.innerHTML = '<option value="">GÃ¶rev seÃ§in...</option>' +
      benzersizGorevler.map(g => `<option value="${g}">${g}</option>`).join('');
  }
  
  // Manuel atama listesini gÃ¼ncelle
  manuelAtamaListesiGuncelle();
  gorevKisitlamaListesiGuncelle();
}

function kuralEkle(tur) {
  if (tur === 'ayri') {
    const p1 = document.getElementById('ayri-p1').value;
    const p2 = document.getElementById('ayri-p2').value;
    if (!p1 || !p2 || p1 === p2) return alert('Ä°ki farklÄ± personel seÃ§iniz');
    kurallar.push({ tur: 'ayri', p1, p2 });
  } else {
    const p1 = document.getElementById('birlikte-p1').value;
    const p2 = document.getElementById('birlikte-p2').value;
    const p3 = document.getElementById('birlikte-p3').value;
    const secilen = [p1, p2, p3].filter(v => v);
    if (secilen.length < 2) return alert('En az 2 kiÅŸi seÃ§iniz');
    kurallar.push({ tur: 'birlikte', kisiler: [...new Set(secilen)] });
  }
  kuralListesiGuncelle();
  kaydetDebounced();
}

function kuralSil(idx) {
  kurallar.splice(idx, 1);
  kuralListesiGuncelle();
  kaydetDebounced();
}

function kuralListesiGuncelle() {
  const ayriListe = document.getElementById('ayri-liste');
  const birlikteListe = document.getElementById('birlikte-liste');
  
  ayriListe.innerHTML = '';
  birlikteListe.innerHTML = '';
  
  kurallar.forEach((k, idx) => {
    const li = document.createElement('li');
    li.style.cssText = 'display:flex; align-items:center; gap:8px; margin-bottom:5px; background:#f8fafc; padding:5px 10px; border-radius:6px;';
    
    if (k.tur === 'ayri') {
      const n1 = personelListesi.find(p => p.id == k.p1)?.ad || '?';
      const n2 = personelListesi.find(p => p.id == k.p2)?.ad || '?';
      li.innerHTML = `<span style="flex:1;">ğŸš« ${n1} â†” ${n2}</span>
        <button class="btn btn-danger btn-sm" onclick="kuralSil(${idx})"><i class="fa-solid fa-trash"></i></button>`;
      ayriListe.appendChild(li);
    } else {
      const isimler = k.kisiler.map(id => personelListesi.find(p => p.id == id)?.ad || '?').join(' + ');
      li.innerHTML = `<span style="flex:1;">ğŸ¤ ${isimler}</span>
        <button class="btn btn-danger btn-sm" onclick="kuralSil(${idx})"><i class="fa-solid fa-trash"></i></button>`;
      birlikteListe.appendChild(li);
    }
  });
}

// ============================================
// MANUEL ATAMA
// ============================================
function manuelAtamaEkle() {
  const personelIdStr = document.getElementById('manuel-personel').value;
  const gun = parseInt(document.getElementById('manuel-gun').value);
  const gorevIdx = parseInt(document.getElementById('manuel-gorev').value);
  
  if (!personelIdStr) return alert('Personel seÃ§iniz!');
  if (!gun || gun < 1 || gun > 31) return alert('GeÃ§erli bir gÃ¼n giriniz!');
  if (isNaN(gorevIdx)) return alert('GÃ¶rev seÃ§iniz!');
  
  const { yil, ay } = getYilAy();
  const gunSayisi = getGunSayisi(yil, ay);
  if (gun > gunSayisi) return alert(`Bu ay ${gunSayisi} gÃ¼n!`);
  
  // Personeli bul (string veya number olabilir)
  const personel = personelListesi.find(p => String(p.id) === String(personelIdStr));
  if (!personel) return alert('Personel bulunamadÄ±!');
  
  const gorev = gorevler[gorevIdx];
  if (!gorev) return alert('GÃ¶rev bulunamadÄ±!');
  
  // BUG FIX (A): gorevIdx yerine gorevId kullan (sÄ±ralama deÄŸiÅŸse bile doÄŸru gÃ¶rev bulunur)
  // AynÄ± gÃ¼n + gÃ¶rev iÃ§in zaten atama var mÄ±?
  const mevcutAtama = manuelAtamalar.find(m => m.gun === gun && m.gorevId === gorev.id);
  if (mevcutAtama) {
    return alert('Bu gÃ¼n ve gÃ¶rev iÃ§in zaten bir atama var!');
  }
  
  manuelAtamalar.push({
    personelId: personel.id, // Orijinal ID'yi koru (string veya number)
    gun,
    gorevId: gorev.id,       // BUG FIX (A): GÃ¶rev ID'si (sÄ±ralamadan baÄŸÄ±msÄ±z)
    gorevIdx,                // Geriye uyumluluk iÃ§in koru
    gorevAdi: gorev.ad
  });
  
  // Input temizle
  document.getElementById('manuel-gun').value = '';
  
  manuelAtamaListesiGuncelle();
  kaydetDebounced();
}

function manuelAtamaSil(idx) {
  manuelAtamalar.splice(idx, 1);
  manuelAtamaListesiGuncelle();
  kaydetDebounced();
}

function manuelAtamaListesiGuncelle() {
  const container = document.getElementById('manuel-atama-liste');
  if (!container) return;
  
  if (manuelAtamalar.length === 0) {
    container.innerHTML = '<span class="help">Manuel atama yok</span>';
    return;
  }
  
  const { yil, ay } = getYilAy();
  
  container.innerHTML = manuelAtamalar.map((m, idx) => {
    const personel = personelListesi.find(p => String(p.id) === String(m.personelId));
    const tip = getGunTipi(yil, ay, m.gun);
    const tipLabel = GUN_TIPI_LABEL[tip] || tip;
    
    return `
      <span class="badge badge-info" style="margin:2px;">
        ğŸ“Œ ${personel?.ad || '?'} â†’ ${m.gun}. gÃ¼n (${tipLabel}) - ${m.gorevAdi}
        <button onclick="manuelAtamaSil(${idx})" style="background:none; border:none; cursor:pointer; margin-left:4px;">âœ•</button>
      </span>
    `;
  }).join('');
}

// ============================================
// GÃ–REV KISITLAMASI
// ============================================
function gorevKisitlamasiEkle() {
  const personelId = document.getElementById('kisitlama-personel').value;
  const gorevAdi = document.getElementById('kisitlama-gorev').value;
  
  if (!personelId) return alert('Personel seÃ§iniz!');
  if (!gorevAdi) return alert('GÃ¶rev seÃ§iniz!');
  
  // Zaten var mÄ±?
  const mevcut = gorevKisitlamalari.find(k => String(k.personelId) === String(personelId));
  if (mevcut) {
    return alert('Bu kiÅŸi iÃ§in zaten bir kÄ±sÄ±tlama var! Ã–nce silin.');
  }
  
  const personel = personelListesi.find(p => String(p.id) === String(personelId));
  
  gorevKisitlamalari.push({
    personelId: personel.id,
    gorevAdi: gorevAdi,
    exclusive: true  // VarsayÄ±lan: sadece kendi aralarÄ±nda dÃ¶nsÃ¼n
  });
  
  gorevKisitlamaListesiGuncelle();
  kaydetDebounced();
}

function gorevKisitlamaSil(idx) {
  gorevKisitlamalari.splice(idx, 1);
  gorevKisitlamaListesiGuncelle();
  kaydetDebounced();
}

function kisitlamaExclusiveDegisti() {
  kisitlamaExclusive = document.getElementById('kisitlama-exclusive').checked;
  gorevKisitlamaListesiGuncelle();
  kaydetDebounced();
}

// KiÅŸi bazlÄ± exclusive deÄŸiÅŸtirme
function kisitlamaExclusiveDegistir(idx, checked) {
  if (gorevKisitlamalari[idx]) {
    gorevKisitlamalari[idx].exclusive = checked;
    kaydetDebounced();
  }
}

function gorevKisitlamaListesiGuncelle() {
  const container = document.getElementById('gorev-kisitlama-liste');
  if (!container) return;
  
  if (gorevKisitlamalari.length === 0) {
    container.innerHTML = '<span class="help">KÄ±sÄ±tlama yok - tÃ¼m personel tÃ¼m gÃ¶revlere atanabilir</span>';
    return;
  }
  
  const { yil, ay } = getYilAy();
  const gunSayisi = getGunSayisi(yil, ay);
  
  container.innerHTML = gorevKisitlamalari.map((k, idx) => {
    const personel = personelListesi.find(p => String(p.id) === String(k.personelId));
    
    // KiÅŸinin mÃ¼sait gÃ¼n tiplerini hesapla
    const musaitGunler = { hici: 0, prs: 0, cum: 0, cmt: 0, pzr: 0 };
    for (let d = 1; d <= gunSayisi; d++) {
      const mazeretli = personel?.mazeretler?.includes(d) || 
                        personel?.yillikIzinler?.includes(d) || 
                        personel?.nobetIzinleri?.includes(d);
      if (!mazeretli) {
        const tip = getGunTipi(yil, ay, d);
        musaitGunler[tip]++;
      }
    }
    
    // KiÅŸinin hedeflerini al
    const hedefler = personel?.hedef || { hici: 0, prs: 0, cum: 0, cmt: 0, pzr: 0 };
    const toplamHedef = GUN_TIPLERI.reduce((s, t) => s + (hedefler[t] || 0), 0);
    
    // Bilgi metni oluÅŸtur - gÃ¼n tipi bazÄ±nda
    const bilgiParcalari = [];
    GUN_TIPLERI.forEach(t => {
      if (hedefler[t] > 0) {
        bilgiParcalari.push(`${hedefler[t]}x ${GUN_TIPI_LABEL[t]}`);
      }
    });
    const bilgi = bilgiParcalari.length > 0 ? bilgiParcalari.join(' + ') : 'Hedef yok';
    
    const isExclusive = k.exclusive !== false; // VarsayÄ±lan true
    
    return `
      <div style="background:#f5f3ff; border:1px solid #c4b5fd; border-radius:8px; padding:10px; margin-bottom:8px;">
        <div class="flex justify-between items-center">
          <div>
            <strong style="color:#7c3aed;">${personel?.ad || '?'}</strong>
            <span style="color:#6b7280;"> â†’ sadece </span>
            <strong style="color:#7c3aed;">${k.gorevAdi}</strong>
            <span class="badge badge-info" style="margin-left:8px;">${toplamHedef} nÃ¶bet</span>
          </div>
          <button class="btn btn-danger btn-sm" onclick="gorevKisitlamaSil(${idx})"><i class="fa-solid fa-trash"></i></button>
        </div>
        <div style="margin-top:8px; display:flex; align-items:center; gap:8px;">
          <label style="display:flex; align-items:center; gap:6px; cursor:pointer; color:#5b21b6;">
            <input type="checkbox" ${isExclusive ? 'checked' : ''} 
                   onchange="kisitlamaExclusiveDegistir(${idx}, this.checked)"
                   style="width:16px; height:16px; accent-color:#7c3aed;">
            <span style="font-size:13px;">ğŸ”’ Sadece kendi aralarÄ±nda dÃ¶nsÃ¼n</span>
          </label>
        </div>
        <div class="help" style="margin-top:6px; color:#6d28d9;">
          ğŸ“Š ${k.gorevAdi} gÃ¶revine atanacak: ${bilgi}
        </div>
      </div>
    `;
  }).join('');
}

// ============================================
// MAZERET EXCEL YÃœKLEME
// ============================================
function mazeretExcelYukle(input) {
  if (!input.files[0]) return;
  
  const file = input.files[0];
  const reader = new FileReader();
  
  reader.onload = async function(e) {
    try {
      const { yil, ay } = getYilAy();
      const gunSayisi = getGunSayisi(yil, ay);
      
      const workbook = new ExcelJS.Workbook();
      await workbook.xlsx.load(e.target.result);
      const worksheet = workbook.worksheets[0];
      
      let yuklenen = 0;
      let nobetler = []; // 08:00-08:00 olan hÃ¼creler iÃ§in
      
      // SatÄ±rlarÄ± tara (2'den baÅŸla, 1 header)
      worksheet.eachRow((row, rowNumber) => {
        if (rowNumber === 1) return; // Header atla
        
        const adCell = row.getCell(1);
        const ad = adCell.value ? String(adCell.value).trim() : '';
        if (!ad) return;
        
        // âœ… YENÄ° EKLENEN FÄ°LTRE: Gereksiz satÄ±rlarÄ± atla
        const gecersizKelimeler = ['TOPLAM', 'GENEL', 'SAYI', 'SORUMLU', 'DEPO', 'UYANDIRMA', 'ÃœCRETSÄ°Z', 'RAPOR'];
        if (gecersizKelimeler.some(k => ad.toUpperCase().includes(k))) {
          return; // Bu satÄ±rÄ± iÅŸlemeyip pas geÃ§
        }
        
        const personel = personelListesi.find(p => 
          p.ad && p.ad.toLowerCase().trim() === ad.toLowerCase()
        );
        
        if (!personel) {
          console.warn(`Personel bulunamadÄ±: ${ad}`);
          return;
        }
        
        // SÃ¼tunlarÄ± tara (2'den baÅŸla, 1 ad sÃ¼tunu)
        for (let col = 2; col <= gunSayisi + 1; col++) {
          const cell = row.getCell(col);
          const gun = col - 1; // SÃ¼tun 2 = GÃ¼n 1
          
          if (gun > gunSayisi) break;
          
          // HÃ¼cre deÄŸeri
          let valStr = '';
          if (cell.value) {
            valStr = String(cell.value).toUpperCase().trim();
          }
          
          // HÃ¼cre arka plan rengi kontrol
          let bgColor = '';
          if (cell.fill && cell.fill.fgColor) {
            bgColor = cell.fill.fgColor.argb || '';
          }
          
          // Ã–nce temizle
          personel.mazeretler = (personel.mazeretler || []).filter(d => d !== gun);
          personel.yillikIzinler = (personel.yillikIzinler || []).filter(d => d !== gun);
          personel.nobetIzinleri = (personel.nobetIzinleri || []).filter(d => d !== gun);
          
          // DeÄŸerlendirme
          // SatÄ±r sonlarÄ±nÄ± ve fazla boÅŸluklarÄ± temizle
          valStr = valStr.replace(/[\r\n]+/g, ' ').replace(/\s+/g, ' ').trim();
          
          // 0. Atlanacak deÄŸerler: "Ä°ZÄ°N OTO" vb. (otomatik hesaplanan)
          if (valStr.includes('Ä°ZÄ°N OTO') || valStr.includes('IZIN OTO') || valStr === 'OTO') {
            continue; // Bu hÃ¼creyi atla
          }
          
          // 0.5. "Ä°ZÄ°N-RAPOR", "Ä°ZÄ°N- RAPOR", "RAPOR" â†’ YÄ±llÄ±k Ä°zin olarak ata
          if (valStr.includes('Ä°ZÄ°N-RAPOR') || valStr.includes('IZIN-RAPOR') || 
              valStr.includes('Ä°ZÄ°N- RAPOR') || valStr.includes('IZIN- RAPOR') ||
              valStr.includes('Ä°ZÄ°N RAPOR') || valStr.includes('IZIN RAPOR') ||
              valStr === 'RAPOR' || valStr.includes('-RAPOR') || valStr.includes('- RAPOR')) {
            personel.yillikIzinler.push(gun);
            yuklenen++;
            continue;
          }
          
          // 1. "NÃ–BET Ä°ZNÄ°" veya "NÄ°" yazÄ±yorsa â†’ NÃ¶bet Ä°zni
          // Excel'de satÄ±r sonu olabilir: "NÃ¶bet\nÄ°zni" â†’ "NÃ–BET Ä°ZNÄ°"
          if (valStr.includes('NÃ–BET Ä°ZNÄ°') || valStr.includes('NÃ–BETÄ°ZNÄ°') || valStr.includes('NOBET IZNI') || 
              valStr.includes('NÃ–BET Ä°ZÄ°N') || valStr.includes('NOBET IZIN') ||
              valStr === 'NÄ°' || valStr === 'NI' || 
              valStr === 'NÃ–BET' || valStr === 'NOBET' ||
              (valStr.includes('NÃ–BET') && valStr.includes('Ä°ZN')) ||
              (valStr.includes('NOBET') && valStr.includes('IZN'))) {
            personel.nobetIzinleri.push(gun);
            yuklenen++;
          }
          // 2. "08:00-08:00" veya benzeri saat formatÄ± â†’ NÃ¶bet (manuel atama iÃ§in listeye ekle)
          else if (valStr.match(/^\d{1,2}[:.]\d{2}\s*[-â€“]\s*\d{1,2}[:.]\d{2}$/)) {
            nobetler.push({ personel, gun, deger: valStr });
          }
          // 3. SarÄ± renk (#FFFC00, #FFC000, #FFFF00) â†’ Mazeret (ama belirli kelimeler iÃ§eriyorsa atla)
          else if (bgColor && (bgColor.includes('FFFC00') || bgColor.includes('FFC000') || bgColor.includes('FFFF00') || bgColor.includes('FC00'))) {
            // Ä°Ã§inde "Ä°ZÄ°N", "RAPOR" veya sadece sayÄ± varsa atla
            if (!valStr.includes('Ä°ZÄ°N') && !valStr.includes('IZIN') && !valStr.includes('RAPOR') && !valStr.match(/^\d+$/)) {
              personel.mazeretler.push(gun);
              yuklenen++;
            }
          }
          // 4. "MZ", "M", "MAZERET" yazÄ±yorsa â†’ Mazeret
          else if (valStr === 'MZ' || valStr === 'M' || valStr === 'MAZERET') {
            personel.mazeretler.push(gun);
            yuklenen++;
          }
          // 5. "YÄ°", "Y", "YILLIK" yazÄ±yorsa â†’ YÄ±llÄ±k Ä°zin
          else if (valStr === 'YÄ°' || valStr === 'YI' || valStr === 'Y' || valStr === 'YILLIK' || valStr.includes('YILLIK')) {
            personel.yillikIzinler.push(gun);
            yuklenen++;
          }
        }
      });
      
      input.value = '';
      mazeretGridOlustur();
      kaydetDebounced();
      
      // NÃ¶bet atamalarÄ± iÃ§in modal gÃ¶ster
      if (nobetler.length > 0) {
        nobetAtamaSor(nobetler, yuklenen);
      } else {
        alert(`${yuklenen} mazeret yÃ¼klendi!`);
      }
      
    } catch (err) {
      console.error(err);
      alert('Excel hatasÄ±: ' + err.message);
    }
  };
  
  reader.readAsArrayBuffer(file);
}

// NÃ¶bet atamasÄ± iÃ§in gÃ¶rev seÃ§imi
// BUG FIX (E): onclick'e JSON gÃ¶mme yerine closure kullan
let _pendingNobetler = null; // GeÃ§ici veri deposu

function nobetAtamaSor(nobetler, mazeretSayisi) {
  _pendingNobetler = nobetler; // Veriyi closure'da tut
  
  const gorevSecenekleri = gorevler.map((g, idx) => `<option value="${idx}">${escapeHtml(g.ad)}</option>`).join('');
  
  let html = `
    <div style="max-height:400px; overflow-y:auto;">
      <p><strong>${mazeretSayisi}</strong> mazeret yÃ¼klendi.</p>
      <p><strong>${nobetler.length}</strong> nÃ¶bet kaydÄ± bulundu. Her biri iÃ§in gÃ¶rev seÃ§in:</p>
      <table class="custom-table" style="font-size:12px;">
        <thead>
          <tr><th>Personel</th><th>GÃ¼n</th><th>DeÄŸer</th><th>GÃ¶rev</th></tr>
        </thead>
        <tbody>
  `;
  
  nobetler.forEach((n, idx) => {
    const tip = getGunTipi(getYilAy().yil, getYilAy().ay, n.gun);
    html += `
      <tr>
        <td>${escapeHtml(n.personel.ad)}</td>
        <td>${n.gun} (${GUN_TIPI_LABEL[tip]})</td>
        <td>${escapeHtml(n.deger)}</td>
        <td><select id="nobet-gorev-${idx}" style="padding:4px; border:1px solid #e2e8f0; border-radius:4px;">${gorevSecenekleri}</select></td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  // Modal gÃ¶ster
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.innerHTML = `
    <div class="modal-content" style="max-width:600px;">
      <div class="modal-header">
        <h3 style="margin:0;">ğŸ“Œ NÃ¶bet AtamalarÄ±</h3>
      </div>
      <div class="modal-body">${html}</div>
      <div style="padding:15px; border-top:1px solid #e2e8f0; display:flex; gap:10px; justify-content:flex-end;">
        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Ä°ptal</button>
        <button class="btn btn-primary" id="nobet-kaydet-btn">Kaydet</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  
  // Event listener ile baÄŸla (XSS gÃ¼venli)
  document.getElementById('nobet-kaydet-btn').addEventListener('click', function() {
    nobetAtamalariKaydetSafe(this);
  });
}

function nobetAtamalariKaydetSafe(btn) {
  const modal = btn.closest('.modal');
  const nobetler = _pendingNobetler;
  
  if (!nobetler) {
    modal.remove();
    return;
  }
  
  nobetler.forEach((n, idx) => {
    const gorevIdx = parseInt(document.getElementById(`nobet-gorev-${idx}`).value);
    const personel = personelListesi.find(p => String(p.id) === String(n.personel.id));
    const gorev = gorevler[gorevIdx];
    
    if (personel && !isNaN(gorevIdx) && gorev) {
      // BUG FIX (A): gorevId kullan
      const mevcutAtama = manuelAtamalar.find(m => m.gun === n.gun && m.gorevId === gorev.id);
      if (!mevcutAtama) {
        manuelAtamalar.push({
          personelId: personel.id,
          gun: n.gun,
          gorevId: gorev.id,
          gorevIdx: gorevIdx,
          gorevAdi: gorev.ad
        });
      }
    }
  });
  
  _pendingNobetler = null; // Temizle
  manuelAtamaListesiGuncelle();
  kaydetDebounced();
  modal.remove();
  alert(`${nobetler.length} nÃ¶bet atamasÄ± eklendi!`);
}

// Eski fonksiyon geriye uyumluluk iÃ§in (kullanÄ±lmÄ±yor artÄ±k)
function nobetAtamalariKaydet(nobetler, btn) {
  const modal = btn.closest('.modal');
  
  nobetler.forEach((n, idx) => {
    const gorevIdx = parseInt(document.getElementById(`nobet-gorev-${idx}`).value);
    const personel = personelListesi.find(p => String(p.id) === String(n.personel.id));
    const gorev = gorevler[gorevIdx];
    
    if (personel && !isNaN(gorevIdx) && gorev) {
      const mevcutAtama = manuelAtamalar.find(m => m.gun === n.gun && m.gorevId === gorev.id);
      if (!mevcutAtama) {
        manuelAtamalar.push({
          personelId: personel.id,
          gun: n.gun,
          gorevId: gorev.id,
          gorevIdx: gorevIdx,
          gorevAdi: gorev.ad
        });
      }
    }
  });
  
  manuelAtamaListesiGuncelle();
  kaydetDebounced();
  modal.remove();
  alert(`${nobetler.length} nÃ¶bet atamasÄ± eklendi!`);
}

// ============================================
// MAZERET GRÄ°D
// ============================================
function mazeretGridOlustur() {
  const { yil, ay } = getYilAy();
  const gunSayisi = getGunSayisi(yil, ay);
  const container = document.getElementById('mazeret-grid');
  
  // Grid template gÃ¼ncelle
  container.style.gridTemplateColumns = `180px repeat(${gunSayisi}, minmax(28px, 1fr))`;
  container.innerHTML = '';
  
  // Header
  const headerName = document.createElement('div');
  headerName.className = 'cal-cell cal-header cal-name';
  headerName.textContent = 'Personel';
  container.appendChild(headerName);
  
  for (let d = 1; d <= gunSayisi; d++) {
    const tip = getGunTipi(yil, ay, d);
    const cell = document.createElement('div');
    cell.className = 'cal-cell cal-header';
    if (tip === 'cmt' || tip === 'pzr') cell.classList.add('cal-weekend');
    if (resmiTatiller.find(t => t.gun === d)) cell.classList.add('cal-tatil');
    cell.textContent = d;
    container.appendChild(cell);
  }
  
  // Rows
  personelListesi.forEach(p => {
    const nameCell = document.createElement('div');
    nameCell.className = 'cal-cell cal-name';
    nameCell.textContent = p.ad || '(isimsiz)';
    container.appendChild(nameCell);
    
    for (let d = 1; d <= gunSayisi; d++) {
      const cell = document.createElement('div');
      cell.className = 'cal-cell';
      cell.dataset.pid = p.id;
      cell.dataset.gun = d;
      
      const tip = getGunTipi(yil, ay, d);
      if (tip === 'cmt' || tip === 'pzr') cell.classList.add('cal-weekend');
      if (resmiTatiller.find(t => t.gun === d)) cell.classList.add('cal-tatil');
      
      // Mevcut durumu gÃ¶ster
      if (p.yillikIzinler?.includes(d)) {
        cell.classList.add('cal-yillik');
        cell.textContent = 'YÄ°';
      } else if (p.mazeretler?.includes(d)) {
        cell.classList.add('cal-mazeret');
        cell.textContent = 'MZ';
      } else if (p.nobetIzinleri?.includes(d)) {
        cell.classList.add('cal-nobetizni');
        cell.textContent = 'NÄ°';
      } else if (p.sabitler?.includes(d)) {
        cell.classList.add('cal-sabit');
        cell.textContent = 'NB';
      }
      
      cell.addEventListener('mousedown', () => cellSec(p.id, d, true));
      cell.addEventListener('mouseenter', () => { if (isMouseDown) cellSec(p.id, d, false); });
      cell.addEventListener('mouseup', () => isMouseDown = false);
      
      container.appendChild(cell);
    }
  });
  
  document.body.onmouseup = () => isMouseDown = false;
}

function cellSec(pid, gun, start) {
  if (start) {
    isMouseDown = true;
    selectedCells = [];
  }
  
  const key = `${pid}-${gun}`;
  if (!selectedCells.find(c => c.pid === pid && c.gun === gun)) {
    selectedCells.push({ pid, gun });
    const cell = document.querySelector(`[data-pid="${pid}"][data-gun="${gun}"]`);
    if (cell) cell.classList.add('cal-selected');
  }
}

function mazeretUygula(tur) {
  if (selectedCells.length === 0) return alert('Ã–nce hÃ¼cre seÃ§iniz!');
  
  selectedCells.forEach(({ pid, gun }) => {
    const p = personelListesi.find(x => x.id == pid);
    if (!p) return;
    
    // Ã–nce tÃ¼m listelerden Ã§Ä±kar
    p.mazeretler = (p.mazeretler || []).filter(d => d !== gun);
    p.yillikIzinler = (p.yillikIzinler || []).filter(d => d !== gun);
    p.nobetIzinleri = (p.nobetIzinleri || []).filter(d => d !== gun);
    p.sabitler = (p.sabitler || []).filter(d => d !== gun);
    
    // Yeni durumu ekle
    if (tur === 'mazeret') p.mazeretler.push(gun);
    else if (tur === 'yillik') p.yillikIzinler.push(gun);
    else if (tur === 'nobetizni') p.nobetIzinleri.push(gun);
    else if (tur === 'sabit') p.sabitler.push(gun);
  });
  
  selectedCells = [];
  mazeretGridOlustur();
  kaydetDebounced();
}

// ============================================
// STEP 5: HEDEF HESAPLAMA
// ============================================

// KiÅŸinin hangi gÃ¼n tiplerinde mÃ¼sait olduÄŸunu ve kaÃ§ gÃ¼n mÃ¼sait olduÄŸunu hesapla
function kisiMusaitlikHesapla(personel, gunSayisi, yil, ay, araGun) {
  const musaitGunler = { hici: [], prs: [], cum: [], cmt: [], pzr: [] };
  
  for (let d = 1; d <= gunSayisi; d++) {
    const mazeretli = personel.mazeretler?.includes(d) || 
                      personel.yillikIzinler?.includes(d) || 
                      personel.nobetIzinleri?.includes(d);
    if (!mazeretli) {
      const tip = getGunTipi(yil, ay, d);
      musaitGunler[tip].push(d);
    }
  }
  
  // Ara gÃ¼n kuralÄ±nÄ± hesaba katarak maksimum nÃ¶bet sayÄ±sÄ±nÄ± simÃ¼le et
  // ZORLUK SIRASI: Cmt (24s) > Pzr = Cum (16s) > PrÅŸ = H.Ä°Ã§i (8s)
  const secilenGunler = [];
  const tipMax = { hici: 0, prs: 0, cum: 0, cmt: 0, pzr: 0 };
  const oncelikSirasi = ['cmt', 'pzr', 'cum', 'prs', 'hici']; // Zorluk sÄ±rasÄ±na gÃ¶re
  
  oncelikSirasi.forEach(tip => {
    musaitGunler[tip].sort((a, b) => a - b).forEach(gun => {
      const uygun = secilenGunler.every(secilen => Math.abs(secilen - gun) > araGun);
      if (uygun) {
        secilenGunler.push(gun);
        tipMax[tip]++;
      }
    });
  });
  
  return {
    musaitGunler: musaitGunler, // Ham mÃ¼sait gÃ¼nler listesi
    musaitGunSayisi: { 
      hici: musaitGunler.hici.length, 
      prs: musaitGunler.prs.length, 
      cum: musaitGunler.cum.length, 
      cmt: musaitGunler.cmt.length, 
      pzr: musaitGunler.pzr.length 
    },
    maxNobet: secilenGunler.length,
    tipMax: tipMax,
    secilenGunler: secilenGunler // Debug iÃ§in
  };
}

// Birlikte tutulacaklarÄ±n ORTAK mÃ¼sait gÃ¼nlerini hesapla
function ortakMusaitlikHesapla(kisiler, gunSayisi, yil, ay) {
  const ortakGunler = { hici: [], prs: [], cum: [], cmt: [], pzr: [] };
  
  for (let d = 1; d <= gunSayisi; d++) {
    // TÃ¼m kiÅŸiler bu gÃ¼nde mÃ¼sait mi?
    const hepsiMusait = kisiler.every(p => {
      const mazeretli = p.mazeretler?.includes(d) || 
                        p.yillikIzinler?.includes(d) || 
                        p.nobetIzinleri?.includes(d);
      return !mazeretli;
    });
    
    if (hepsiMusait) {
      const tip = getGunTipi(yil, ay, d);
      ortakGunler[tip].push(d);
    }
  }
  
  return {
    ortakGunler: ortakGunler,
    ortakGunSayisi: {
      hici: ortakGunler.hici.length,
      prs: ortakGunler.prs.length,
      cum: ortakGunler.cum.length,
      cmt: ortakGunler.cmt.length,
      pzr: ortakGunler.pzr.length
    },
    toplamOrtakGun: Object.values(ortakGunler).reduce((s, arr) => s + arr.length, 0)
  };
}

// OR-Tools ile hedef hesaplama (async)
async function hedefleriHesaplaOrtoolsAsync() {
  try {
    const result = await hedefHesaplaOrtools();
    
    if (result.basari && result.hedefler) {
      console.log('OR-Tools hedefler:', result.hedefler);
      if (result.istatistikler) {
        console.log('OR-Tools hedef istatistikler (JSON):', JSON.stringify(result.istatistikler));
      }
      
      // OR-Tools sonuÃ§larÄ±nÄ± personel hedeflerine uygula
      let eslesmeyen = 0;
      const eslestirilenIds = new Set(); // Duplicate ID kontrolÃ¼ iÃ§in
      result.hedefler.forEach(h => {
        // Ã–nce ID ile bul, duplicate varsa ad ile eÅŸleÅŸtir
        let p = null;
        const idMatches = personelListesi.filter(x => String(x.id) === String(h.id));
        if (idMatches.length === 1) {
          p = idMatches[0];
        } else if (idMatches.length > 1) {
          // Duplicate ID var - ad ile eÅŸleÅŸtir
          p = idMatches.find(x => x.ad === h.ad);
          if (!p) p = personelListesi.find(x => x.ad === h.ad);
          console.warn('Duplicate ID tespit edildi, ad ile eÅŸleÅŸtiriliyor:', h.id, h.ad);
        } else {
          // ID ile bulunamadÄ± - ad ile dene
          p = personelListesi.find(x => x.ad === h.ad);
        }
        
        if (!p) {
          console.warn('Personel bulunamadÄ±:', h.id, h.ad);
          eslesmeyen += 1;
          return;
        }
        
        // AynÄ± kiÅŸiye iki kez hedef yazÄ±lmasÄ±n
        if (eslestirilenIds.has(p.id + '_' + p.ad)) {
          console.warn('Bu kiÅŸiye zaten hedef yazÄ±ldÄ±:', p.ad);
          return;
        }
        eslestirilenIds.add(p.id + '_' + p.ad);
        
        // GÃ¼n tipi hedeflerini doÄŸrudan kullan (OR-Tools hesapladÄ±)
        // Backend formatÄ±: hedef_hici, hedef_prs, hedef_cum, hedef_cmt, hedef_pzr
        p.hedef = {
          hici: h.hedef_hici || 0,
          prs: h.hedef_prs || 0,
          cum: h.hedef_cum || 0,
          cmt: h.hedef_cmt || 0,
          pzr: h.hedef_pzr || 0
        };
        
        // WE/WD hedeflerini kaydet
        p.hedefWE = h.hedef_we || 0;
        p.hedefWD = h.hedef_wd || 0;
        
        // Birlikte gÃ¼nleri kaydet
        if (h.birlikte_gunler && h.birlikte_gunler.length > 0) {
          p.birlikteGunler = h.birlikte_gunler;
        }
        
        // GÃ¶rev kotalarÄ±nÄ± kaydet
        if (h.gorev_kotalari) {
          p.gorevKotalari = h.gorev_kotalari;
        }
      });
      
      // Birlikte atamalarÄ±nÄ± global'e kaydet
      if (result.birlikteAtamalar) {
        window.ortoolsBirlikteAtamalar = result.birlikteAtamalar;
        console.log('OR-Tools birlikte atamalar:', result.birlikteAtamalar);
      }
      
      // GÃ¶rev kotalarÄ±nÄ± global'e kaydet
      if (result.gorevKotalari) {
        window.ortoolsGorevKotalari = result.gorevKotalari;
        console.log('OR-Tools gÃ¶rev kotalarÄ±:', result.gorevKotalari);
      }
      
      // Tabloyu gÃ¼ncelle
      hedefTablosuGuncelle();
      ozelGorevSectionGuncelle();
      
      console.log('OR-Tools hedef hesaplama baÅŸarÄ±lÄ±:', result.istatistikler);
      if (eslesmeyen > 0) {
        console.warn('OR-Tools hedef eÅŸleÅŸmeyen personel sayÄ±sÄ±:', eslesmeyen);
      }
      return true;
    }
    return false;
  } catch (error) {
    console.error('OR-Tools hedef hesaplama hatasÄ±:', error);
    return false;
  }
}

let hedefHesaplamaAktif = false; // Ã‡oklu istek Ã¶nleme

async function hedefleriHesapla() {
  // Ã‡oklu istek Ã¶nleme
  if (hedefHesaplamaAktif) {
    console.log('Hedef hesaplama zaten Ã§alÄ±ÅŸÄ±yor, bekleniyor...');
    return;
  }
  
  try {
    hedefHesaplamaAktif = true;
    
    // Personel listesi boÅŸsa uyar
    if (!personelListesi || personelListesi.length === 0) {
      alert('Ã–nce personel ekleyin!');
      return;
    }
    
    // OR-Tools aktifse OR-Tools ile hesapla
    if (ortoolsAktif) {
      console.log('OR-Tools ile hedef hesaplanÄ±yor...');
      const basarili = await hedefleriHesaplaOrtoolsAsync();
      if (!basarili) {
        console.log('OR-Tools hedef hesaplama baÅŸarÄ±sÄ±z, yerel ile devam...');
        hedefleriHesaplaYerel();
      }
    } else {
      // Yerel algoritma
      hedefleriHesaplaYerel();
    }
  } catch (error) {
    console.error('Hedef hesaplama hatasÄ±:', error);
    alert('Hedef hesaplama sÄ±rasÄ±nda hata oluÅŸtu: ' + error.message);
  } finally {
    hedefHesaplamaAktif = false;
  }
}

function hedefleriHesaplaYerel() {
  try {
  const { yil, ay } = getYilAy();
  const gunSayisi = getGunSayisi(yil, ay);
  const gunluk = parseInt(document.getElementById('inp-gunluk').value) || 5;
  const araGun = (() => { const v = parseInt(document.getElementById('inp-aragun').value); return isNaN(v) ? 2 : v; })();
  const ozelGorevler = getOzelGorevler();
  
  // ============================================
  // YENÄ° YAKLAÅIM: Ã–NCE SÄ°MÃœLASYON YAP
  // Liste oluÅŸturur gibi ata, sonra hedefleri belirle
  // ============================================
  
  // SÄ±ralÄ± gÃ¶revler
  const siraliGorevler = [...gorevler]; // SÄ±ralama kaldÄ±rÄ±ldÄ± - slot kÄ±tlÄ±k aÄŸÄ±rlÄ±ÄŸÄ± OR-Tools'da
  
  // SimÃ¼lasyon iÃ§in geÃ§ici atama yapÄ±sÄ±
  const simAtanan = {}; // { gun: { slotIdx: personelId } }
  const simKisiAtama = {}; // { personelId: { gunler: [], tipSayilari: {} } }
  
  for (let d = 1; d <= gunSayisi; d++) {
    simAtanan[d] = {};
  }
  
  // Saat deÄŸerlerini al
  const saatDegerleri = {
    hici: parseInt(document.getElementById('saat-hici')?.value) || 8,
    prs: parseInt(document.getElementById('saat-prs')?.value) || 8,
    cum: parseInt(document.getElementById('saat-cum')?.value) || 16,
    cmt: parseInt(document.getElementById('saat-cmt')?.value) || 24,
    pzr: parseInt(document.getElementById('saat-pzr')?.value) || 16
  };
  
  personelListesi.forEach(p => {
    simKisiAtama[p.id] = {
      gunler: [],
      tipSayilari: { hici: 0, prs: 0, cum: 0, cmt: 0, pzr: 0 },
      // WE/WD ayrÄ± takip (Cuma artÄ±k WE'de)
      weAtanan: 0,  // Hafta sonu: Cum + Cmt + Pzr
      wdAtanan: 0,  // Hafta iÃ§i: Pzt-Per (hici + prs)
      // SAAT BAZLI TAKÄ°P
      toplamSaat: 0
    };
  });
  
  // ============================================
  // WE/WD AYRIMI: Cuma artÄ±k Hafta Sonu (WE)
  // WE = Cuma + Cumartesi + Pazar
  // WD = Pazartesi + SalÄ± + Ã‡arÅŸamba + PerÅŸembe
  // ============================================
  
  // WE ve WD gÃ¼nlerini ayÄ±r
  const weGunleri = []; // Cuma, Cumartesi, Pazar
  const wdGunleri = []; // Pazartesi-PerÅŸembe
  for (let d = 1; d <= gunSayisi; d++) {
    const tip = getGunTipi(yil, ay, d);
    if (isWEGun(tip)) {
      weGunleri.push(d);
    } else {
      wdGunleri.push(d);
    }
  }
  
  // WE/WD slot sayÄ±larÄ±
  const weSlotToplam = weGunleri.length * gunluk;
  const wdSlotToplam = wdGunleri.length * gunluk;
  console.log(`WE gÃ¼nleri: ${weGunleri.length} gÃ¼n, ${weSlotToplam} slot`);
  console.log(`WD gÃ¼nleri: ${wdGunleri.length} gÃ¼n, ${wdSlotToplam} slot`);
  
  // KiÅŸi baÅŸÄ± WE/WD hedef hesapla
  const kisiBasiWEHedef = Math.ceil(weSlotToplam / personelListesi.length);
  const kisiBasiWDHedef = Math.ceil(wdSlotToplam / personelListesi.length);
  console.log(`KiÅŸi baÅŸÄ± hedef: WE=${kisiBasiWEHedef}, WD=${kisiBasiWDHedef}`);
  
  // DENGE Ä°Ã‡Ä°N: Ortalama ve maksimum nÃ¶bet sayÄ±sÄ± hesapla
  const toplamSlot = gunSayisi * gunluk;
  const ortalamaNobet = toplamSlot / personelListesi.length;
  const ortalamaInt = Math.ceil(ortalamaNobet); // Tam sayÄ± ortalama
  // Daha sÄ±kÄ± limit: ortalama + 1 (yuvarlama dahil)
  const maxNobetLimit = Math.ceil(ortalamaNobet + 0.5); // ~4.5 iÃ§in 5
  console.log('Denge: Ortalama=' + ortalamaNobet.toFixed(1) + ', MaxLimit=' + maxNobetLimit);
  
  // KÄ±sÄ±tlamalÄ± kiÅŸilerin gÃ¶rev haritasÄ±
  const kisitlamaMap = {};
  gorevKisitlamalari.forEach(k => {
    kisitlamaMap[String(k.personelId)] = k.gorevAdi;
  });
  
  // BÄ°RLÄ°KTE TUTULACAKLAR HARÄ°TASI
  // Her kiÅŸi iÃ§in birlikte tutulacaÄŸÄ± kiÅŸilerin listesi
  const birlikteMap = {}; // { personelId: [partnerId1, partnerId2, ...] }
  const birlikteKurallar = kurallar.filter(k => k.tur === 'birlikte');
  birlikteKurallar.forEach(kural => {
    const kisiler = kural.kisiler || [];
    kisiler.forEach(id => {
      if (!birlikteMap[String(id)]) birlikteMap[String(id)] = [];
      kisiler.forEach(partnerId => {
        if (partnerId !== id && !birlikteMap[String(id)].includes(partnerId)) {
          birlikteMap[String(id)].push(partnerId);
        }
      });
    });
  });
  console.log('Birlikte tutulacaklar:', birlikteMap);
  
  // ============================================
  // BÄ°RLÄ°KTE TUTULACAKLARIN ORTAK GÃœNLERÄ°NÄ° HESAPLA VE REZERVE ET
  // ============================================
  const birlikteGrupBilgileri = []; // { kisiler, ortakGunler, minHedef, rezerveGunler }
  const birlikteRezerveGunler = new Set(); // Birlikte tutulacaklar iÃ§in ayrÄ±lan gÃ¼nler
  
  birlikteKurallar.forEach(kural => {
    const kisilerIds = kural.kisiler || [];
    const kisiler = kisilerIds.map(id => personelListesi.find(p => String(p.id) === String(id))).filter(Boolean);
    
    if (kisiler.length < 2) return;
    
    // Ortak mÃ¼sait gÃ¼nleri hesapla
    const ortakMusaitlik = ortakMusaitlikHesapla(kisiler, gunSayisi, yil, ay);
    
    // Grubun minimum hedefi (en az hedefi olan kiÅŸi kadar birlikte tutulabilir)
    const ortalamaNobet = Math.ceil((gunSayisi * gunluk) / personelListesi.length);
    const minHedef = Math.min(ortalamaNobet, ortakMusaitlik.toplamOrtakGun);
    
    // WE/WD dengesini koru - ortak gÃ¼nlerden WE ve WD seÃ§
    const ortakWEGunleri = [...ortakMusaitlik.ortakGunler.cum, ...ortakMusaitlik.ortakGunler.cmt, ...ortakMusaitlik.ortakGunler.pzr];
    const ortakWDGunleri = [...ortakMusaitlik.ortakGunler.hici, ...ortakMusaitlik.ortakGunler.prs];
    
    // Hedefin yarÄ±sÄ± WE, yarÄ±sÄ± WD olsun (mÃ¼mkÃ¼nse)
    const hedefWE = Math.min(Math.ceil(minHedef / 2), ortakWEGunleri.length);
    const hedefWD = Math.min(minHedef - hedefWE, ortakWDGunleri.length);
    
    // HER GÃœN Ä°Ã‡Ä°N MAZERETLÄ° KÄ°ÅÄ° SAYISINI HESAPLA
    // Ã‡ok mazeretli gÃ¼n = az kiÅŸi mÃ¼sait = o gÃ¼ne birlikte grubu atamak mantÄ±klÄ±
    function gunMazeretSayisi(gun) {
      return personelListesi.filter(p => 
        p.mazeretler?.includes(gun) || p.yillikIzinler?.includes(gun) || p.nobetIzinleri?.includes(gun)
      ).length;
    }
    
    // Rezerve edilecek gÃ¼nleri seÃ§ - EN Ã‡OK MAZERETLÄ° GÃœNLER Ã–NCE (grup mÃ¼saitse)
    const rezerveGunler = [];
    
    // WE gÃ¼nlerini mazeretli sayÄ±sÄ±na gÃ¶re sÄ±rala (Ã§ok mazeretli Ã¶nce)
    const weGunleriSirali = ortakWEGunleri
      .map(gun => ({ gun, mazeretli: gunMazeretSayisi(gun) }))
      .sort((a, b) => b.mazeretli - a.mazeretli) // Ã‡ok mazeretli Ã¶nce
      .map(x => x.gun);
    
    for (let i = 0; i < hedefWE && i < weGunleriSirali.length; i++) {
      rezerveGunler.push(weGunleriSirali[i]);
      birlikteRezerveGunler.add(weGunleriSirali[i]);
    }
    
    // WD gÃ¼nlerini mazeretli sayÄ±sÄ±na gÃ¶re sÄ±rala (Ã§ok mazeretli Ã¶nce)
    const wdGunleriSirali = ortakWDGunleri
      .map(gun => ({ gun, mazeretli: gunMazeretSayisi(gun) }))
      .sort((a, b) => b.mazeretli - a.mazeretli) // Ã‡ok mazeretli Ã¶nce
      .map(x => x.gun);
    
    for (let i = 0; i < hedefWD && i < wdGunleriSirali.length; i++) {
      rezerveGunler.push(wdGunleriSirali[i]);
      birlikteRezerveGunler.add(wdGunleriSirali[i]);
    }
    
    birlikteGrupBilgileri.push({
      kisiler,
      kisilerIds,
      ortakMusaitlik,
      minHedef,
      hedefWE,
      hedefWD,
      rezerveGunler
    });
    
    console.log(`Birlikte grup: ${kisiler.map(p => p.ad).join(' + ')} â†’ Ortak gÃ¼n: ${ortakMusaitlik.toplamOrtakGun}, Hedef: ${minHedef} (WE:${hedefWE}, WD:${hedefWD}), Rezerve: ${rezerveGunler.join(',')}`);
  });
  
  // 1. Ã–NCE MANUEL ATAMALARI SÄ°MÃœLE ET
  manuelAtamalar.forEach(m => {
    if (m.gun < 1 || m.gun > gunSayisi) return;
    
    const p = personelListesi.find(x => String(x.id) === String(m.personelId));
    if (!p) return;
    
    let slotIdx = -1;
    if (m.gorevId !== undefined) {
      slotIdx = siraliGorevler.findIndex(g => g.id === m.gorevId);
    }
    if (slotIdx === -1 && m.gorevAdi) {
      slotIdx = siraliGorevler.findIndex(g => g.ad === m.gorevAdi);
    }
    if (slotIdx === -1 && m.gorevIdx !== undefined) {
      slotIdx = m.gorevIdx;
    }
    
    if (slotIdx < 0 || slotIdx >= siraliGorevler.length) return;
    
    const tip = getGunTipi(yil, ay, m.gun);
    
    simAtanan[m.gun][slotIdx] = p.id;
    if (!simKisiAtama[p.id].gunler.includes(m.gun)) {
      simKisiAtama[p.id].gunler.push(m.gun);
    }
    simKisiAtama[p.id].tipSayilari[tip]++;
  });
  
  // 2. BÄ°RLÄ°KTE TUTULACAKLARI REZERVE GÃœNLERE ATA
  birlikteGrupBilgileri.forEach(grupBilgi => {
    const { kisiler, rezerveGunler } = grupBilgi;
    
    rezerveGunler.forEach(gun => {
      const tip = getGunTipi(yil, ay, gun);
      
      // Bu gÃ¼nde yeterli boÅŸ slot var mÄ±?
      const bosSlotlar = [];
      for (let i = 0; i < siraliGorevler.length; i++) {
        if (simAtanan[gun][i] === undefined) bosSlotlar.push(i);
      }
      
      if (bosSlotlar.length < kisiler.length) return;
      
      // TÃ¼m kiÅŸiler bu gÃ¼ne atanabilir mi? (ara gÃ¼n kontrolÃ¼)
      const hepsiAtanabilir = kisiler.every(p => {
        // Zaten bu gÃ¼ne atanmÄ±ÅŸ mÄ±?
        if (Object.values(simAtanan[gun]).includes(p.id)) return true; // Zaten atanmÄ±ÅŸ, OK
        
        // Ara gÃ¼n kontrolÃ¼
        for (const atananGun of simKisiAtama[p.id].gunler) {
          if (Math.abs(atananGun - gun) <= araGun) return false;
        }
        return true;
      });
      
      if (!hepsiAtanabilir) return;
      
      // Grubu bu gÃ¼ne ata
      let slotIdx = 0;
      kisiler.forEach(p => {
        // Zaten bu gÃ¼ne atanmÄ±ÅŸ mÄ±?
        if (Object.values(simAtanan[gun]).includes(p.id)) return;
        
        // BoÅŸ slot bul
        while (slotIdx < bosSlotlar.length && simAtanan[gun][bosSlotlar[slotIdx]] !== undefined) {
          slotIdx++;
        }
        if (slotIdx >= bosSlotlar.length) return;
        
        const slot = bosSlotlar[slotIdx];
        simAtanan[gun][slot] = p.id;
        if (!simKisiAtama[p.id].gunler.includes(gun)) {
          simKisiAtama[p.id].gunler.push(gun);
        }
        simKisiAtama[p.id].tipSayilari[tip]++;
        
        // WE/WD sayacÄ±nÄ± gÃ¼ncelle
        if (isWEGun(tip)) {
          simKisiAtama[p.id].weAtanan++;
        } else {
          simKisiAtama[p.id].wdAtanan++;
        }
        
        // Saat takibi
        const saat = saatDegerleri[tip] || 8;
        simKisiAtama[p.id].toplamSaat += saat;
        
        slotIdx++;
      });
      
      console.log(`Birlikte grup ${kisiler.map(p => p.ad).join('+')} â†’ GÃ¼n ${gun} (${tip}) atandÄ±`);
    });
  });
  
  // GÃ¼nleri zorluÄŸa gÃ¶re sÄ±rala + mazeretli sayÄ±sÄ±na gÃ¶re
  const gunSirasi = [];
  for (let d = 1; d <= gunSayisi; d++) {
    const tip = getGunTipi(yil, ay, d);
    const zorluk = { cmt: 5, pzr: 4, cum: 4, prs: 2, hici: 2 }[tip];
    
    const mazeretliSayisi = personelListesi.filter(p => 
      p.mazeretler?.includes(d) || p.yillikIzinler?.includes(d) || p.nobetIzinleri?.includes(d)
    ).length;
    
    gunSirasi.push({ gun: d, tip, zorluk, mazeretliSayisi });
  }
  
  // KÄ°ÅÄ°LERÄ°N MAZERET SAYISINI HESAPLA (en Ã§ok mazeretli = en zor yerleÅŸtirmek)
  const kisiMazeretSayisi = {};
  personelListesi.forEach(p => {
    const mazeretler = (p.mazeretler?.length || 0) + (p.yillikIzinler?.length || 0) + (p.nobetIzinleri?.length || 0);
    const musaitGunSayisi = gunSayisi - mazeretler;
    
    // WE/WD mÃ¼saitlik hesapla
    const mazeretSet = new Set([...(p.mazeretler || []), ...(p.yillikIzinler || []), ...(p.nobetIzinleri || [])]);
    const musaitWEGunleri = weGunleri.filter(d => !mazeretSet.has(d));
    const musaitWDGunleri = wdGunleri.filter(d => !mazeretSet.has(d));
    
    kisiMazeretSayisi[p.id] = {
      mazeretSayisi: mazeretler,
      musaitGunSayisi: musaitGunSayisi,
      zorluk: mazeretler / gunSayisi,
      // WE/WD mÃ¼saitlik
      musaitWE: musaitWEGunleri.length,
      musaitWD: musaitWDGunleri.length,
      // Ä°mkansÄ±z hedef kontrolÃ¼ iÃ§in
      maxWE: musaitWEGunleri.length,  // En fazla bu kadar WE tutabilir
      maxWD: musaitWDGunleri.length   // En fazla bu kadar WD tutabilir
    };
  });
  
  // Ä°MKANSIZ HEDEF KONTROLÃœ: KiÅŸinin WE/WD kapasitesini kontrol et
  let toplamWEKapasite = 0;
  let toplamWDKapasite = 0;
  
  // KÄ±sÄ±tlamalÄ± kiÅŸilerin gÃ¶rev kapasitelerini hesapla
  // (Exclusive mod kapalÄ± olsa bile, kÄ±sÄ±tlamalÄ± kiÅŸi sadece o gÃ¶reve atanabilir)
  const kisitlamaGorevKapasite = {}; // { gorevAdi: { weGunSayisi, wdGunSayisi, sutunSayisi } }
  Object.values(kisitlamaMap).forEach(gorevAdi => {
    if (!kisitlamaGorevKapasite[gorevAdi]) {
      const sutunSayisi = gorevler.filter(g => g.ad === gorevAdi).length;
      kisitlamaGorevKapasite[gorevAdi] = {
        sutunSayisi,
        weSlot: weGunleri.length * sutunSayisi,
        wdSlot: wdGunleri.length * sutunSayisi
      };
    }
  });
  
  personelListesi.forEach(p => {
    const info = kisiMazeretSayisi[p.id];
    const kisitliGorev = kisitlamaMap[String(p.id)];
    
    if (kisitliGorev && kisitlamaGorevKapasite[kisitliGorev]) {
      // KISITLAMALI KÄ°ÅÄ°: Sadece kendi gÃ¶revine atanabilir
      // WE/WD DENGESÄ° ZORLANMALI - hem WE hem WD almalÄ±
      const gorevInfo = kisitlamaGorevKapasite[kisitliGorev];
      
      // KÄ±sÄ±tlamalÄ± kiÅŸinin mÃ¼sait WE/WD gÃ¼nleri
      const maxWEFromGorev = Math.min(gorevInfo.weSlot, info.maxWE);
      const maxWDFromGorev = Math.min(gorevInfo.wdSlot, info.maxWD);
      
      // Toplam hedef (genel ortalama kadar)
      const toplamHedef = Math.min(
        kisiBasiWEHedef + kisiBasiWDHedef,
        maxWEFromGorev + maxWDFromGorev
      );
      
      // WE/WD DENGELÄ° DAÄITIM: Hem WE hem WD alsÄ±n
      // Oran: WE gÃ¼nleri / toplam gÃ¼nler
      const weOran = weGunleri.length / gunSayisi; // ~0.43 (13/31)
      const wdOran = wdGunleri.length / gunSayisi; // ~0.57 (18/31)
      
      // Hedefleri orana gÃ¶re daÄŸÄ±t, ama en az 1 olsun (mÃ¼saitse)
      let hedefWE = Math.round(toplamHedef * weOran);
      let hedefWD = Math.round(toplamHedef * wdOran);
      
      // En az 1 WE ve 1 WD garantile (mÃ¼saitse)
      if (maxWEFromGorev >= 1 && hedefWE < 1) hedefWE = 1;
      if (maxWDFromGorev >= 1 && hedefWD < 1) hedefWD = 1;
      
      // Kapasiteyi aÅŸmasÄ±n
      hedefWE = Math.min(hedefWE, maxWEFromGorev);
      hedefWD = Math.min(hedefWD, maxWDFromGorev);
      
      // Toplam hedefi aÅŸmasÄ±n
      if (hedefWE + hedefWD > toplamHedef) {
        // FazlayÄ± WE/WD oranÄ±na gÃ¶re dÃ¼ÅŸ
        const fazla = (hedefWE + hedefWD) - toplamHedef;
        if (hedefWE > hedefWD) {
          hedefWE -= fazla;
        } else {
          hedefWD -= fazla;
        }
      }
      
      info.hedefWE = Math.max(0, hedefWE);
      info.hedefWD = Math.max(0, hedefWD);
      
      console.log(`KÄ±sÄ±tlamalÄ± ${p.ad} â†’ ${kisitliGorev}: WE hedef=${info.hedefWE}, WD hedef=${info.hedefWD} (toplam=${info.hedefWE + info.hedefWD})`);
    } else {
      // Normal kiÅŸi
      info.hedefWE = Math.min(kisiBasiWEHedef, info.maxWE);
      info.hedefWD = Math.min(kisiBasiWDHedef, info.maxWD);
    }
    
    toplamWEKapasite += info.hedefWE;
    toplamWDKapasite += info.hedefWD;
  });
  
  // Eksik WE/WD kapasitesini uygun kiÅŸilere daÄŸÄ±t
  let eksikWE = weSlotToplam - toplamWEKapasite;
  let eksikWD = wdSlotToplam - toplamWDKapasite;
  
  if (eksikWE > 0) {
    console.log(`âš ï¸ WE kapasitesi eksik: ${eksikWE} slot daÄŸÄ±tÄ±lacak`);
    // Kapasitesi olan kiÅŸilere ekstra WE daÄŸÄ±t
    const uygunKisiler = personelListesi
      .filter(p => kisiMazeretSayisi[p.id].maxWE > kisiMazeretSayisi[p.id].hedefWE)
      .sort((a, b) => {
        const aKalan = kisiMazeretSayisi[a.id].maxWE - kisiMazeretSayisi[a.id].hedefWE;
        const bKalan = kisiMazeretSayisi[b.id].maxWE - kisiMazeretSayisi[b.id].hedefWE;
        return bKalan - aKalan; // En Ã§ok kapasitesi olan Ã¶nce
      });
    
    for (const p of uygunKisiler) {
      if (eksikWE <= 0) break;
      const info = kisiMazeretSayisi[p.id];
      const eklenebilir = Math.min(eksikWE, info.maxWE - info.hedefWE);
      info.hedefWE += eklenebilir;
      eksikWE -= eklenebilir;
    }
  }
  
  if (eksikWD > 0) {
    console.log(`âš ï¸ WD kapasitesi eksik: ${eksikWD} slot daÄŸÄ±tÄ±lacak`);
    const uygunKisiler = personelListesi
      .filter(p => kisiMazeretSayisi[p.id].maxWD > kisiMazeretSayisi[p.id].hedefWD)
      .sort((a, b) => {
        const aKalan = kisiMazeretSayisi[a.id].maxWD - kisiMazeretSayisi[a.id].hedefWD;
        const bKalan = kisiMazeretSayisi[b.id].maxWD - kisiMazeretSayisi[b.id].hedefWD;
        return bKalan - aKalan;
      });
    
    for (const p of uygunKisiler) {
      if (eksikWD <= 0) break;
      const info = kisiMazeretSayisi[p.id];
      const eklenebilir = Math.min(eksikWD, info.maxWD - info.hedefWD);
      info.hedefWD += eklenebilir;
      eksikWD -= eklenebilir;
    }
  }
  
  console.log('WE/WD hedefleri:', personelListesi.map(p => ({
    ad: p.ad,
    hedefWE: kisiMazeretSayisi[p.id].hedefWE,
    hedefWD: kisiMazeretSayisi[p.id].hedefWD,
    maxWE: kisiMazeretSayisi[p.id].maxWE,
    maxWD: kisiMazeretSayisi[p.id].maxWD
  })));
  
  // En Ã§ok mazeretli kiÅŸileri logla
  const enCokMazeretliler = personelListesi
    .map(p => ({ ad: p.ad, ...kisiMazeretSayisi[p.id] }))
    .sort((a, b) => b.mazeretSayisi - a.mazeretSayisi)
    .slice(0, 5);
  console.log('En Ã§ok mazeretli 5 kiÅŸi:', enCokMazeretliler);
  gunSirasi.sort((a, b) => {
    if (b.zorluk !== a.zorluk) return b.zorluk - a.zorluk;
    return b.mazeretliSayisi - a.mazeretliSayisi;
  });
  
  // EXCLUSIVE MOD: Hangi gÃ¶revler sadece kÄ±sÄ±tlamalÄ± kiÅŸilere ait?
  // ArtÄ±k kiÅŸi bazlÄ±: her kÄ±sÄ±tlamanÄ±n kendi exclusive flag'i var
  const exclusiveGorevler = new Set();
  gorevKisitlamalari.forEach(k => {
    // KiÅŸi bazlÄ± exclusive veya global exclusive aktifse
    if (k.exclusive !== false || kisitlamaExclusive) {
      exclusiveGorevler.add(k.gorevAdi);
    }
  });
  
  // EXCLUSIVE MOD iÃ§in kiÅŸi baÅŸÄ± limit hesapla
  const exclusiveLimitler = {}; // { personelId: maxNobet }
  // Sadece exclusive olan kÄ±sÄ±tlamalar iÃ§in hesapla
  const exclusiveKisitlamalar = gorevKisitlamalari.filter(k => k.exclusive !== false || kisitlamaExclusive);
  
  if (exclusiveKisitlamalar.length > 0) {
    const gorevKisitlamaSayisi = {};
    exclusiveKisitlamalar.forEach(k => {
      gorevKisitlamaSayisi[k.gorevAdi] = (gorevKisitlamaSayisi[k.gorevAdi] || 0) + 1;
    });
    
    exclusiveKisitlamalar.forEach(k => {
      const gorevAdi = k.gorevAdi;
      const sutunSayisi = gorevler.filter(g => g.ad === gorevAdi).length;
      const gorevKapasitesi = gunSayisi * sutunSayisi;
      const kisiSayisi = gorevKisitlamaSayisi[gorevAdi] || 1;
      
      // Kapasiteyi kiÅŸi sayÄ±sÄ±na bÃ¶l
      const limit = Math.ceil(gorevKapasitesi / kisiSayisi);
      exclusiveLimitler[String(k.personelId)] = limit;
      
      const personel = personelListesi.find(p => String(p.id) === String(k.personelId));
      console.log(`Exclusive limit: ${personel?.ad} â†’ ${gorevAdi}: max ${limit} nÃ¶bet (kapasite=${gorevKapasitesi}, kiÅŸi=${kisiSayisi})`);
    });
  }
  
  // SimÃ¼lasyonda kiÅŸi atanabilir mi kontrolÃ¼
  function simKisiAtanabilirMi(p, gun, gorev, mevcutAraGun, softLimit = true) {
    if (Object.values(simAtanan[gun]).includes(p.id)) return false;
    if (p.mazeretler?.includes(gun) || p.yillikIzinler?.includes(gun) || p.nobetIzinleri?.includes(gun)) return false;
    
    // EXCLUSIVE MOD: Bu gÃ¶rev sadece kÄ±sÄ±tlamalÄ± kiÅŸilere mi ait?
    // ArtÄ±k kiÅŸi bazlÄ± exclusive kontrolÃ¼
    if (exclusiveGorevler.has(gorev.ad)) {
      // Bu gÃ¶reve sadece o gÃ¶reve kÄ±sÄ±tlÄ± kiÅŸiler atanabilir
      const kisitliGorev = kisitlamaMap[String(p.id)];
      if (kisitliGorev !== gorev.ad) return false;
    }
    
    // DENGE: Soft limit
    if (softLimit) {
      // Exclusive modda kÄ±sÄ±tlamalÄ± kiÅŸiler iÃ§in Ã¶zel limit
      // DÃœZELTME: exclusiveLimit ve maxNobetLimit'in minimumunu al
      const exclusiveLimit = exclusiveLimitler[String(p.id)];
      const limit = exclusiveLimit ? Math.min(exclusiveLimit, maxNobetLimit) : maxNobetLimit;
      if (simKisiAtama[p.id].gunler.length >= limit) return false;
    }
    
    for (const atananGun of simKisiAtama[p.id].gunler) {
      if (Math.abs(atananGun - gun) <= mevcutAraGun) return false;
    }
    
    const kisitliGorev = kisitlamaMap[String(p.id)];
    if (kisitliGorev && gorev.ad !== kisitliGorev) return false;
    
    for (const kural of kurallar.filter(k => k.tur === 'ayri')) {
      if (String(kural.p1) === String(p.id) || String(kural.p2) === String(p.id)) {
        const diger = String(kural.p1) === String(p.id) ? kural.p2 : kural.p1;
        const bugunAtananlar = Object.values(simAtanan[gun]).map(id => String(id));
        if (bugunAtananlar.includes(String(diger))) return false;
      }
    }
    
    return true;
  }
  
  // 2. SÄ°MÃœLASYON: TÃ¼m slotlarÄ± doldurmaya Ã§alÄ±ÅŸ
  
  // Her gÃ¶revin kaÃ§ sÃ¼tunu olduÄŸunu hesapla (aynÄ± isimli gÃ¶revler)
  const gorevSutunSayilari = {};
  siraliGorevler.forEach(g => {
    gorevSutunSayilari[g.ad] = (gorevSutunSayilari[g.ad] || 0) + 1;
  });
  
  // TEK SÃœTUNLU GÃ–REVLERÄ° Ã–NCE YERLEÅTÄ°R (alternatif yok!)
  const tekSutunluGorevler = siraliGorevler
    .map((g, idx) => ({ ...g, slotIdx: idx }))
    .filter(g => gorevSutunSayilari[g.ad] === 1);
  
  const cokSutunluGorevler = siraliGorevler
    .map((g, idx) => ({ ...g, slotIdx: idx }))
    .filter(g => gorevSutunSayilari[g.ad] > 1);
  
  console.log('Tek sÃ¼tunlu gÃ¶revler:', tekSutunluGorevler.map(g => g.ad));
  console.log('Ã‡ok sÃ¼tunlu gÃ¶revler:', [...new Set(cokSutunluGorevler.map(g => g.ad))]);
  
  // DEBUG: KÄ±sÄ±tlamalÄ± kiÅŸilerin durumunu logla
  if (Object.keys(kisitlamaMap).length > 0) {
    console.log('=== KISITLAMALI KÄ°ÅÄ°LER ===');
    Object.entries(kisitlamaMap).forEach(([pid, gorevAdi]) => {
      const p = personelListesi.find(x => String(x.id) === pid);
      if (p) {
        const mazeretSayisi = (p.mazeretler?.length || 0) + (p.yillikIzinler?.length || 0) + (p.nobetIzinleri?.length || 0);
        const musaitGunler = [];
        for (let d = 1; d <= gunSayisi; d++) {
          if (!p.mazeretler?.includes(d) && !p.yillikIzinler?.includes(d) && !p.nobetIzinleri?.includes(d)) {
            musaitGunler.push(d);
          }
        }
        console.log(`${p.ad} â†’ ${gorevAdi}: ${mazeretSayisi} mazeret, ${musaitGunler.length} mÃ¼sait gÃ¼n`);
      }
    });
  }
  
  // AÅŸamalÄ± ara gÃ¼n gevÅŸetme
  const araGunAsamalari = [araGun];
  if (araGun > 1) araGunAsamalari.push(Math.max(1, araGun - 1));
  if (araGun > 2) araGunAsamalari.push(1);
  
  // Her gÃ¼n tipi iÃ§in hedef sayÄ± (dengeli daÄŸÄ±tÄ±m iÃ§in)
  const tipBasinaHedef = {};
  GUN_TIPLERI.forEach(t => {
    let tipGunSayisi = 0;
    for (let d = 1; d <= gunSayisi; d++) {
      if (getGunTipi(yil, ay, d) === t) tipGunSayisi++;
    }
    tipBasinaHedef[t] = Math.ceil((tipGunSayisi * gunluk) / personelListesi.length);
  });
  console.log('Tip baÅŸÄ±na hedef:', tipBasinaHedef);
  
  // ============================================
  // WE/WD Ä°KÄ° AÅAMALI DAÄITIM
  // AÅAMA A: Ã–nce WE gÃ¼nlerini daÄŸÄ±t (Cum+Cmt+Pzr)
  // AÅAMA B: Sonra WD gÃ¼nlerini daÄŸÄ±t (Pzt-Per)
  // ============================================
  
  // WE gÃ¼nlerini zorluÄŸa gÃ¶re sÄ±rala
  const weGunSirasi = weGunleri.map(gun => {
    const tip = getGunTipi(yil, ay, gun);
    const zorluk = { cmt: 5, pzr: 4, cum: 4 }[tip] || 3;
    const mazeretliSayisi = personelListesi.filter(p => 
      p.mazeretler?.includes(gun) || p.yillikIzinler?.includes(gun) || p.nobetIzinleri?.includes(gun)
    ).length;
    return { gun, tip, zorluk, mazeretliSayisi };
  }).sort((a, b) => {
    if (b.zorluk !== a.zorluk) return b.zorluk - a.zorluk;
    return b.mazeretliSayisi - a.mazeretliSayisi;
  });
  
  // WD gÃ¼nlerini zorluÄŸa gÃ¶re sÄ±rala
  const wdGunSirasi = wdGunleri.map(gun => {
    const tip = getGunTipi(yil, ay, gun);
    const zorluk = { prs: 2, hici: 2 }[tip] || 2;
    const mazeretliSayisi = personelListesi.filter(p => 
      p.mazeretler?.includes(gun) || p.yillikIzinler?.includes(gun) || p.nobetIzinleri?.includes(gun)
    ).length;
    return { gun, tip, zorluk, mazeretliSayisi };
  }).sort((a, b) => {
    if (b.zorluk !== a.zorluk) return b.zorluk - a.zorluk;
    return b.mazeretliSayisi - a.mazeretliSayisi;
  });
  
  console.log('=== WE/WD Ä°KÄ° AÅAMALI DAÄITIM ===');
  console.log('WE gÃ¼n sÄ±rasÄ±:', weGunSirasi.map(g => `${g.gun}(${g.tip})`).join(', '));
  console.log('WD gÃ¼n sÄ±rasÄ±:', wdGunSirasi.map(g => `${g.gun}(${g.tip})`).join(', '));
  
  // WE iÃ§in aday sÄ±ralama fonksiyonu - SAAT BAZLI DENGE + WE Ä°Ã‡Ä° Ã‡EÅÄ°TLÄ°LÄ°K + BÄ°RLÄ°KTE TUTMA
  function weAdaySirala(adaylar, tip, gorev, gun) {
    // Bu gÃ¼ne zaten atanmÄ±ÅŸ kiÅŸileri bul (string'e Ã§evir)
    const buGunAtananlar = Object.values(simAtanan[gun] || {}).map(id => String(id));
    
    return adaylar.sort((a, b) => {
      const aInfo = kisiMazeretSayisi[a.id];
      const bInfo = kisiMazeretSayisi[b.id];
      const aAtama = simKisiAtama[a.id];
      const bAtama = simKisiAtama[b.id];
      const aWEAtanan = aAtama.weAtanan;
      const bWEAtanan = bAtama.weAtanan;
      const aHedefWE = aInfo.hedefWE;
      const bHedefWE = bInfo.hedefWE;
      
      // 0. KISITLAMALI KÄ°ÅÄ° Ã–NCELÄ°ÄÄ°: Bu gÃ¶reve kÄ±sÄ±tlÄ± kiÅŸiler Ã¶nce
      const aKisitli = kisitlamaMap[String(a.id)] === gorev.ad ? 1 : 0;
      const bKisitli = kisitlamaMap[String(b.id)] === gorev.ad ? 1 : 0;
      if (bKisitli !== aKisitli) return bKisitli - aKisitli;
      
      // 1. BÄ°RLÄ°KTE TUTULACAK Ã–NCELÄ°ÄÄ°: Partneri bu gÃ¼ne atanmÄ±ÅŸsa Ã¶ncelik ver
      const aPartnerler = birlikteMap[String(a.id)] || [];
      const bPartnerler = birlikteMap[String(b.id)] || [];
      const aPartnerBuGunde = aPartnerler.some(pid => buGunAtananlar.includes(String(pid)));
      const bPartnerBuGunde = bPartnerler.some(pid => buGunAtananlar.includes(String(pid)));
      if (aPartnerBuGunde !== bPartnerBuGunde) return aPartnerBuGunde ? -1 : 1;
      
      // 2. WE Ä°Ã‡Ä° Ã‡EÅÄ°TLÄ°LÄ°K: AynÄ± gÃ¼n tipinden 2+ atama cezasÄ±
      const aTipSayisi = aAtama.tipSayilari[tip] || 0;
      const bTipSayisi = bAtama.tipSayilari[tip] || 0;
      if (aTipSayisi !== bTipSayisi) return aTipSayisi - bTipSayisi;
      
      // 3. SAAT BAZLI DENGE: Az saat alan Ã¶nce
      const aSaat = aAtama.toplamSaat || 0;
      const bSaat = bAtama.toplamSaat || 0;
      if (aSaat !== bSaat) return aSaat - bSaat;
      
      // 4. WE ihtiyacÄ± en yÃ¼ksek olan Ã¶nce (hedef - atanan)
      const aIhtiyac = aHedefWE - aWEAtanan;
      const bIhtiyac = bHedefWE - bWEAtanan;
      if (bIhtiyac !== aIhtiyac) return bIhtiyac - aIhtiyac;
      
      // 5. WE'de az atanan Ã¶nce
      if (aWEAtanan !== bWEAtanan) return aWEAtanan - bWEAtanan;
      
      // 6. Toplam az atanan Ã¶nce
      const aAtanan = aAtama.gunler.length;
      const bAtanan = bAtama.gunler.length;
      if (aAtanan !== bAtanan) return aAtanan - bAtanan;
      
      // 7. Ã‡ok mazeretli Ã¶nce (sÄ±kÄ±ÅŸÄ±k kiÅŸi)
      return bInfo.mazeretSayisi - aInfo.mazeretSayisi;
    });
  }
  
  // WD iÃ§in aday sÄ±ralama fonksiyonu - SAAT BAZLI DENGE + WD Ä°Ã‡Ä° Ã‡EÅÄ°TLÄ°LÄ°K + BÄ°RLÄ°KTE TUTMA
  function wdAdaySirala(adaylar, tip, gorev, gun) {
    // Bu gÃ¼ne zaten atanmÄ±ÅŸ kiÅŸileri bul (string'e Ã§evir)
    const buGunAtananlar = Object.values(simAtanan[gun] || {}).map(id => String(id));
    
    return adaylar.sort((a, b) => {
      const aInfo = kisiMazeretSayisi[a.id];
      const bInfo = kisiMazeretSayisi[b.id];
      const aAtama = simKisiAtama[a.id];
      const bAtama = simKisiAtama[b.id];
      const aWDAtanan = aAtama.wdAtanan;
      const bWDAtanan = bAtama.wdAtanan;
      const aHedefWD = aInfo.hedefWD;
      const bHedefWD = bInfo.hedefWD;
      
      // 0. KISITLAMALI KÄ°ÅÄ° Ã–NCELÄ°ÄÄ°: Bu gÃ¶reve kÄ±sÄ±tlÄ± kiÅŸiler Ã¶nce
      const aKisitli = kisitlamaMap[String(a.id)] === gorev.ad ? 1 : 0;
      const bKisitli = kisitlamaMap[String(b.id)] === gorev.ad ? 1 : 0;
      if (bKisitli !== aKisitli) return bKisitli - aKisitli;
      
      // 1. BÄ°RLÄ°KTE TUTULACAK Ã–NCELÄ°ÄÄ°: Partneri bu gÃ¼ne atanmÄ±ÅŸsa Ã¶ncelik ver
      const aPartnerler = birlikteMap[String(a.id)] || [];
      const bPartnerler = birlikteMap[String(b.id)] || [];
      const aPartnerBuGunde = aPartnerler.some(pid => buGunAtananlar.includes(String(pid)));
      const bPartnerBuGunde = bPartnerler.some(pid => buGunAtananlar.includes(String(pid)));
      if (aPartnerBuGunde !== bPartnerBuGunde) return aPartnerBuGunde ? -1 : 1;
      
      // 2. SAAT BAZLI DENGE: Az saat alan Ã¶nce
      const aSaat = aAtama.toplamSaat || 0;
      const bSaat = bAtama.toplamSaat || 0;
      if (aSaat !== bSaat) return aSaat - bSaat;
      
      // 3. WD ihtiyacÄ± en yÃ¼ksek olan Ã¶nce
      const aIhtiyac = aHedefWD - aWDAtanan;
      const bIhtiyac = bHedefWD - bWDAtanan;
      if (bIhtiyac !== aIhtiyac) return bIhtiyac - aIhtiyac;
      
      // 4. WD'de az atanan Ã¶nce
      if (aWDAtanan !== bWDAtanan) return aWDAtanan - bWDAtanan;
      
      // 5. Toplam az atanan Ã¶nce
      const aAtanan = aAtama.gunler.length;
      const bAtanan = bAtama.gunler.length;
      if (aAtanan !== bAtanan) return aAtanan - bAtanan;
      
      // 6. Ã‡ok mazeretli Ã¶nce
      return bInfo.mazeretSayisi - aInfo.mazeretSayisi;
    });
  }
  
  // WE/WD limit kontrolÃ¼ eklenmiÅŸ atanabilirlik fonksiyonu
  function simKisiAtanabilirMiWE(p, gun, gorev, mevcutAraGun) {
    if (!simKisiAtanabilirMi(p, gun, gorev, mevcutAraGun, false)) return false;
    
    // WE hedefini aÅŸmasÄ±n
    const info = kisiMazeretSayisi[p.id];
    if (simKisiAtama[p.id].weAtanan >= info.hedefWE) return false;
    
    return true;
  }
  
  function simKisiAtanabilirMiWD(p, gun, gorev, mevcutAraGun) {
    if (!simKisiAtanabilirMi(p, gun, gorev, mevcutAraGun, false)) return false;
    
    // WD hedefini aÅŸmasÄ±n
    const info = kisiMazeretSayisi[p.id];
    if (simKisiAtama[p.id].wdAtanan >= info.hedefWD) return false;
    
    return true;
  }
  
  // Atama yap ve WE/WD sayacÄ±nÄ± + SAAT takibini gÃ¼ncelle
  function atamaYap(gun, slotIdx, personelId, tip) {
    simAtanan[gun][slotIdx] = personelId;
    if (!simKisiAtama[personelId].gunler.includes(gun)) {
      simKisiAtama[personelId].gunler.push(gun);
    }
    simKisiAtama[personelId].tipSayilari[tip]++;
    
    // WE/WD sayacÄ±nÄ± gÃ¼ncelle
    if (isWEGun(tip)) {
      simKisiAtama[personelId].weAtanan++;
    } else {
      simKisiAtama[personelId].wdAtanan++;
    }
    
    // SAAT TAKÄ°BÄ°: GÃ¼n tipine gÃ¶re saat ekle
    const saat = saatDegerleri[tip] || 8;
    simKisiAtama[personelId].toplamSaat += saat;
  }
  
  // ============================================
  // AÅAMA A: WE GÃœNLERÄ°NÄ° DAÄIT (Cum+Cmt+Pzr)
  // ============================================
  console.log('=== AÅAMA A: WE DAÄITIMI ===');
  
  for (const mevcutAraGun of araGunAsamalari) {
    // Ã–nce tek sÃ¼tunlu gÃ¶revler
    weGunSirasi.forEach(({ gun, tip }) => {
      tekSutunluGorevler.forEach(gorev => {
        const slotIdx = gorev.slotIdx;
        if (simAtanan[gun][slotIdx] !== undefined) return;
        
        let adaylar = personelListesi.filter(p => simKisiAtanabilirMiWE(p, gun, gorev, mevcutAraGun));
        if (adaylar.length === 0) return;
        
        weAdaySirala(adaylar, tip, gorev, gun);
        atamaYap(gun, slotIdx, adaylar[0].id, tip);
      });
    });
    
    // Sonra Ã§ok sÃ¼tunlu gÃ¶revler
    weGunSirasi.forEach(({ gun, tip }) => {
      cokSutunluGorevler.forEach(gorev => {
        const slotIdx = gorev.slotIdx;
        if (simAtanan[gun][slotIdx] !== undefined) return;
        
        let adaylar = personelListesi.filter(p => simKisiAtanabilirMiWE(p, gun, gorev, mevcutAraGun));
        if (adaylar.length === 0) return;
        
        weAdaySirala(adaylar, tip, gorev, gun);
        atamaYap(gun, slotIdx, adaylar[0].id, tip);
      });
    });
  }
  
  // WE iÃ§in soft limit olmadan son deneme
  weGunSirasi.forEach(({ gun, tip }) => {
    [...tekSutunluGorevler, ...cokSutunluGorevler].forEach(gorev => {
      const slotIdx = gorev.slotIdx;
      if (simAtanan[gun][slotIdx] !== undefined) return;
      
      // Soft limit yok - sadece temel kontroller
      let adaylar = personelListesi.filter(p => simKisiAtanabilirMi(p, gun, gorev, 1, false));
      if (adaylar.length === 0) return;
      
      weAdaySirala(adaylar, tip, gorev, gun);
      atamaYap(gun, slotIdx, adaylar[0].id, tip);
    });
  });
  
  // WE daÄŸÄ±tÄ±m sonucu
  const weAtananToplam = personelListesi.reduce((s, p) => s + simKisiAtama[p.id].weAtanan, 0);
  console.log(`WE daÄŸÄ±tÄ±m sonucu: ${weAtananToplam}/${weSlotToplam} slot dolu`);
  
  // ============================================
  // AÅAMA B: WD GÃœNLERÄ°NÄ° DAÄIT (Pzt-Per)
  // ============================================
  console.log('=== AÅAMA B: WD DAÄITIMI ===');
  
  for (const mevcutAraGun of araGunAsamalari) {
    // Ã–nce tek sÃ¼tunlu gÃ¶revler
    wdGunSirasi.forEach(({ gun, tip }) => {
      tekSutunluGorevler.forEach(gorev => {
        const slotIdx = gorev.slotIdx;
        if (simAtanan[gun][slotIdx] !== undefined) return;
        
        let adaylar = personelListesi.filter(p => simKisiAtanabilirMiWD(p, gun, gorev, mevcutAraGun));
        if (adaylar.length === 0) return;
        
        wdAdaySirala(adaylar, tip, gorev, gun);
        atamaYap(gun, slotIdx, adaylar[0].id, tip);
      });
    });
    
    // Sonra Ã§ok sÃ¼tunlu gÃ¶revler
    wdGunSirasi.forEach(({ gun, tip }) => {
      cokSutunluGorevler.forEach(gorev => {
        const slotIdx = gorev.slotIdx;
        if (simAtanan[gun][slotIdx] !== undefined) return;
        
        let adaylar = personelListesi.filter(p => simKisiAtanabilirMiWD(p, gun, gorev, mevcutAraGun));
        if (adaylar.length === 0) return;
        
        wdAdaySirala(adaylar, tip, gorev, gun);
        atamaYap(gun, slotIdx, adaylar[0].id, tip);
      });
    });
  }
  
  // WD iÃ§in soft limit olmadan son deneme
  wdGunSirasi.forEach(({ gun, tip }) => {
    [...tekSutunluGorevler, ...cokSutunluGorevler].forEach(gorev => {
      const slotIdx = gorev.slotIdx;
      if (simAtanan[gun][slotIdx] !== undefined) return;
      
      let adaylar = personelListesi.filter(p => simKisiAtanabilirMi(p, gun, gorev, 1, false));
      if (adaylar.length === 0) return;
      
      wdAdaySirala(adaylar, tip, gorev, gun);
      atamaYap(gun, slotIdx, adaylar[0].id, tip);
    });
  });
  
  // WD daÄŸÄ±tÄ±m sonucu
  const wdAtananToplam = personelListesi.reduce((s, p) => s + simKisiAtama[p.id].wdAtanan, 0);
  console.log(`WD daÄŸÄ±tÄ±m sonucu: ${wdAtananToplam}/${wdSlotToplam} slot dolu`);
  
  // ============================================
  // WE/WD DENGE KONTROLÃœ
  // ============================================
  console.log('=== WE/WD DENGE KONTROLÃœ ===');
  
  personelListesi.forEach(p => {
    const info = kisiMazeretSayisi[p.id];
    const weAtanan = simKisiAtama[p.id].weAtanan;
    const wdAtanan = simKisiAtama[p.id].wdAtanan;
    const weFark = weAtanan - info.hedefWE;
    const wdFark = wdAtanan - info.hedefWD;
    if (Math.abs(weFark) > 1 || Math.abs(wdFark) > 1) {
      console.log(`${p.ad}: WE=${weAtanan}/${info.hedefWE}(${weFark > 0 ? '+' : ''}${weFark}), WD=${wdAtanan}/${info.hedefWD}(${wdFark > 0 ? '+' : ''}${wdFark})`);
    }
  });
  
  // 3. SÄ°MÃœLASYON SONUCU: Her kiÅŸinin gerÃ§ekÃ§i hedefini belirle
  personelListesi.forEach(p => {
    p.hedef = { ...simKisiAtama[p.id].tipSayilari };
    
    // WE/WD bilgilerini de kaydet
    p.weAtanan = simKisiAtama[p.id].weAtanan;
    p.wdAtanan = simKisiAtama[p.id].wdAtanan;
    p.hedefWE = kisiMazeretSayisi[p.id].hedefWE;
    p.hedefWD = kisiMazeretSayisi[p.id].hedefWD;
    
    // Manuel atama sayÄ±sÄ±nÄ± hesapla
    const manuelSayisi = manuelAtamalar.filter(m => String(m.personelId) === String(p.id)).length;
    p.manuelAtamaSayisi = manuelSayisi;
    
    // Ã–zel gÃ¶rev kotalarÄ±nÄ± sÄ±fÄ±rla
    p.gorevKotalari = p.gorevKotalari || {};
    ozelGorevler.forEach(g => {
      if (!p.gorevKotalari[g]) p.gorevKotalari[g] = 0;
    });
  });
  
  // DEBUG: Denge kontrolÃ¼
  const nobetDagilimi = personelListesi.map(p => ({
    ad: p.ad,
    toplam: simKisiAtama[p.id].gunler.length,
    tipler: { ...simKisiAtama[p.id].tipSayilari },
    we: simKisiAtama[p.id].weAtanan,
    wd: simKisiAtama[p.id].wdAtanan
  })).sort((a, b) => b.toplam - a.toplam);
  const maxNobet = nobetDagilimi[0]?.toplam || 0;
  const minNobet = nobetDagilimi[nobetDagilimi.length - 1]?.toplam || 0;
  console.log('Denge: Min=' + minNobet + ', Max=' + maxNobet + ', Fark=' + (maxNobet - minNobet));
  if (maxNobet - minNobet > 3) {
    console.warn('âš ï¸ Denge sorunu! En Ã§ok:', nobetDagilimi.slice(0, 3).map(x => x.ad + '(' + x.toplam + ')').join(', '));
    console.warn('âš ï¸ En az:', nobetDagilimi.slice(-3).map(x => x.ad + '(' + x.toplam + ')').join(', '));
  }
  
  // DEBUG: WE/WD denge kontrolÃ¼
  const weYok = nobetDagilimi.filter(p => p.we === 0 && p.toplam > 0);
  const wdYok = nobetDagilimi.filter(p => p.wd === 0 && p.toplam > 0);
  if (weYok.length > 0) {
    console.warn('âš ï¸ WE (Cum+Cmt+Pzr) nÃ¶beti olmayan:', weYok.map(x => x.ad).join(', '));
  }
  if (wdYok.length > 0) {
    console.warn('âš ï¸ WD (Pzt-Per) nÃ¶beti olmayan:', wdYok.map(x => x.ad).join(', '));
  }
  
  // 4. TOPLAM KAPASÄ°TE VE ATANAN HESAPLA
  const kapasite = { hici: 0, prs: 0, cum: 0, cmt: 0, pzr: 0, toplam: 0 };
  for (let d = 1; d <= gunSayisi; d++) {
    const tip = getGunTipi(yil, ay, d);
    kapasite[tip] += gunluk;
    kapasite.toplam += gunluk;
  }
  
  // SimÃ¼lasyonda atanan toplam
  const simAtananToplam = { hici: 0, prs: 0, cum: 0, cmt: 0, pzr: 0, toplam: 0 };
  for (let d = 1; d <= gunSayisi; d++) {
    const tip = getGunTipi(yil, ay, d);
    const atananSayisi = Object.keys(simAtanan[d]).length;
    simAtananToplam[tip] += atananSayisi;
    simAtananToplam.toplam += atananSayisi;
  }
  
  // Debug: SimÃ¼lasyon sonucunu konsola yazdÄ±r
  console.log('=== HEDEF SÄ°MÃœLASYONU ===');
  console.log('Kapasite:', kapasite);
  console.log('SimÃ¼lasyonda Atanan:', simAtananToplam);
  console.log('Doluluk:', Math.round(simAtananToplam.toplam / kapasite.toplam * 100) + '%');
  
  // 5. Ã–ZEL GÃ–REV KOTALARINI DAÄIT
  ozelGorevKotalariniDagit(ozelGorevler, gunSayisi);
  
  hedefTablosuGuncelle();
  ozelGorevSectionGuncelle();
  kaydetDebounced();
  } catch (e) {
    console.error('hedefleriHesaplaYerel hatasÄ±:', e);
    alert('Hedef hesaplama hatasÄ±: ' + e.message);
  }
}

// Ã–zel gÃ¶rev kotalarÄ±nÄ± dengeli daÄŸÄ±t
function ozelGorevKotalariniDagit(ozelGorevler, gunSayisi) {
  if (ozelGorevler.length === 0) return;
  
  const { yil, ay } = getYilAy();
  
  // Her Ã¶zel gÃ¶rev iÃ§in kapasite hesapla (ayarlardan veya varsayÄ±landan)
  const gorevKapasite = {};
  ozelGorevler.forEach(g => {
    if (gorevKapasiteAyar[g] && gorevKapasiteAyar[g].toplam > 0) {
      gorevKapasite[g] = gorevKapasiteAyar[g].toplam;
    } else {
      const sutunSayisi = gorevSutunSayisi(g);
      gorevKapasite[g] = gunSayisi * sutunSayisi;
    }
  });
  
  // Manuel atamalarÄ± dÃ¼ÅŸ
  manuelAtamalar.forEach(m => {
    if (m.gun < 1 || m.gun > gunSayisi) return;
    const gorevAdi = m.gorevAdi;
    if (ozelGorevler.includes(gorevAdi) && gorevKapasite[gorevAdi] > 0) {
      gorevKapasite[gorevAdi]--;
    }
  });
  
  // Ã–nce tÃ¼m kotalarÄ± sÄ±fÄ±rla (manuel atamalar hariÃ§)
  personelListesi.forEach(p => {
    if (!p.gorevKotalari) p.gorevKotalari = {};
    ozelGorevler.forEach(g => {
      // Manuel atama sayÄ±sÄ±nÄ± hesapla
      const manuelSayisi = manuelAtamalar.filter(m => 
        String(m.personelId) === String(p.id) && m.gorevAdi === g
      ).length;
      p.gorevKotalari[g] = manuelSayisi;
    });
  });
  
  // 1. Ã–NCE KISITLAMALI KÄ°ÅÄ°LERÄ° ATA
  // KÄ±sÄ±tlamalÄ± kiÅŸilerin TÃœM hedeflerini sadece o gÃ¶reve ata
  gorevKisitlamalari.forEach(k => {
    const personel = personelListesi.find(p => String(p.id) === String(k.personelId));
    if (!personel) return;
    
    const gorevAdi = k.gorevAdi;
    if (!ozelGorevler.includes(gorevAdi)) return;
    
    // KiÅŸinin toplam hedefini hesapla
    const toplamHedef = GUN_TIPLERI.reduce((s, t) => s + (personel.hedef?.[t] || 0), 0);
    
    // Manuel atama sayÄ±sÄ±nÄ± dÃ¼ÅŸ
    const manuelSayisi = manuelAtamalar.filter(m => 
      String(m.personelId) === String(personel.id) && m.gorevAdi === gorevAdi
    ).length;
    
    // TÃ¼m kotayÄ± bu gÃ¶reve ata
    const atanicakKota = Math.min(toplamHedef, gorevKapasite[gorevAdi] + manuelSayisi);
    personel.gorevKotalari[gorevAdi] = atanicakKota;
    
    // DiÄŸer gÃ¶revlere 0 kota
    ozelGorevler.forEach(g => {
      if (g !== gorevAdi) {
        personel.gorevKotalari[g] = 0;
      }
    });
    
    // Kapasiteden dÃ¼ÅŸ (manuel hariÃ§)
    gorevKapasite[gorevAdi] -= (atanicakKota - manuelSayisi);
  });
  
  // 2. KISITLAMASIZ KÄ°ÅÄ°LERE DENGELÄ° DAÄIT
  ozelGorevler.forEach(gorevAdi => {
    let kalan = gorevKapasite[gorevAdi];
    let guard = 0;
    
    while (kalan > 0 && guard < 10000) {
      guard++;
      
      // Uygun adaylarÄ± bul (kÄ±sÄ±tlamalÄ± kiÅŸileri hariÃ§ tut)
      const adaylar = personelListesi
        .filter(p => {
          // KÄ±sÄ±tlamalÄ± mÄ±? (baÅŸka gÃ¶reve kÄ±sÄ±tlÄ± ise bu gÃ¶reve atanamaz)
          const kisitlama = gorevKisitlamalari.find(k => String(k.personelId) === String(p.id));
          if (kisitlama) return false; // KÄ±sÄ±tlamalÄ± kiÅŸiler zaten atandÄ±
          
          // Toplam hedefi var mÄ±?
          const toplamHedef = GUN_TIPLERI.reduce((s, t) => s + (p.hedef?.[t] || 0), 0);
          if (toplamHedef === 0) return false;
          
          // Bu gÃ¶rev iÃ§in kotasÄ± toplam hedefinden az mÄ±?
          const mevcutKota = p.gorevKotalari?.[gorevAdi] || 0;
          if (mevcutKota >= toplamHedef) return false;
          
          // TÃ¼m gÃ¶revlerin toplam kotasÄ± toplam hedefi aÅŸmasÄ±n
          const toplamKota = ozelGorevler.reduce((s, g) => s + (p.gorevKotalari?.[g] || 0), 0);
          if (toplamKota >= toplamHedef) return false;
          
          return true;
        })
        .sort((a, b) => {
          // Toplam kotasÄ± az olanÄ± Ã¶ncelikle
          const kotaA = ozelGorevler.reduce((s, g) => s + (a.gorevKotalari?.[g] || 0), 0);
          const kotaB = ozelGorevler.reduce((s, g) => s + (b.gorevKotalari?.[g] || 0), 0);
          if (kotaA !== kotaB) return kotaA - kotaB;
          
          // Bu gÃ¶rev iÃ§in kotasÄ± az olanÄ± Ã¶ncelikle
          const gKotaA = a.gorevKotalari?.[gorevAdi] || 0;
          const gKotaB = b.gorevKotalari?.[gorevAdi] || 0;
          if (gKotaA !== gKotaB) return gKotaA - gKotaB;
          
          // GeÃ§miÅŸte bu gÃ¶revi az tutanÄ± Ã¶ncelikle
          const gecmisA = yillikGorevToplamHesapla(a, gorevAdi);
          const gecmisB = yillikGorevToplamHesapla(b, gorevAdi);
          return gecmisA - gecmisB;
        });
      
      if (adaylar.length === 0) break;
      
      if (!adaylar[0].gorevKotalari) adaylar[0].gorevKotalari = {};
      adaylar[0].gorevKotalari[gorevAdi] = (adaylar[0].gorevKotalari[gorevAdi] || 0) + 1;
      kalan--;
    }
  });
  
  // 3. BÄ°RLÄ°KTE GRUPLARI Ä°Ã‡Ä°N GÃ–REV KOTASI EÅÄ°TLEME
  // Birlikte tutulacak kiÅŸilerin gÃ¶rev kotalarÄ±nÄ± eÅŸitle (mazeretler uygunsa)
  const birlikteKurallarKota = kurallar.filter(k => k.tur === 'birlikte');
  birlikteKurallarKota.forEach(kural => {
    const kisiler = (kural.kisiler || []).map(id => 
      personelListesi.find(p => String(p.id) === String(id))
    ).filter(p => p);
    
    if (kisiler.length < 2) return;
    
    // KÄ±sÄ±tlamalÄ± kiÅŸi varsa eÅŸitleme yapma
    const kisitliVar = kisiler.some(p => 
      gorevKisitlamalari.some(k => String(k.personelId) === String(p.id))
    );
    if (kisitliVar) return;
    
    // Her gÃ¶rev iÃ§in grup iÃ§indeki minimum kotayÄ± bul
    ozelGorevler.forEach(gorevAdi => {
      const kotalar = kisiler.map(p => p.gorevKotalari?.[gorevAdi] || 0);
      const minKota = Math.min(...kotalar);
      const maxKota = Math.max(...kotalar);
      
      // EÅŸit deÄŸilse eÅŸitle
      if (minKota !== maxKota) {
        // Fazla kotalarÄ± hesapla (toplam korunacak)
        let fazlaKota = 0;
        kisiler.forEach(p => {
          const mevcut = p.gorevKotalari?.[gorevAdi] || 0;
          if (mevcut > minKota) {
            fazlaKota += (mevcut - minKota);
          }
        });
        
        // Herkesi minimum kotaya eÅŸitle
        kisiler.forEach(p => {
          if (!p.gorevKotalari) p.gorevKotalari = {};
          p.gorevKotalari[gorevAdi] = minKota;
        });
        
        // Fazla kotalarÄ± grup dÄ±ÅŸÄ±ndaki kiÅŸilere daÄŸÄ±t
        if (fazlaKota > 0) {
          const grupIds = kisiler.map(p => String(p.id));
          const digerAdaylar = personelListesi
            .filter(p => {
              if (grupIds.includes(String(p.id))) return false;
              const kisitlama = gorevKisitlamalari.find(k => String(k.personelId) === String(p.id));
              if (kisitlama && kisitlama.gorevAdi !== gorevAdi) return false;
              const toplamHedef = GUN_TIPLERI.reduce((s, t) => s + (p.hedef?.[t] || 0), 0);
              const toplamKota = ozelGorevler.reduce((s, g) => s + (p.gorevKotalari?.[g] || 0), 0);
              return toplamKota < toplamHedef;
            })
            .sort((a, b) => {
              const kotaA = a.gorevKotalari?.[gorevAdi] || 0;
              const kotaB = b.gorevKotalari?.[gorevAdi] || 0;
              return kotaA - kotaB;
            });
          
          for (const aday of digerAdaylar) {
            if (fazlaKota <= 0) break;
            if (!aday.gorevKotalari) aday.gorevKotalari = {};
            aday.gorevKotalari[gorevAdi] = (aday.gorevKotalari[gorevAdi] || 0) + 1;
            fazlaKota--;
          }
        }
        
        console.log(`Birlikte grup gÃ¶rev kotasÄ± eÅŸitlendi: ${kisiler.map(p=>p.ad).join(', ')} â†’ ${gorevAdi}: ${minKota}`);
      }
    });
  });
}

function hedefTablosuGuncelle() {
  const { yil, ay } = getYilAy();
  const gunSayisi = getGunSayisi(yil, ay);
  const gunluk = parseInt(document.getElementById('inp-gunluk').value) || 5;
  
  // Kapasite
  const kapasite = { hici: 0, prs: 0, cum: 0, cmt: 0, pzr: 0, toplam: 0 };
  for (let d = 1; d <= gunSayisi; d++) {
    const tip = getGunTipi(yil, ay, d);
    kapasite[tip] += gunluk;
    kapasite.toplam += gunluk;
  }
  
  // Ã–zet
  const ozetDiv = document.getElementById('hedef-ozet');
  const atananToplam = { hici: 0, prs: 0, cum: 0, cmt: 0, pzr: 0, toplam: 0 };
  personelListesi.forEach(p => {
    GUN_TIPLERI.forEach(t => {
      atananToplam[t] += p.hedef[t];
      atananToplam.toplam += p.hedef[t];
    });
  });
  
  const ortalama = Math.ceil(kapasite.toplam / Math.max(1, personelListesi.length));
  
  ozetDiv.innerHTML = `
    <span class="badge ${kapasite.toplam === atananToplam.toplam ? 'badge-ok' : 'badge-warn'}">
      Toplam: ${atananToplam.toplam} / ${kapasite.toplam}
    </span>
    <span class="badge badge-info">
      Ortalama: ${ortalama} nÃ¶bet/kiÅŸi
    </span>
    ${GUN_TIPLERI.map(t => `
      <span class="badge ${kapasite[t] === atananToplam[t] ? 'badge-ok' : 'badge-warn'}">
        ${GUN_TIPI_LABEL[t]}: ${atananToplam[t]} / ${kapasite[t]}
      </span>
    `).join('')}
  `;
  
  // Manuel atama uyarÄ±sÄ±
  const uyarilarDiv = document.getElementById('hedef-uyarilar');
  let uyariHtml = '';
  
  if (manuelAtamalar.length > 0) {
    uyariHtml += `
      <div class="rule-box" style="background:#dbeafe; border-left:4px solid #2563eb;">
        <strong>ğŸ“Œ ${manuelAtamalar.length} Manuel Atama</strong>
        <div class="help">Bu atamalar deÄŸiÅŸtirilemez ve hedef hesabÄ±na dahil edilmiÅŸtir.</div>
        <div class="mt-3">
          ${manuelAtamalar.map(m => {
            const p = personelListesi.find(x => String(x.id) === String(m.personelId));
            const tip = getGunTipi(yil, ay, m.gun);
            return `<span class="badge badge-info" style="margin:2px;">${p?.ad || '?'} â†’ ${m.gun}. gÃ¼n (${GUN_TIPI_LABEL[tip]}) - ${m.gorevAdi}</span>`;
          }).join('')}
        </div>
      </div>
    `;
  }
  
  // Fazla atama uyarÄ±sÄ±
  const fazlaAtamalar = personelListesi.filter(p => {
    const toplam = GUN_TIPLERI.reduce((s, t) => s + p.hedef[t], 0);
    const ortalama = Math.ceil(kapasite.toplam / Math.max(1, personelListesi.length));
    return toplam > ortalama + 2;
  });
  
  if (fazlaAtamalar.length > 0) {
    uyariHtml += `
      <div class="rule-box" style="background:#fef3c7; border-left:4px solid #f59e0b;">
        <strong>âš ï¸ Fazla Atama UyarÄ±sÄ±</strong>
        <div class="help">AÅŸaÄŸÄ±daki kiÅŸilere ortalamadan fazla nÃ¶bet atanmÄ±ÅŸ:</div>
        <div class="mt-3">
          ${fazlaAtamalar.map(p => {
            const toplam = GUN_TIPLERI.reduce((s, t) => s + p.hedef[t], 0);
            return `<span class="badge badge-warn" style="margin:2px;">${p.ad}: ${toplam} nÃ¶bet</span>`;
          }).join('')}
        </div>
      </div>
    `;
  }
  
  uyarilarDiv.innerHTML = uyariHtml;
  
  // Tablo
  const tbody = document.getElementById('hedef-tbody');
  const tfoot = document.getElementById('hedef-tfoot');
  tbody.innerHTML = '';
  
  personelListesi.forEach((p, idx) => {
    const toplam = GUN_TIPLERI.reduce((s, t) => s + p.hedef[t], 0);
    const saat = GUN_TIPLERI.reduce((s, t) => s + p.hedef[t] * getSaatDeger(t), 0);
    
    // WE/WD hesapla (Cuma artÄ±k WE'de)
    const weAtanan = p.hedef.cum + p.hedef.cmt + p.hedef.pzr;
    const wdAtanan = p.hedef.hici + p.hedef.prs;
    
    // YÄ±llÄ±k toplam hesapla
    const yillik = yillikToplamHesapla(p);
    const yillikToplam = GUN_TIPLERI.reduce((s, t) => s + yillik[t], 0);
    
    let durum = 'âœ…';
    let durumClass = 'badge-ok';
    
    // WE/WD denge kontrolÃ¼
    if (weAtanan === 0 && toplam > 0) {
      durum = 'âš ï¸ WE yok';
      durumClass = 'badge-warn';
    } else if (wdAtanan === 0 && toplam > 0) {
      durum = 'âš ï¸ WD yok';
      durumClass = 'badge-warn';
    }
    
    // Manuel atama ikonu
    const manuelSayisi = p.manuelAtamaSayisi || 0;
    const manuelHtml = manuelSayisi > 0 ? `<span style="color:#2563eb; margin-left:4px;" title="${manuelSayisi} manuel atama">ğŸ“Œ</span>` : '';
    
    // WE/WD badge
    const weWdHtml = `<span class="badge badge-info" style="font-size:9px; padding:2px 4px;" title="WE(Cum+Cmt+Pzr)=${weAtanan}, WD(Pzt-Per)=${wdAtanan}">WE:${weAtanan} WD:${wdAtanan}</span>`;
    
    // YÄ±llÄ±k toplam badge (az tutanlar vurgulanÄ±r)
    const yillikClass = yillikToplam < 20 ? 'badge-warn' : 'badge-info';
    const yillikHtml = `<span class="badge ${yillikClass}" style="font-size:10px; padding:2px 6px;" title="YÄ±llÄ±k toplam nÃ¶bet">ğŸ“Š ${yillikToplam}</span>`;
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="font-weight:700;">
        ${p.ad || '(isimsiz)'}${manuelHtml}
        <div style="margin-top:2px;">${weWdHtml} ${yillikHtml}</div>
      </td>
      ${GUN_TIPLERI.map(t => `
        <td class="editable-cell" onclick="hedefDuzenle(${idx}, '${t}', this)">
          ${p.hedef[t]}
        </td>
      `).join('')}
      <td><strong>${toplam}</strong></td>
      <td>${saat}s</td>
      <td><span class="badge ${durumClass}">${durum}</span></td>
    `;
    tbody.appendChild(tr);
  });
  
  // Footer
  tfoot.innerHTML = `
    <tr style="background:#f1f5f9; font-weight:700;">
      <td>TOPLAM</td>
      ${GUN_TIPLERI.map(t => `<td>${atananToplam[t]}</td>`).join('')}
      <td><strong>${atananToplam.toplam}</strong></td>
      <td>${GUN_TIPLERI.reduce((s, t) => s + atananToplam[t] * getSaatDeger(t), 0)}s</td>
      <td></td>
    </tr>
  `;
}

function hedefDuzenle(idx, tip, cell) {
  const mevcut = personelListesi[idx].hedef[tip];
  const input = document.createElement('input');
  input.type = 'number';
  input.value = mevcut;
  input.min = 0;
  input.className = 'inp-cell';
  input.style.cssText = 'width:100%; height:100%;';
  
  cell.innerHTML = '';
  cell.appendChild(input);
  input.focus();
  input.select();
  
  const kaydet = () => {
    const yeniDeger = parseInt(input.value) || 0;
    personelListesi[idx].hedef[tip] = yeniDeger;
    hedefTablosuGuncelle();
    ozelGorevSectionGuncelle(); // Toplam Hedef badge'ini gÃ¼ncelle
    kaydetDebounced();
  };
  
  input.addEventListener('blur', kaydet);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') kaydet();
    if (e.key === 'Escape') hedefTablosuGuncelle();
  });
}

function ozelGorevSectionGuncelle() {
  const ozelGorevler = getOzelGorevler();
  const section = document.getElementById('ozel-gorev-section');
  
  if (ozelGorevler.length === 0) {
    section.style.display = 'none';
    return;
  }
  
  section.style.display = 'block';
  
  const { yil, ay } = getYilAy();
  const gunSayisi = getGunSayisi(yil, ay);
  
  // VarsayÄ±lan kapasite hesapla (gÃ¼n tipi bazÄ±nda)
  const varsayilanKapasite = {};
  ozelGorevler.forEach(g => {
    const sutunSayisi = gorevSutunSayisi(g);
    varsayilanKapasite[g] = { toplam: 0, hici: 0, prs: 0, cum: 0, cmt: 0, pzr: 0 };
    
    for (let d = 1; d <= gunSayisi; d++) {
      const tip = getGunTipi(yil, ay, d);
      varsayilanKapasite[g][tip] += sutunSayisi;
      varsayilanKapasite[g].toplam += sutunSayisi;
    }
  });
  
  // Kapasite ayarlarÄ±nÄ± baÅŸlat (yoksa varsayÄ±lanÄ± kullan)
  ozelGorevler.forEach(g => {
    if (!gorevKapasiteAyar[g]) {
      gorevKapasiteAyar[g] = { ...varsayilanKapasite[g] };
    }
  });
  
  // Toplam hesapla
  const gorevToplam = {};
  ozelGorevler.forEach(g => gorevToplam[g] = 0);
  
  personelListesi.forEach(p => {
    ozelGorevler.forEach(g => {
      gorevToplam[g] += p.gorevKotalari?.[g] || 0;
    });
  });
  
  // Kapasite Ayar BÃ¶lÃ¼mÃ¼
  const kapasiteDiv = document.getElementById('gorev-kapasite-ayar');
  kapasiteDiv.innerHTML = ozelGorevler.map(g => {
    const ayar = gorevKapasiteAyar[g] || varsayilanKapasite[g];
    const vars = varsayilanKapasite[g];
    const top = gorevToplam[g];
    const cls = top === ayar.toplam ? 'badge-ok' : (top > ayar.toplam ? 'badge-bad' : 'badge-warn');
    
    return `
      <div class="rule-box" style="background:#eff6ff; border:1px solid #bfdbfe; margin-bottom:10px;">
        <div class="flex justify-between items-center">
          <strong style="color:#1e40af;">${g}</strong>
          <span class="badge ${cls}">${top} / ${ayar.toplam} atandÄ±</span>
        </div>
        <div class="form-grid mt-3" style="grid-template-columns: repeat(6, 1fr); gap:8px;">
          <div class="input-group">
            <label style="font-size:10px;">H.Ä°Ã§i (${vars.hici})</label>
            <input type="number" class="inp-cell" value="${ayar.hici}" min="0" 
              data-gorev="${g}" data-tip="hici"
              onblur="gorevKapasiteDegistir('${g}', 'hici', this.value)" style="padding:4px;">
          </div>
          <div class="input-group">
            <label style="font-size:10px;">PrÅŸ (${vars.prs})</label>
            <input type="number" class="inp-cell" value="${ayar.prs}" min="0"
              data-gorev="${g}" data-tip="prs"
              onblur="gorevKapasiteDegistir('${g}', 'prs', this.value)" style="padding:4px;">
          </div>
          <div class="input-group">
            <label style="font-size:10px;">Cum (${vars.cum})</label>
            <input type="number" class="inp-cell" value="${ayar.cum}" min="0"
              data-gorev="${g}" data-tip="cum"
              onblur="gorevKapasiteDegistir('${g}', 'cum', this.value)" style="padding:4px;">
          </div>
          <div class="input-group">
            <label style="font-size:10px;">Cmt (${vars.cmt})</label>
            <input type="number" class="inp-cell" value="${ayar.cmt}" min="0"
              data-gorev="${g}" data-tip="cmt"
              onblur="gorevKapasiteDegistir('${g}', 'cmt', this.value)" style="padding:4px;">
          </div>
          <div class="input-group">
            <label style="font-size:10px;">Pzr (${vars.pzr})</label>
            <input type="number" class="inp-cell" value="${ayar.pzr}" min="0"
              data-gorev="${g}" data-tip="pzr"
              onblur="gorevKapasiteDegistir('${g}', 'pzr', this.value)" style="padding:4px;">
          </div>
          <div class="input-group">
            <label style="font-size:10px;">TOPLAM</label>
            <input type="number" class="inp-cell" value="${ayar.toplam}" readonly 
              data-gorev="${g}" data-tip="toplam"
              style="padding:4px; background:#e2e8f0; font-weight:700;">
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  // Personel KotalarÄ± Tablosu
  const thead = document.getElementById('ozel-gorev-thead');
  const tbody = document.getElementById('ozel-gorev-tbody');
  
  thead.innerHTML = `
    <tr>
      <th>Personel</th>
      <th>Toplam Hedef</th>
      ${ozelGorevler.map(g => {
        const ayar = gorevKapasiteAyar[g] || varsayilanKapasite[g];
        const top = gorevToplam[g];
        const cls = top === ayar.toplam ? 'badge-ok' : (top > ayar.toplam ? 'badge-bad' : 'badge-warn');
        return `<th style="background:#dbeafe; color:#1e40af;">${g}<br><span class="badge ${cls}" style="font-size:9px;">${top}/${ayar.toplam}</span></th>`;
      }).join('')}
    </tr>
  `;
  
  // Footer ekle
  const table = document.getElementById('ozel-gorev-table');
  let tfoot = table.querySelector('tfoot');
  if (!tfoot) {
    tfoot = document.createElement('tfoot');
    table.appendChild(tfoot);
  }
  tfoot.innerHTML = `
    <tr style="background:#f1f5f9; font-weight:700;">
      <td>TOPLAM</td>
      <td></td>
      ${ozelGorevler.map(g => {
        const ayar = gorevKapasiteAyar[g] || varsayilanKapasite[g];
        const top = gorevToplam[g];
        return `<td data-gorev="${g}" style="color:${top === ayar.toplam ? '#16a34a' : '#f59e0b'}">${top}/${ayar.toplam}</td>`;
      }).join('')}
    </tr>
  `;
  
  tbody.innerHTML = '';
  personelListesi.forEach((p, idx) => {
    const toplamHedef = GUN_TIPLERI.reduce((s, t) => s + (p.hedef?.[t] || 0), 0);
    const toplamKota = ozelGorevler.reduce((s, g) => s + (p.gorevKotalari?.[g] || 0), 0);
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="font-weight:700;">${p.ad || '(isimsiz)'}</td>
      <td><span class="badge ${toplamKota === toplamHedef ? 'badge-ok' : 'badge-warn'}">${toplamKota}/${toplamHedef}</span></td>
      ${ozelGorevler.map(g => `
        <td style="background:#eff6ff;">
          <input type="number" class="inp-cell" value="${p.gorevKotalari?.[g] || 0}" min="0"
            style="background:#eff6ff;"
            onblur="gorevKotasiDegistir(${idx}, '${g}', this.value)">
        </td>
      `).join('')}
    `;
    tbody.appendChild(tr);
  });
}

function gorevKapasiteDegistir(gorevAdi, tip, deger) {
  if (!gorevKapasiteAyar[gorevAdi]) gorevKapasiteAyar[gorevAdi] = {};
  gorevKapasiteAyar[gorevAdi][tip] = parseInt(deger) || 0;
  
  // ToplamÄ± gÃ¼ncelle
  gorevKapasiteAyar[gorevAdi].toplam = GUN_TIPLERI.reduce((s, t) => 
    s + (gorevKapasiteAyar[gorevAdi][t] || 0), 0
  );
  
  // Sadece toplam input'unu gÃ¼ncelle (tÃ¼m section'Ä± yeniden render etme)
  const toplamInput = document.querySelector(`input[data-gorev="${gorevAdi}"][data-tip="toplam"]`);
  if (toplamInput) {
    toplamInput.value = gorevKapasiteAyar[gorevAdi].toplam;
  }
  
  kaydetDebounced();
}

function ozelGorevKotalariniYenidenDagit() {
  try {
    const ozelGorevler = getOzelGorevler();
    const { yil, ay } = getYilAy();
    const gunSayisi = getGunSayisi(yil, ay);
    
    ozelGorevKotalariniDagit(ozelGorevler, gunSayisi);
    ozelGorevSectionGuncelle();
    kaydetDebounced();
  } catch (e) {
    console.error('ozelGorevKotalariniYenidenDagit hatasÄ±:', e);
    alert('Kota daÄŸÄ±tÄ±m hatasÄ±: ' + e.message);
  }
}

function gorevKotasiDegistir(idx, gorevAdi, deger) {
  const yeniDeger = parseInt(deger) || 0;
  const p = personelListesi[idx];
  
  // GÃ¶rev kÄ±sÄ±tlama kontrolÃ¼
  const kisitlamaIdx = gorevKisitlamalari.findIndex(k => String(k.personelId) === String(p.id));
  const kisitlama = kisitlamaIdx >= 0 ? gorevKisitlamalari[kisitlamaIdx] : null;
  if (kisitlama) {
    const kisitliGorev = kisitlama.gorevAdi;
    // KÄ±sÄ±tlÄ± olduÄŸu gÃ¶revden farklÄ± bir gÃ¶reve kota atanÄ±yorsa
    if (gorevAdi !== kisitliGorev && yeniDeger > 0) {
      const uyari = `âš ï¸ ${p.ad} sadece "${kisitliGorev}" gÃ¶revine kÄ±sÄ±tlÄ±.\n\n` +
                    `"${gorevAdi}" gÃ¶revine ${yeniDeger} kota atamak istiyorsunuz.\n\n` +
                    `OnaylarsanÄ±z bu kiÅŸi iÃ§in gÃ¶rev kÄ±sÄ±tlamasÄ± KALDIRILACAK.\n` +
                    `Step 5'teki gÃ¶rev kotalarÄ±na gÃ¶re atama yapÄ±lacak.\n\n` +
                    `Devam etmek istiyor musunuz?`;
      if (!confirm(uyari)) {
        // Ä°ptal - input'u eski deÄŸere dÃ¶ndÃ¼r
        ozelGorevSectionGuncelle();
        return;
      }
      // KullanÄ±cÄ± onayladÄ± - gÃ¶rev kÄ±sÄ±tlamasÄ±nÄ± tamamen kaldÄ±r
      gorevKisitlamalari.splice(kisitlamaIdx, 1);
      console.log(`${p.ad} iÃ§in gÃ¶rev kÄ±sÄ±tlamasÄ± tamamen kaldÄ±rÄ±ldÄ±`);
      gorevKisitlamaListesiGuncelle();
    }
  }
  
  if (!p.gorevKotalari) p.gorevKotalari = {};
  p.gorevKotalari[gorevAdi] = yeniDeger;
  
  // Personel satÄ±rÄ±ndaki "Toplam Hedef" badge'ini gÃ¼ncelle
  const ozelGorevler = getOzelGorevler();
  const toplamHedef = GUN_TIPLERI.reduce((s, t) => s + (p.hedef?.[t] || 0), 0);
  const toplamKota = ozelGorevler.reduce((s, g) => s + (p.gorevKotalari?.[g] || 0), 0);
  
  const tbody = document.getElementById('ozel-gorev-tbody');
  if (tbody && tbody.rows[idx]) {
    const badge = tbody.rows[idx].querySelector('td:nth-child(2) .badge');
    if (badge) {
      badge.textContent = `${toplamKota}/${toplamHedef}`;
      badge.className = `badge ${toplamKota === toplamHedef ? 'badge-ok' : 'badge-warn'}`;
    }
  }
  
  // Footer ve header toplamlarÄ±nÄ± gÃ¼ncelle
  ozelGorevFooterGuncelle();
  kaydetDebounced();
}

// Footer ve header toplamlarÄ±nÄ± gÃ¼ncelle (tÃ¼m tabloyu yeniden render etmeden)
function ozelGorevFooterGuncelle() {
  const ozelGorevler = getOzelGorevler();
  const tfoot = document.querySelector('#ozel-gorev-table tfoot');
  const thead = document.getElementById('ozel-gorev-thead');
  
  const toplamlar = {};
  ozelGorevler.forEach(g => toplamlar[g] = 0);
  
  personelListesi.forEach(p => {
    ozelGorevler.forEach(g => {
      toplamlar[g] += p.gorevKotalari?.[g] || 0;
    });
  });
  
  // Footer gÃ¼ncelle
  if (tfoot) {
    ozelGorevler.forEach(g => {
      const td = tfoot.querySelector(`td[data-gorev="${g}"]`);
      if (td) {
        const kapasite = gorevKapasiteAyar[g]?.toplam || 0;
        td.textContent = `${toplamlar[g]}/${kapasite}`;
        td.style.color = toplamlar[g] === kapasite ? '#16a34a' : '#f59e0b';
      }
    });
  }
  
  // Header badge'lerini gÃ¼ncelle
  if (thead) {
    ozelGorevler.forEach((g, idx) => {
      const th = thead.querySelectorAll('th')[idx + 2]; // +2 Ã§Ã¼nkÃ¼ Personel ve Toplam Hedef var
      if (th) {
        const badge = th.querySelector('.badge');
        if (badge) {
          const kapasite = gorevKapasiteAyar[g]?.toplam || 0;
          badge.textContent = `${toplamlar[g]}/${kapasite}`;
          badge.className = `badge ${toplamlar[g] === kapasite ? 'badge-ok' : (toplamlar[g] > kapasite ? 'badge-bad' : 'badge-warn')}`;
        }
      }
    });
  }
  
  // Kapasite ayar bÃ¶lÃ¼mÃ¼ndeki badge'leri de gÃ¼ncelle
  ozelGorevler.forEach(g => {
    const kapasiteDiv = document.getElementById('gorev-kapasite-ayar');
    if (kapasiteDiv) {
      const badges = kapasiteDiv.querySelectorAll('.badge');
      badges.forEach(badge => {
        if (badge.closest('.rule-box')?.querySelector('strong')?.textContent === g) {
          const kapasite = gorevKapasiteAyar[g]?.toplam || 0;
          badge.textContent = `${toplamlar[g]} / ${kapasite} atandÄ±`;
          badge.className = `badge ${toplamlar[g] === kapasite ? 'badge-ok' : (toplamlar[g] > kapasite ? 'badge-bad' : 'badge-warn')}`;
        }
      });
    }
  });
}
</script>

<script>
// ============================================
// STEP 6: LÄ°STE OLUÅTURMA VE Ã–NÄ°ZLEME
// ============================================

// BUG FIX (F): Birlikte tutma kurallarÄ±nÄ± gÃ¼Ã§lendirilmiÅŸ ÅŸekilde uygula
// Hedef: Grubun minimum hedefi kadar birlikte gÃ¼n bulmaya Ã§alÄ±ÅŸ
function birlikteTutmaUygula(atanan, kisiAtama, siraliGorevler, gunSirasi) {
  const { yil, ay } = getYilAy();
  const araGun = (() => { const v = parseInt(document.getElementById('inp-aragun').value); return isNaN(v) ? 2 : v; })();
  const ozelGorevler = getOzelGorevler();
  
  const birlikteKurallar = kurallar.filter(k => k.tur === 'birlikte');
  if (birlikteKurallar.length === 0) return;
  
  // GruplarÄ± zorluÄŸa gÃ¶re sÄ±rala (en mazeretli grup Ã¶nce)
  const siraliKurallar = [...birlikteKurallar].sort((a, b) => {
    const aMazeret = (a.kisiler || []).reduce((sum, id) => {
      const p = personelListesi.find(x => x.id == id);
      return sum + (p?.mazeretler?.length || 0);
    }, 0);
    const bMazeret = (b.kisiler || []).reduce((sum, id) => {
      const p = personelListesi.find(x => x.id == id);
      return sum + (p?.mazeretler?.length || 0);
    }, 0);
    return bMazeret - aMazeret; // Ã‡ok mazeretli Ã¶nce
  });
  
  siraliKurallar.forEach(kural => {
    const grupUyeleri = (kural.kisiler || [])
      .map(id => personelListesi.find(p => p.id == id))
      .filter(p => p);
    
    if (grupUyeleri.length < 2) return;
    
    // Grubun minimum hedefi (en az hedefi olan kadar birlikte tutulabilir)
    const grupHedef = Math.min(...grupUyeleri.map(p => {
      return GUN_TIPLERI.reduce((s, t) => s + (p.hedef?.[t] || 0), 0);
    }));
    
    // Grubun birlikte tuttuÄŸu gÃ¼nleri bul
    let birlikteGunSayisi = 0;
    
    gunSirasi.forEach(({ gun }) => {
      const buGunAtananlar = Object.values(atanan[gun]).filter(pid => 
        grupUyeleri.some(p => p.id === pid)
      );
      if (buGunAtananlar.length >= 2) {
        birlikteGunSayisi++;
      }
    });
    
    // Hedef kadar birlikte gÃ¼n yoksa, daha fazla gÃ¼n bulmaya Ã§alÄ±ÅŸ
    let aramaDenemesi = 0;
    const maxDeneme = grupHedef * 2; // Sonsuz dÃ¶ngÃ¼ korumasÄ±
    
    while (birlikteGunSayisi < grupHedef && aramaDenemesi < maxDeneme) {
      aramaDenemesi++;
      let gunBulundu = false;
      
      for (const { gun, tip } of gunSirasi) {
        // Bu gÃ¼nde zaten birlikte mi?
        const buGunAtananlar = Object.values(atanan[gun]).filter(pid => 
          grupUyeleri.some(p => p.id === pid)
        );
        if (buGunAtananlar.length >= 2) continue; // Zaten birlikte
        
        // TÃ¼m grup Ã¼yeleri mÃ¼sait mi?
        const tumMusait = grupUyeleri.every(p => {
          if (p.mazeretler?.includes(gun) || p.yillikIzinler?.includes(gun) || p.nobetIzinleri?.includes(gun)) return false;
          // Ara gÃ¼n kontrolÃ¼ (bu gÃ¼n hariÃ§)
          for (const atananGun of kisiAtama[p.id].gunler) {
            if (atananGun !== gun && Math.abs(atananGun - gun) <= araGun) return false;
          }
          return true;
        });
        
        if (!tumMusait) continue;
        
        // Yeterli boÅŸ slot var mÄ±?
        const bosSlotlar = [];
        for (let i = 0; i < siraliGorevler.length; i++) {
          if (atanan[gun][i] === undefined) bosSlotlar.push(i);
        }
        
        // Zaten atanmÄ±ÅŸ Ã¼yeleri say
        const zatenAtananUyeler = grupUyeleri.filter(p => 
          Object.values(atanan[gun]).includes(p.id)
        );
        const atanacakUyeler = grupUyeleri.filter(p => 
          !Object.values(atanan[gun]).includes(p.id)
        );
        
        if (bosSlotlar.length < atanacakUyeler.length) continue;
        
        // Atanacak Ã¼yeleri bu gÃ¼ne ata
        let atamaBasarili = true;
        const geciciAtamalar = [];
        
        for (let i = 0; i < atanacakUyeler.length && i < bosSlotlar.length; i++) {
          const p = atanacakUyeler[i];
          const slotIdx = bosSlotlar[i];
          const gorev = siraliGorevler[slotIdx];
          const isOzelGorev = ozelGorevler.includes(gorev.ad);
          
          // Ã–zel gÃ¶rev kotasÄ± kontrolÃ¼
          if (isOzelGorev) {
            const kota = p.gorevKotalari?.[gorev.ad] || 0;
            if (kota === 0 || kisiAtama[p.id].gorevSayilari[gorev.ad] >= kota) {
              atamaBasarili = false;
              break;
            }
          }
          
          geciciAtamalar.push({ p, slotIdx, gorev, isOzelGorev });
        }
        
        if (atamaBasarili && geciciAtamalar.length === atanacakUyeler.length) {
          // AtamalarÄ± uygula
          geciciAtamalar.forEach(({ p, slotIdx, gorev, isOzelGorev }) => {
            if (!kisiAtama[p.id].gunler.includes(gun)) {
              atanan[gun][slotIdx] = p.id;
              kisiAtama[p.id].gunler.push(gun);
              kisiAtama[p.id].tipSayilari[tip]++;
              if (isOzelGorev) {
                kisiAtama[p.id].gorevSayilari[gorev.ad]++;
              }
            }
          });
          birlikteGunSayisi++;
          gunBulundu = true;
          break;
        }
      }
      
      if (!gunBulundu) break; // Daha fazla gÃ¼n bulunamÄ±yor
    }
  });
}

// DeÄŸiÅŸim kayÄ±tlarÄ± (global)
let gunTipiDegisimKayitlari = [];

// Python Backend URL (Firebase Functions)
const BACKEND_URL = 'https://us-central1-nobetyap-29acf.cloudfunctions.net/nobet_dagit';
const BACKEND_URL_ORTOOLS = 'https://us-central1-nobetyap-29acf.cloudfunctions.net/nobet_coz';
const BACKEND_URL_KAPASITE = 'https://us-central1-nobetyap-29acf.cloudfunctions.net/nobet_kapasite';
const BACKEND_URL_HEDEF = 'https://us-central1-nobetyap-29acf.cloudfunctions.net/nobet_hedef_hesapla';

// OR-Tools her zaman aktif (daha iyi sonuÃ§ veriyor)
const ortoolsAktif = true;

// OR-Tools ile hedef hesapla
async function hedefHesaplaOrtools() {
  const { yil, ay } = getYilAy();
  const gunSayisi = getGunSayisi(yil, ay);
  const araGun = (() => { const v = parseInt(document.getElementById('inp-aragun').value); return isNaN(v) ? 2 : v; })();
  const gunluk = parseInt(document.getElementById('inp-gunluk').value) || 5;
  
  // Saat deÄŸerlerini al
  const saatDegerleri = {
    hici: parseInt(document.getElementById('saat-hici')?.value) || 8,
    prs: parseInt(document.getElementById('saat-prs')?.value) || 8,
    cum: parseInt(document.getElementById('saat-cum')?.value) || 16,
    cmt: parseInt(document.getElementById('saat-cmt')?.value) || 24,
    pzr: parseInt(document.getElementById('saat-pzr')?.value) || 16
  };
  
  // GÃ¼n tiplerini hazÄ±rla
  const gunTipleri = {};
  for (let d = 1; d <= gunSayisi; d++) {
    gunTipleri[d] = getGunTipi(yil, ay, d);
  }
  
  // Personelleri hazÄ±rla
  const personelData = personelListesi.map(p => {
    const mazeretler = [
      ...(p.mazeretler || []),
      ...(p.yillikIzinler || []),
      ...(p.nobetIzinleri || [])
    ];
    
    // KÄ±sÄ±tlamalÄ± gÃ¶rev
    const kisitlama = gorevKisitlamalari.find(k => String(k.personelId) === String(p.id));
    
    return {
      id: p.id,
      ad: p.ad,
      mazeretler: mazeretler,
      kisitliGorev: kisitlama?.gorevAdi || null
    };
  });
  
  // GÃ¶revleri hazÄ±rla - base_name ekle
  const gorevData = gorevler.map((g, idx) => ({
    id: g.id,
    ad: g.ad,
    baseName: g.baseName || g.ad,
    exclusive: kisitlamaExclusive && gorevKisitlamalari.some(k => k.gorevAdi === g.ad || k.gorevAdi === (g.baseName || g.ad))
  }));
  
  // KurallarÄ± hazÄ±rla
  console.log('Frontend kurallar (raw):', kurallar);
  const kuralData = kurallar.map(k => {
    if (k.tur === 'birlikte') {
      console.log('Birlikte kuralÄ± bulundu:', k);
      return { tur: 'birlikte', kisiler: k.kisiler };
    } else {
      return { tur: 'ayri', kisiler: [k.p1, k.p2] };
    }
  });
  console.log('Frontend kuralData (gÃ¶nderilecek):', kuralData);
  
  // GÃ¶rev kÄ±sÄ±tlamalarÄ±nÄ± hazÄ±rla (kiÅŸi bazlÄ± exclusive dahil)
  const gorevKisitData = gorevKisitlamalari.map(k => ({
    personelId: k.personelId,
    gorevAdi: k.gorevAdi,
    exclusive: k.exclusive !== false || kisitlamaExclusive  // KiÅŸi bazlÄ± veya global
  }));
  
  // Manuel atamalarÄ± hazÄ±rla
  const manuelData = manuelAtamalar.map(m => {
    const slotById = m.gorevId !== undefined ? gorevler.findIndex(g => g.id === m.gorevId) : -1;
    const slotByAd = gorevler.findIndex(g => g.ad === m.gorevAdi);
    const slotByStored = Number.isFinite(Number(m.gorevIdx)) ? parseInt(m.gorevIdx, 10) : null;
    const slotIdx = slotById >= 0 ? slotById : (slotByAd >= 0 ? slotByAd : slotByStored);

    return {
      personelId: m.personelId,
      gun: m.gun,
      gorevId: m.gorevId,
      slotIdx: slotIdx,
      gorevIdx: slotByStored,
      gorevAdi: m.gorevAdi
    };
  });
  
  const requestData = {
    gunSayisi,
    gunTipleri,
    araGun,
    saatDegerleri,
    personeller: personelData,
    gorevler: gorevData,
    kurallar: kuralData,
    gorevKisitlamalari: gorevKisitData,
    manuelAtamalar: manuelData
  };
  
  console.log('OR-Tools hedef hesaplama isteÄŸi:', requestData);
  
  const response = await fetch(BACKEND_URL_HEDEF, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(requestData)
  });
  
  if (!response.ok) {
    throw new Error(`HTTP ${response.status}`);
  }
  
  const result = await response.json();
  console.log('OR-Tools hedef sonucu:', result);
  
  if (!result.basari) {
    throw new Error(result.mesaj || 'Hedef hesaplama baÅŸarÄ±sÄ±z');
  }
  
  return result;
}

async function listeOlustur() {
  const { yil, ay } = getYilAy();
  const gunSayisi = getGunSayisi(yil, ay);
  const araGun = (() => { const v = parseInt(document.getElementById('inp-aragun').value); return isNaN(v) ? 2 : v; })();
  const gunluk = parseInt(document.getElementById('inp-gunluk').value) || 5;
  const ozelGorevler = getOzelGorevler();
  
  // DeÄŸiÅŸim kayÄ±tlarÄ±nÄ± sÄ±fÄ±rla
  gunTipiDegisimKayitlari = [];
  
  // Loading gÃ¶ster
  const btnListeOlustur = document.querySelector('#step-6 .btn-primary');
  const originalText = btnListeOlustur.innerHTML;
  btnListeOlustur.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> OluÅŸturuluyor...';
  btnListeOlustur.disabled = true;
  
  try {
    // Hedefler hesaplanmÄ±ÅŸ mÄ± kontrol et
    const hedefBosKisi = personelListesi.filter(p => {
      const toplam = GUN_TIPLERI.reduce((s, t) => s + (p.hedef?.[t] || 0), 0);
      return toplam === 0;
    }).length;
    
    if (hedefBosKisi > personelListesi.length / 2) {
      console.log('Hedefler boÅŸ, Ã¶nce hesaplanÄ±yor...');
      // OR-Tools aktifse OR-Tools ile hesapla
      if (ortoolsAktif) {
        const basarili = await hedefleriHesaplaOrtoolsAsync();
        if (!basarili) {
          console.log('OR-Tools hedef hesaplama baÅŸarÄ±sÄ±z, yerel ile devam...');
          hedefleriHesaplaYerel();
        }
      } else {
        hedefleriHesaplaYerel();
      }
    }
    
    // OR-Tools aktifse yeni endpoint'i kullan
    if (ortoolsAktif) {
      await listeOlusturOrtools(yil, ay, gunSayisi, araGun, gunluk);
    } else {
      // Eski backend'i kullan
      await listeOlusturEskiBackend(yil, ay, gunSayisi, araGun, gunluk);
    }
    
    // Ã–nizlemeyi gÃ¼ncelle
    onizlemeGuncelle();
    
  } catch (error) {
    console.error('Backend hatasÄ±:', error);
    alert('NÃ¶bet daÄŸÄ±tÄ±mÄ± sÄ±rasÄ±nda hata oluÅŸtu: ' + error.message + '\n\nYerel algoritma ile devam ediliyor...');
    
    // Hata durumunda yerel algoritmayÄ± kullan
    listeOlusturYerel();
  } finally {
    btnListeOlustur.innerHTML = originalText;
    btnListeOlustur.disabled = false;
  }
}

// OR-Tools ile liste oluÅŸtur
async function listeOlusturOrtools(yil, ay, gunSayisi, araGun, gunluk) {
  const ozelGorevler = getOzelGorevler();
  
  // GÃ¶rev listesi - baseName Ã¶nemli!
  const gorevlerData = gorevler.map((g, idx) => ({
    id: g.id,
    ad: g.ad,
    baseName: g.ad.replace(/ #\d+$/, '') // "AMELÄ°YATHANE #1" -> "AMELÄ°YATHANE"
  }));
  
  // Personel verileri - gÃ¼n tipi hedefleri + gÃ¶rev kotalarÄ±
  const personelVerileri = personelListesi.map(p => {
    return {
      id: p.id,
      ad: p.ad,
      mazeretler: p.mazeretler || [],
      yillikIzinler: p.yillikIzinler || [],
      nobetIzinleri: p.nobetIzinleri || [],
      // GÃ¼n tipi hedefleri
      hici: p.hedef?.hici || 0,
      prs: p.hedef?.prs || 0,
      cum: p.hedef?.cum || 0,
      cmt: p.hedef?.cmt || 0,
      pzr: p.hedef?.pzr || 0,
      // GÃ¶rev kotalarÄ± (AMELÄ°YATHANE, MAVÄ° KOD, AMATEM vb.)
      gorevKotalari: p.gorevKotalari || {}
    };
  });
  
  // Kurallar
  const kurallarData = kurallar.map(k => {
    if (k.tur === 'birlikte') {
      return { tur: 'birlikte', p1: k.kisiler?.[0], p2: k.kisiler?.[1], p3: k.kisiler?.[2] };
    } else {
      return { tur: 'ayri', p1: k.p1, p2: k.p2 };
    }
  });
  
  // Manuel atamalar
  const manuelAtamalarData = manuelAtamalar.map(m => {
    const p = personelListesi.find(x => String(x.id) === String(m.personelId));
    const slotById = m.gorevId !== undefined ? gorevler.findIndex(g => g.id === m.gorevId) : -1;
    const slotByAd = gorevler.findIndex(g => g.ad === m.gorevAdi);
    const slotByStored = Number.isFinite(Number(m.gorevIdx)) ? parseInt(m.gorevIdx, 10) : null;
    const slotIdx = slotById >= 0 ? slotById : (slotByAd >= 0 ? slotByAd : slotByStored);

    return {
      personelId: m.personelId,
      personel: p?.ad || '',
      gun: m.gun,
      gorevId: m.gorevId,
      slotIdx: slotIdx,
      gorevAdi: m.gorevAdi,
      gorevIdx: slotByStored
    };
  });
  
  const requestData = {
    yil,
    ay,
    slotSayisi: gunluk,
    araGun,
    maxSure: 300, // 5 dakika
    gorevler: gorevlerData,
    personeller: personelVerileri,
    kurallar: kurallarData,
    manuelAtamalar: manuelAtamalarData,
    gorevKisitlamalari: gorevKisitlamalari,
    kisitlamaExclusive: kisitlamaExclusive,
    resmiTatiller: resmiTatiller.map(t => ({ gun: t.gun, tip: t.tip }))
  };
  
  console.log('OR-Tools isteÄŸi:', requestData);
  
  const response = await fetch(BACKEND_URL_ORTOOLS, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(requestData)
  });
  
  const result = await response.json();
  console.log('OR-Tools sonucu:', result);
  console.log('OR-Tools cizelge var mÄ±?', !!result.cizelge);
  console.log('OR-Tools cizelge keys:', result.cizelge ? Object.keys(result.cizelge) : 'YOK');
  
  if (!response.ok || result.error) {
    throw new Error(result.error || 'OR-Tools backend hatasÄ±');
  }
  
  if (!result.basari) {
    // Ã‡Ã¶zÃ¼m bulunamadÄ± - ara gÃ¼n 1 ile tekrar denenebilir mi?
    const istatistikler = result.istatistikler || {};
    if (istatistikler.ara_gun_1_dene && araGun > 1) {
      const cevap = confirm(
        `âš ï¸ OR-Tools Ã§Ã¶zÃ¼m bulamadÄ± (ara gÃ¼n: ${araGun})\n\n` +
        `Ara gÃ¼n kuralÄ±nÄ± 1'e dÃ¼ÅŸÃ¼rerek tekrar denemek ister misiniz?\n\n` +
        `(HayÄ±r derseniz yerel algoritma ile devam edilecek)`
      );
      
      if (cevap) {
        console.log('Ara gÃ¼n 1 ile tekrar deneniyor...');
        // Ara gÃ¼n 1 ile tekrar dene
        return await listeOlusturOrtools(yil, ay, gunSayisi, 1, gunluk);
      }
    }
    throw new Error(result.mesaj || 'OR-Tools Ã§Ã¶zÃ¼m bulamadÄ±');
  }
  
  // SonuÃ§larÄ± iÅŸle
  console.log('isleOrtoolsSonucu Ã§aÄŸrÄ±lÄ±yor...');
  hesaplananListe = isleOrtoolsSonucu(result, gunSayisi);
  console.log('hesaplananListe:', hesaplananListe);
  console.log('hesaplananListe.atanan[1]:', hesaplananListe?.atanan?.[1]);
  
  // Ä°statistikleri gÃ¶ster
  if (result.istatistikler) {
    console.log('OR-Tools Ä°statistikleri:', result.istatistikler);
    console.log(`Ã‡Ã¶zÃ¼m sÃ¼resi: ${result.sureMs}ms`);
    console.log(`Doluluk: %${result.istatistikler.doluluk_yuzde}`);
    console.log(`Denge farkÄ±: ${result.istatistikler.denge_farki}`);
  }
  
  // Devir listesi (eksik atamalar)
  devirListesi = [];
  if (result.istatistikler?.kisi_detay) {
    result.istatistikler.kisi_detay.forEach(k => {
      const p = personelListesi.find(x => x.id === k.personel_id);
      if (p) {
        const hedefToplam = GUN_TIPLERI.reduce((s, t) => s + (p.hedef?.[t] || 0), 0);
        const fark = hedefToplam - k.toplam;
        if (fark > 0) {
          devirListesi.push({
            personel: k.personel_ad,
            tip: 'Toplam',
            eksik: fark,
            sebep: 'KÄ±sÄ±t Ã§akÄ±ÅŸmasÄ±'
          });
        }
      }
    });
  }
}

// OR-Tools sonucunu iÅŸle
function isleOrtoolsSonucu(result, gunSayisi) {
  const siraliGorevler = [...gorevler]; // SÄ±ralama kaldÄ±rÄ±ldÄ± - slot kÄ±tlÄ±k aÄŸÄ±rlÄ±ÄŸÄ± OR-Tools'da
  const ozelGorevler = getOzelGorevler();
  
  console.log('=== isleOrtoolsSonucu DEBUG ===');
  console.log('result.cizelge:', result.cizelge);
  console.log('gunSayisi:', gunSayisi);
  console.log('siraliGorevler:', siraliGorevler.map(g => g.ad));
  console.log('personelListesi:', personelListesi.map(p => p.ad));
  
  // Atanan yapÄ±sÄ±nÄ± oluÅŸtur
  const atanan = {};
  let toplamAtama = 0;
  
  for (let d = 1; d <= gunSayisi; d++) {
    atanan[d] = {};
    const gunAtamalari = result.cizelge?.[String(d)] || result.cizelge?.[d] || [];
    
    if (d <= 3) {
      console.log(`GÃ¼n ${d} atamalarÄ±:`, gunAtamalari);
    }
    
    gunAtamalari.forEach((isim, idx) => {
      if (isim && isim !== '-' && isim !== null) {
        const p = personelListesi.find(x => x.ad === isim);
        if (p) {
          atanan[d][idx] = p.id;
          toplamAtama++;
        } else {
          console.warn(`Personel bulunamadÄ±: "${isim}"`);
        }
      }
    });
  }
  
  console.log('Toplam atama sayÄ±sÄ±:', toplamAtama);
  
  // KiÅŸi atama bilgilerini oluÅŸtur
  const kisiAtama = {};
  personelListesi.forEach(p => {
    kisiAtama[p.id] = {
      gunler: [],
      tipSayilari: { hici: 0, prs: 0, cum: 0, cmt: 0, pzr: 0 },
      hedefKalan: { ...p.hedef },
      gorevSayilari: {}
    };
    ozelGorevler.forEach(g => kisiAtama[p.id].gorevSayilari[g] = 0);
  });
  
  // Atamalardan kiÅŸi bilgilerini gÃ¼ncelle
  const { yil, ay } = getYilAy();
  for (let d = 1; d <= gunSayisi; d++) {
    const tip = getGunTipi(yil, ay, d);
    for (const [slotIdx, pid] of Object.entries(atanan[d])) {
      if (kisiAtama[pid]) {
        kisiAtama[pid].gunler.push(d);
        kisiAtama[pid].tipSayilari[tip]++;
        if (kisiAtama[pid].hedefKalan[tip] > 0) {
          kisiAtama[pid].hedefKalan[tip]--;
        }
        
        const gorev = siraliGorevler[parseInt(slotIdx)];
        if (gorev && ozelGorevler.includes(gorev.ad)) {
          kisiAtama[pid].gorevSayilari[gorev.ad]++;
        }
      }
    }
  }
  
  return { atanan, kisiAtama, siraliGorevler };
}

// Eski backend ile liste oluÅŸtur
async function listeOlusturEskiBackend(yil, ay, gunSayisi, araGun, gunluk) {
  const ozelGorevler = getOzelGorevler();
  
  // GÃ¶rev tanÄ±mlarÄ±
  const gorevTanimlari = gorevler.map((g, idx) => ({
    id: g.id,
    ad: g.ad,
    baseName: g.ad.replace(/ #\d+$/, '') // "Mavi Kod #1" -> "Mavi Kod"
  }));
  
  // Personel verileri
  const personelVerileri = personelListesi.map(p => {
    // YÄ±llÄ±k toplam hesapla
    const yillik = yillikToplamHesapla(p);
    const yillikToplam = GUN_TIPLERI.reduce((s, t) => s + yillik[t], 0);
    
    return {
      id: p.id,
      ad: p.ad,
      hici: p.hedef?.hici || 0,
      prs: p.hedef?.prs || 0,
      cum: p.hedef?.cum || 0,
      cmt: p.hedef?.cmt || 0,
      pzr: p.hedef?.pzr || 0,
      gorevKotalari: p.gorevKotalari || {},
      mazeretler: p.mazeretler || [],
      yillikIzinler: p.yillikIzinler || [],
      nobetIzinleri: p.nobetIzinleri || [],
      yillikToplam: yillikToplam,
      devir: {} // Devir bilgisi (ÅŸimdilik boÅŸ)
    };
  });
  
  // Kurallar
  const kurallarData = kurallar.map(k => {
    if (k.tur === 'birlikte') {
      const kisiler = k.kisiler || [];
      return {
        tur: 'birlikte',
        p1: personelListesi.find(p => p.id == kisiler[0])?.ad || '',
        p2: personelListesi.find(p => p.id == kisiler[1])?.ad || '',
        p3: personelListesi.find(p => p.id == kisiler[2])?.ad || ''
      };
    } else {
      return {
        tur: 'ayri',
        p1: personelListesi.find(p => p.id == k.p1)?.ad || '',
        p2: personelListesi.find(p => p.id == k.p2)?.ad || ''
      };
    }
  });
  
  // Manuel atamalar
  const manuelAtamalarData = manuelAtamalar.map(m => {
    const p = personelListesi.find(x => String(x.id) === String(m.personelId));
    return {
      personel: p?.ad || '',
      gun: m.gun,
      gorevId: m.gorevId,      // BUG FIX (A): gorevId ekle
      gorevIdx: m.gorevIdx,    // Geriye uyumluluk
      gorevAdi: m.gorevAdi     // Alternatif eÅŸleÅŸme iÃ§in
    };
  });
  
  // GÃ¶rev kÄ±sÄ±tlamalarÄ±
  const gorevKisitlamalariData = gorevKisitlamalari.map(k => ({
    personelId: k.personelId,
    gorevAdi: k.gorevAdi
  }));
  
  return {
    yil,
    ay,
    gunlukSayi: gunluk,
    araGun,
    gorevTanimlari,
    personeller: personelVerileri,
    kurallar: kurallarData,
    manuelAtamalar: manuelAtamalarData,
    gorevKisitlamalari: gorevKisitlamalariData,
    resmiTatiller: resmiTatiller.map(t => ({ gun: t.gun, tip: t.tip }))
  };
}

function isleBackendSonucu(result, gunSayisi) {
  const siraliGorevler = [...gorevler]; // SÄ±ralama kaldÄ±rÄ±ldÄ± - slot kÄ±tlÄ±k aÄŸÄ±rlÄ±ÄŸÄ± OR-Tools'da
  const ozelGorevler = getOzelGorevler();
  
  // Atanan yapÄ±sÄ±nÄ± oluÅŸtur
  const atanan = {};
  for (let d = 1; d <= gunSayisi; d++) {
    atanan[d] = {};
    const gunAtamalari = result.cizelge[String(d)] || [];
    gunAtamalari.forEach((isim, idx) => {
      if (isim && isim !== '-') {
        const p = personelListesi.find(x => x.ad === isim);
        if (p) {
          atanan[d][idx] = p.id;
        }
      }
    });
  }
  
  // KiÅŸi atama bilgilerini oluÅŸtur
  const kisiAtama = {};
  personelListesi.forEach(p => {
    const ozet = result.kisiOzet?.find(k => k.ad === p.ad);
    kisiAtama[p.id] = {
      gunler: [],
      tipSayilari: { hici: 0, prs: 0, cum: 0, cmt: 0, pzr: 0 },
      hedefKalan: {
        hici: ozet?.kalanHici || 0,
        prs: ozet?.kalanPrs || 0,
        cum: ozet?.kalanCum || 0,
        cmt: ozet?.kalanCmt || 0,
        pzr: ozet?.kalanPzr || 0
      },
      gorevSayilari: {}
    };
    ozelGorevler.forEach(g => kisiAtama[p.id].gorevSayilari[g] = 0);
  });
  
  // Atamalardan kiÅŸi bilgilerini gÃ¼ncelle
  const { yil, ay } = getYilAy();
  for (let d = 1; d <= gunSayisi; d++) {
    const tip = getGunTipi(yil, ay, d);
    for (const [slotIdx, pid] of Object.entries(atanan[d])) {
      if (kisiAtama[pid]) {
        kisiAtama[pid].gunler.push(d);
        kisiAtama[pid].tipSayilari[tip]++;
        
        const gorev = siraliGorevler[parseInt(slotIdx)];
        if (gorev && ozelGorevler.includes(gorev.ad)) {
          kisiAtama[pid].gorevSayilari[gorev.ad]++;
        }
      }
    }
  }
  
  return { atanan, kisiAtama, siraliGorevler };
}

// Yerel algoritma (VBA mantÄ±ÄŸÄ± ile)
function listeOlusturYerel() {
  const { yil, ay } = getYilAy();
  const gunSayisi = getGunSayisi(yil, ay);
  const araGun = (() => { const v = parseInt(document.getElementById('inp-aragun').value); return isNaN(v) ? 2 : v; })();
  const ozelGorevler = getOzelGorevler();
  
  // SÄ±ralÄ± gÃ¶revler
  const siraliGorevler = [...gorevler]; // SÄ±ralama kaldÄ±rÄ±ldÄ± - slot kÄ±tlÄ±k aÄŸÄ±rlÄ±ÄŸÄ± OR-Tools'da
  
  // BaÅŸlangÄ±Ã§ durumu
  const atanan = {}; // { gun: { slotIdx: personelId } }
  const kisiAtama = {}; // { personelId: { gunler: [], tipSayilari: {}, gorevSayilari: {}, manuelSayisi: 0 } }
  
  for (let d = 1; d <= gunSayisi; d++) {
    atanan[d] = {};
  }
  
  // DEBUG: Hedefleri kontrol et
  console.log('=== YEREL DAÄITIM BAÅLIYOR ===');
  let hedefBosKisi = 0;
  personelListesi.forEach(p => {
    const hedefToplam = GUN_TIPLERI.reduce((s, t) => s + (p.hedef?.[t] || 0), 0);
    if (hedefToplam === 0) {
      hedefBosKisi++;
      console.warn(`${p.ad} hedefi boÅŸ!`, p.hedef);
    }
  });
  if (hedefBosKisi > 0) {
    console.error(`âš ï¸ ${hedefBosKisi} kiÅŸinin hedefi boÅŸ! Ã–nce Step 5'te hedef hesaplayÄ±n.`);
  }
  
  personelListesi.forEach(p => {
    // Hedef boÅŸsa varsayÄ±lan deÄŸer ata
    const hedef = p.hedef && Object.keys(p.hedef).length > 0 ? { ...p.hedef } : { hici: 1, prs: 1, cum: 1, cmt: 1, pzr: 0 };
    
    kisiAtama[p.id] = {
      gunler: [],
      tipSayilari: { hici: 0, prs: 0, cum: 0, cmt: 0, pzr: 0 },
      hedefKalan: hedef,
      gorevSayilari: {},
      manuelSayisi: 0
    };
    ozelGorevler.forEach(g => kisiAtama[p.id].gorevSayilari[g] = 0);
  });
  
  // KÄ±sÄ±tlamalÄ± kiÅŸilerin gÃ¶rev haritasÄ±
  const kisitlamaMap = {};
  gorevKisitlamalari.forEach(k => {
    kisitlamaMap[String(k.personelId)] = k.gorevAdi;
  });
  
  // BÄ°RLÄ°KTE TUTULACAKLAR HARÄ°TASI
  const birlikteMap = {}; // { personelId: [partnerId1, partnerId2, ...] }
  const birlikteKurallarYerel = kurallar.filter(k => k.tur === 'birlikte');
  birlikteKurallarYerel.forEach(kural => {
    const kisiler = kural.kisiler || [];
    kisiler.forEach(id => {
      if (!birlikteMap[String(id)]) birlikteMap[String(id)] = [];
      kisiler.forEach(partnerId => {
        if (partnerId !== id && !birlikteMap[String(id)].includes(partnerId)) {
          birlikteMap[String(id)].push(partnerId);
        }
      });
    });
  });
  
  // ============================================
  // BÄ°RLÄ°KTE TUTULACAKLARIN ORTAK GÃœNLERÄ°NÄ° HESAPLA
  // ============================================
  const birlikteGrupBilgileriYerel = [];
  
  birlikteKurallarYerel.forEach(kural => {
    const kisilerIds = kural.kisiler || [];
    const kisiler = kisilerIds.map(id => personelListesi.find(p => String(p.id) === String(id))).filter(Boolean);
    
    if (kisiler.length < 2) return;
    
    // Ortak mÃ¼sait gÃ¼nleri hesapla
    const ortakMusaitlik = ortakMusaitlikHesapla(kisiler, gunSayisi, yil, ay);
    
    // Grubun minimum hedefi
    const ortalamaNobet = Math.ceil((gunSayisi * parseInt(document.getElementById('inp-gunluk').value || 5)) / personelListesi.length);
    const minHedef = Math.min(ortalamaNobet, ortakMusaitlik.toplamOrtakGun);
    
    // WE/WD dengesini koru
    const ortakWEGunleri = [...ortakMusaitlik.ortakGunler.cum, ...ortakMusaitlik.ortakGunler.cmt, ...ortakMusaitlik.ortakGunler.pzr];
    const ortakWDGunleri = [...ortakMusaitlik.ortakGunler.hici, ...ortakMusaitlik.ortakGunler.prs];
    
    const hedefWE = Math.min(Math.ceil(minHedef / 2), ortakWEGunleri.length);
    const hedefWD = Math.min(minHedef - hedefWE, ortakWDGunleri.length);
    
    // HER GÃœN Ä°Ã‡Ä°N MAZERETLÄ° KÄ°ÅÄ° SAYISINI HESAPLA
    // Ã‡ok mazeretli gÃ¼n = az kiÅŸi mÃ¼sait = o gÃ¼ne birlikte grubu atamak mantÄ±klÄ±
    function gunMazeretSayisiYerel(gun) {
      return personelListesi.filter(p => 
        p.mazeretler?.includes(gun) || p.yillikIzinler?.includes(gun) || p.nobetIzinleri?.includes(gun)
      ).length;
    }
    
    // Rezerve gÃ¼nleri seÃ§ - EN Ã‡OK MAZERETLÄ° GÃœNLER Ã–NCE (grup mÃ¼saitse)
    const rezerveGunler = [];
    
    // WE gÃ¼nlerini mazeretli sayÄ±sÄ±na gÃ¶re sÄ±rala (Ã§ok mazeretli Ã¶nce)
    const weGunleriSirali = ortakWEGunleri
      .map(gun => ({ gun, mazeretli: gunMazeretSayisiYerel(gun) }))
      .sort((a, b) => b.mazeretli - a.mazeretli)
      .map(x => x.gun);
    
    for (let i = 0; i < hedefWE && i < weGunleriSirali.length; i++) {
      rezerveGunler.push(weGunleriSirali[i]);
    }
    
    // WD gÃ¼nlerini mazeretli sayÄ±sÄ±na gÃ¶re sÄ±rala (Ã§ok mazeretli Ã¶nce)
    const wdGunleriSirali = ortakWDGunleri
      .map(gun => ({ gun, mazeretli: gunMazeretSayisiYerel(gun) }))
      .sort((a, b) => b.mazeretli - a.mazeretli)
      .map(x => x.gun);
    
    for (let i = 0; i < hedefWD && i < wdGunleriSirali.length; i++) {
      rezerveGunler.push(wdGunleriSirali[i]);
    }
    
    birlikteGrupBilgileriYerel.push({
      kisiler,
      kisilerIds,
      ortakMusaitlik,
      minHedef,
      hedefWE,
      hedefWD,
      rezerveGunler
    });
    
    console.log(`[Yerel] Birlikte grup: ${kisiler.map(p => p.ad).join(' + ')} â†’ Ortak gÃ¼n: ${ortakMusaitlik.toplamOrtakGun}, Hedef: ${minHedef}, Rezerve: ${rezerveGunler.join(',')}`);
  });
  
  // 1. Ã–NCE MANUEL ATAMALARI YAP
  manuelAtamalar.forEach(m => {
    if (m.gun < 1 || m.gun > gunSayisi) return;
    
    const p = personelListesi.find(x => String(x.id) === String(m.personelId));
    if (!p) return;
    
    let slotIdx = -1;
    if (m.gorevId !== undefined) {
      slotIdx = siraliGorevler.findIndex(g => g.id === m.gorevId);
    }
    if (slotIdx === -1 && m.gorevIdx !== undefined) {
      if (m.gorevAdi) {
        slotIdx = siraliGorevler.findIndex(g => g.ad === m.gorevAdi);
      }
      if (slotIdx === -1) {
        slotIdx = m.gorevIdx;
      }
    }
    
    if (slotIdx < 0 || slotIdx >= siraliGorevler.length) return;
    
    const gorev = siraliGorevler[slotIdx];
    const isOzelGorev = gorev && ozelGorevler.includes(gorev.ad);
    const tip = getGunTipi(yil, ay, m.gun);
    
    atanan[m.gun][slotIdx] = p.id;
    if (!kisiAtama[p.id].gunler.includes(m.gun)) {
      kisiAtama[p.id].gunler.push(m.gun);
    }
    kisiAtama[p.id].tipSayilari[tip]++;
    kisiAtama[p.id].hedefKalan[tip] = Math.max(0, kisiAtama[p.id].hedefKalan[tip] - 1);
    kisiAtama[p.id].manuelSayisi++;
    
    if (isOzelGorev) {
      kisiAtama[p.id].gorevSayilari[gorev.ad]++;
    }
  });
  
  // VBA MANTIÄI: GÃ¼nleri zorluÄŸa gÃ¶re sÄ±rala + mazeretli kiÅŸi sayÄ±sÄ±na gÃ¶re
  const gunSirasi = [];
  for (let d = 1; d <= gunSayisi; d++) {
    const tip = getGunTipi(yil, ay, d);
    const zorluk = { cmt: 5, pzr: 4, cum: 4, prs: 2, hici: 2 }[tip];
    
    // Bu gÃ¼nde kaÃ§ kiÅŸi mazeretli?
    const mazeretliSayisi = personelListesi.filter(p => 
      p.mazeretler?.includes(d) || p.yillikIzinler?.includes(d) || p.nobetIzinleri?.includes(d)
    ).length;
    
    gunSirasi.push({ gun: d, tip, zorluk, mazeretliSayisi });
  }
  // Ã–nce zorluk, sonra mazeretli sayÄ±sÄ± (Ã§ok mazeretli = daha zor)
  gunSirasi.sort((a, b) => {
    if (b.zorluk !== a.zorluk) return b.zorluk - a.zorluk;
    return b.mazeretliSayisi - a.mazeretliSayisi;
  });
  
  // KÄ°ÅÄ°LERÄ°N MAZERET SAYISINI HESAPLA (en Ã§ok mazeretli = en zor yerleÅŸtirmek)
  const kisiMazeretSayisi = {};
  personelListesi.forEach(p => {
    const mazeretler = (p.mazeretler?.length || 0) + (p.yillikIzinler?.length || 0) + (p.nobetIzinleri?.length || 0);
    kisiMazeretSayisi[p.id] = mazeretler;
  });
  
  // KiÅŸinin belirli bir gÃ¼nde atanabilir olup olmadÄ±ÄŸÄ±nÄ± kontrol et
  function kisiAtanabilirMi(p, gun, gorev, isOzelGorev, mevcutAraGun = araGun) {
    if (Object.values(atanan[gun]).includes(p.id)) return false;
    if (p.mazeretler?.includes(gun) || p.yillikIzinler?.includes(gun) || p.nobetIzinleri?.includes(gun)) return false;
    
    // Ara gÃ¼n kontrolÃ¼ (minimum 1 gÃ¼n ara ZORUNLU)
    for (const atananGun of kisiAtama[p.id].gunler) {
      if (Math.abs(atananGun - gun) <= mevcutAraGun) return false;
    }
    
    const kisitliGorev = kisitlamaMap[String(p.id)];
    if (kisitliGorev && gorev.ad !== kisitliGorev) return false;
    
    if (isOzelGorev) {
      const kota = p.gorevKotalari?.[gorev.ad] || 0;
      if (kota === 0) return false;
      if (kisiAtama[p.id].gorevSayilari[gorev.ad] >= kota) return false;
    }
    
    for (const kural of kurallar.filter(k => k.tur === 'ayri')) {
      if (String(kural.p1) === String(p.id) || String(kural.p2) === String(p.id)) {
        const diger = String(kural.p1) === String(p.id) ? kural.p2 : kural.p1;
        const bugunAtananlar = Object.values(atanan[gun]).map(id => String(id));
        if (bugunAtananlar.includes(String(diger))) return false;
      }
    }
    
    return true;
  }
  
  function kalanHedefTipleri(p) {
    return GUN_TIPLERI.filter(tip => kisiAtama[p.id].hedefKalan[tip] > 0);
  }
  
  // VBA MANTIÄI: KiÅŸileri zorluÄŸa gÃ¶re sÄ±rala
  // En zor kiÅŸi = en az boÅŸ gÃ¼nÃ¼ kalan + en Ã§ok hedefi kalan + en Ã§ok mazeretli
  function kisiZorlukHesapla(p, gun, tip) {
    const kalanHedef = GUN_TIPLERI.reduce((s, t) => s + kisiAtama[p.id].hedefKalan[t], 0);
    const mazeretSayisi = kisiMazeretSayisi[p.id] || 0;
    
    // Kalan mÃ¼sait gÃ¼n sayÄ±sÄ±nÄ± hesapla (ara gÃ¼n kuralÄ± dahil)
    let kalanMusaitGun = 0;
    for (let d = 1; d <= gunSayisi; d++) {
      if (kisiAtama[p.id].gunler.includes(d)) continue;
      if (p.mazeretler?.includes(d) || p.yillikIzinler?.includes(d) || p.nobetIzinleri?.includes(d)) continue;
      
      let araGunUygun = true;
      for (const atananGun of kisiAtama[p.id].gunler) {
        if (Math.abs(atananGun - d) <= araGun) {
          araGunUygun = false;
          break;
        }
      }
      if (araGunUygun) kalanMusaitGun++;
    }
    
    // Zorluk = (kalanHedef / kalanMusaitGun) + mazeret bonusu
    // YÃ¼ksek = daha zor yerleÅŸtirmek
    const temelZorluk = kalanMusaitGun > 0 ? kalanHedef / kalanMusaitGun : 999;
    const mazeretBonus = mazeretSayisi / gunSayisi; // 0-1 arasÄ±
    const zorluk = temelZorluk + mazeretBonus;
    
    return {
      zorluk,
      kalanHedef,
      kalanMusaitGun,
      mazeretSayisi,
      tipHedef: kisiAtama[p.id].hedefKalan[tip]
    };
  }
  
  // 2. BÄ°RLÄ°KTE TUTULACAKLARI REZERVE GÃœNLERE YERLEÅTÄ°R (YENÄ° MANTIK)
  birlikteGrupBilgileriYerel.forEach(grupBilgi => {
    const { kisiler, rezerveGunler } = grupBilgi;
    
    rezerveGunler.forEach(gun => {
      const tip = getGunTipi(yil, ay, gun);
      
      // Bu gÃ¼nde yeterli boÅŸ slot var mÄ±?
      const bosSlotlar = [];
      for (let i = 0; i < siraliGorevler.length; i++) {
        if (atanan[gun][i] === undefined) bosSlotlar.push(i);
      }
      
      if (bosSlotlar.length < kisiler.length) return;
      
      // TÃ¼m kiÅŸiler bu gÃ¼ne atanabilir mi?
      const hepsiAtanabilir = kisiler.every(p => {
        // Zaten bu gÃ¼ne atanmÄ±ÅŸ mÄ±?
        if (Object.values(atanan[gun]).includes(p.id)) return true;
        
        // Mazeret kontrolÃ¼
        if (p.mazeretler?.includes(gun) || p.yillikIzinler?.includes(gun) || p.nobetIzinleri?.includes(gun)) return false;
        
        // Ara gÃ¼n kontrolÃ¼
        for (const atananGun of kisiAtama[p.id].gunler) {
          if (Math.abs(atananGun - gun) <= araGun) return false;
        }
        return true;
      });
      
      if (!hepsiAtanabilir) return;
      
      // Grubu bu gÃ¼ne ata
      let slotIdx = 0;
      kisiler.forEach(p => {
        // Zaten bu gÃ¼ne atanmÄ±ÅŸ mÄ±?
        if (Object.values(atanan[gun]).includes(p.id)) return;
        
        // BoÅŸ slot bul
        while (slotIdx < bosSlotlar.length && atanan[gun][bosSlotlar[slotIdx]] !== undefined) {
          slotIdx++;
        }
        if (slotIdx >= bosSlotlar.length) return;
        
        const slot = bosSlotlar[slotIdx];
        const gorev = siraliGorevler[slot];
        const isOzelGorev = ozelGorevler.includes(gorev.ad);
        
        atanan[gun][slot] = p.id;
        if (!kisiAtama[p.id].gunler.includes(gun)) {
          kisiAtama[p.id].gunler.push(gun);
        }
        kisiAtama[p.id].tipSayilari[tip]++;
        
        if (kisiAtama[p.id].hedefKalan[tip] > 0) {
          kisiAtama[p.id].hedefKalan[tip]--;
        } else {
          for (const altTip of GUN_TIPLERI) {
            if (kisiAtama[p.id].hedefKalan[altTip] > 0) {
              kisiAtama[p.id].hedefKalan[altTip]--;
              gunTipiDegisimKayitlari.push({
                personel: p.ad, personelId: p.id, gun,
                orijinalTip: GUN_TIPI_LABEL[altTip], yeniTip: GUN_TIPI_LABEL[tip]
              });
              break;
            }
          }
        }
        
        if (isOzelGorev) {
          kisiAtama[p.id].gorevSayilari[gorev.ad]++;
        }
        
        slotIdx++;
      });
      
      console.log(`[Yerel] Birlikte grup ${kisiler.map(p => p.ad).join('+')} â†’ GÃ¼n ${gun} (${tip}) atandÄ±`);
    });
  });
  
  // 3. ANA DAÄITIM - VBA MANTIÄI (AÅŸamalÄ± ara gÃ¼n gevÅŸetme)
  
  // Her gÃ¶revin kaÃ§ sÃ¼tunu olduÄŸunu hesapla
  const gorevSutunSayilari = {};
  siraliGorevler.forEach(g => {
    gorevSutunSayilari[g.ad] = (gorevSutunSayilari[g.ad] || 0) + 1;
  });
  
  // TEK SÃœTUNLU GÃ–REVLERÄ° Ã–NCE YERLEÅTÄ°R (alternatif yok!)
  const tekSutunluGorevler = siraliGorevler
    .map((g, idx) => ({ ...g, slotIdx: idx }))
    .filter(g => gorevSutunSayilari[g.ad] === 1);
  
  const cokSutunluGorevler = siraliGorevler
    .map((g, idx) => ({ ...g, slotIdx: idx }))
    .filter(g => gorevSutunSayilari[g.ad] > 1);
  
  const araGunAsamalari = [araGun];
  if (araGun > 1) araGunAsamalari.push(Math.max(1, araGun - 1));
  if (araGun > 2) araGunAsamalari.push(1);
  
  // AÅAMA 3A: Tek sÃ¼tunlu gÃ¶revleri Ã¶nce yerleÅŸtir
  for (const mevcutAraGun of araGunAsamalari) {
    gunSirasi.forEach(({ gun, tip }) => {
      tekSutunluGorevler.forEach(gorev => {
        const slotIdx = gorev.slotIdx;
        if (atanan[gun][slotIdx] !== undefined) return;
        
        const isOzelGorev = ozelGorevler.includes(gorev.ad);
        
        let adaylar = personelListesi.filter(p => {
          if (!kisiAtanabilirMi(p, gun, gorev, isOzelGorev, mevcutAraGun)) return false;
          return kisiAtama[p.id].hedefKalan[tip] > 0 || kalanHedefTipleri(p).length > 0;
        });
        
        if (adaylar.length === 0) return;
        
        // Bu gÃ¼ne zaten atanmÄ±ÅŸ kiÅŸileri bul (birlikte tutma iÃ§in) - string'e Ã§evir
        const buGunAtananlar = Object.values(atanan[gun]).map(id => String(id));
        
        // VBA MANTIÄI: En zor kiÅŸiden baÅŸla + BÄ°RLÄ°KTE TUTMA Ã–NCELÄ°ÄÄ°
        adaylar.sort((a, b) => {
          // 1. BÄ°RLÄ°KTE TUTMA: Partneri bu gÃ¼ne atanmÄ±ÅŸsa Ã¶ncelik ver
          const aPartnerler = birlikteMap[String(a.id)] || [];
          const bPartnerler = birlikteMap[String(b.id)] || [];
          const aPartnerBuGunde = aPartnerler.some(pid => buGunAtananlar.includes(String(pid)));
          const bPartnerBuGunde = bPartnerler.some(pid => buGunAtananlar.includes(String(pid)));
          if (aPartnerBuGunde !== bPartnerBuGunde) return aPartnerBuGunde ? -1 : 1;
          
          // 2. Zorluk hesabÄ±
          const aZorluk = kisiZorlukHesapla(a, gun, tip);
          const bZorluk = kisiZorlukHesapla(b, gun, tip);
          if (bZorluk.zorluk !== aZorluk.zorluk) return bZorluk.zorluk - aZorluk.zorluk;
          return aZorluk.kalanHedef - bZorluk.kalanHedef;
        });
        
        const secilen = adaylar[0];
        atanan[gun][slotIdx] = secilen.id;
        if (!kisiAtama[secilen.id].gunler.includes(gun)) {
          kisiAtama[secilen.id].gunler.push(gun);
        }
        kisiAtama[secilen.id].tipSayilari[tip]++;
        
        // Hedef kalanÄ± gÃ¼ncelle
        if (kisiAtama[secilen.id].hedefKalan[tip] > 0) {
          kisiAtama[secilen.id].hedefKalan[tip]--;
        } else {
          for (const altTip of GUN_TIPLERI) {
            if (kisiAtama[secilen.id].hedefKalan[altTip] > 0) {
              kisiAtama[secilen.id].hedefKalan[altTip]--;
              gunTipiDegisimKayitlari.push({
                personel: secilen.ad, personelId: secilen.id, gun,
                orijinalTip: GUN_TIPI_LABEL[altTip], yeniTip: GUN_TIPI_LABEL[tip]
              });
              break;
            }
          }
        }
        
        if (isOzelGorev) {
          kisiAtama[secilen.id].gorevSayilari[gorev.ad]++;
        }
      });
    });
  }
  
  // AÅAMA 3B: Ã‡ok sÃ¼tunlu gÃ¶revleri yerleÅŸtir
  for (const mevcutAraGun of araGunAsamalari) {
    gunSirasi.forEach(({ gun, tip }) => {
      cokSutunluGorevler.forEach(gorev => {
        const slotIdx = gorev.slotIdx;
        if (atanan[gun][slotIdx] !== undefined) return;
        
        const isOzelGorev = ozelGorevler.includes(gorev.ad);
        
        // AÅAMA 1: Bu gÃ¼n tipinde hedefi olan kiÅŸileri bul
        let adaylar = personelListesi.filter(p => {
          if (!kisiAtanabilirMi(p, gun, gorev, isOzelGorev, mevcutAraGun)) return false;
          return kisiAtama[p.id].hedefKalan[tip] > 0;
        });
        
        // AÅAMA 2: Alternatif gÃ¼n tipinde hedefi olanlarÄ± bul
        let degisimYapildi = null;
        if (adaylar.length === 0) {
          const alternatifler = GUN_TIPI_ALTERNATIFLERI[tip] || [];
          
          for (const altTip of alternatifler) {
            adaylar = personelListesi.filter(p => {
              if (!kisiAtanabilirMi(p, gun, gorev, isOzelGorev, mevcutAraGun)) return false;
              return kisiAtama[p.id].hedefKalan[altTip] > 0;
            });
            
            if (adaylar.length > 0) {
              degisimYapildi = { orijinal: altTip, yeni: tip };
              break;
            }
          }
        }
        
        // AÅAMA 3: Herhangi bir hedefi olan kiÅŸileri bul
        if (adaylar.length === 0) {
          adaylar = personelListesi.filter(p => {
            if (!kisiAtanabilirMi(p, gun, gorev, isOzelGorev, mevcutAraGun)) return false;
            return kalanHedefTipleri(p).length > 0;
          });
          
          if (adaylar.length > 0) {
            const kalanTipler = kalanHedefTipleri(adaylar[0]);
            if (kalanTipler.length > 0 && kalanTipler[0] !== tip) {
              degisimYapildi = { orijinal: kalanTipler[0], yeni: tip };
            }
          }
        }
        
        if (adaylar.length === 0) return;
        
        // Bu gÃ¼ne zaten atanmÄ±ÅŸ kiÅŸileri bul (birlikte tutma iÃ§in) - string'e Ã§evir
        const buGunAtananlar = Object.values(atanan[gun]).map(id => String(id));
        
        // VBA MANTIÄI: En zor kiÅŸiden baÅŸla + BÄ°RLÄ°KTE TUTMA Ã–NCELÄ°ÄÄ°
        adaylar.sort((a, b) => {
          // 1. BÄ°RLÄ°KTE TUTMA: Partneri bu gÃ¼ne atanmÄ±ÅŸsa Ã¶ncelik ver
          const aPartnerler = birlikteMap[String(a.id)] || [];
          const bPartnerler = birlikteMap[String(b.id)] || [];
          const aPartnerBuGunde = aPartnerler.some(pid => buGunAtananlar.includes(String(pid)));
          const bPartnerBuGunde = bPartnerler.some(pid => buGunAtananlar.includes(String(pid)));
          if (aPartnerBuGunde !== bPartnerBuGunde) return aPartnerBuGunde ? -1 : 1;
          
          // 2. KÄ±sÄ±tlamalÄ± kiÅŸileri Ã¶ncelikle
          const aKisitli = kisitlamaMap[String(a.id)] === gorev.ad ? 1 : 0;
          const bKisitli = kisitlamaMap[String(b.id)] === gorev.ad ? 1 : 0;
          if (bKisitli !== aKisitli) return bKisitli - aKisitli;
          
          // 3. Ã–zel gÃ¶rev kotasÄ±
          if (isOzelGorev) {
            const aKalan = (a.gorevKotalari?.[gorev.ad] || 0) - kisiAtama[a.id].gorevSayilari[gorev.ad];
            const bKalan = (b.gorevKotalari?.[gorev.ad] || 0) - kisiAtama[b.id].gorevSayilari[gorev.ad];
            if (bKalan !== aKalan) return bKalan - aKalan;
          }
          
          // 4. VBA: En zor kiÅŸi Ã¶nce (zorluk = kalanHedef / kalanMusaitGun)
          const aZorluk = kisiZorlukHesapla(a, gun, tip);
          const bZorluk = kisiZorlukHesapla(b, gun, tip);
          if (bZorluk.zorluk !== aZorluk.zorluk) return bZorluk.zorluk - aZorluk.zorluk;
          
          // Bu gÃ¼n tipinde hedef kalan
          if (bZorluk.tipHedef !== aZorluk.tipHedef) return bZorluk.tipHedef - aZorluk.tipHedef;
          
          // Toplam hedef kalan
          if (bZorluk.kalanHedef !== aZorluk.kalanHedef) return bZorluk.kalanHedef - aZorluk.kalanHedef;
          
          // GeÃ§miÅŸte az tutan
          const aGecmis = yillikToplamHesapla(a)[tip];
          const bGecmis = yillikToplamHesapla(b)[tip];
          return aGecmis - bGecmis;
        });
        
        // Ata
        const secilen = adaylar[0];
        atanan[gun][slotIdx] = secilen.id;
        if (!kisiAtama[secilen.id].gunler.includes(gun)) {
          kisiAtama[secilen.id].gunler.push(gun);
        }
        kisiAtama[secilen.id].tipSayilari[tip]++;
        
        if (degisimYapildi) {
          kisiAtama[secilen.id].hedefKalan[degisimYapildi.orijinal] = 
            Math.max(0, kisiAtama[secilen.id].hedefKalan[degisimYapildi.orijinal] - 1);
          
          gunTipiDegisimKayitlari.push({
            personel: secilen.ad, personelId: secilen.id, gun,
            orijinalTip: GUN_TIPI_LABEL[degisimYapildi.orijinal], yeniTip: GUN_TIPI_LABEL[tip]
          });
        } else {
          kisiAtama[secilen.id].hedefKalan[tip] = 
            Math.max(0, kisiAtama[secilen.id].hedefKalan[tip] - 1);
        }
        
        if (isOzelGorev) {
          kisiAtama[secilen.id].gorevSayilari[gorev.ad]++;
        }
      });
    });
  }
  
  // Birlikte tutma kurallarÄ±nÄ± kontrol et ve dÃ¼zelt
  birlikteTutmaUygula(atanan, kisiAtama, siraliGorevler, gunSirasi);
  
  // NOT: Ara gÃ¼n = 0 (arka arkaya nÃ¶bet) ASLA yapÄ±lmaz!
  // EÄŸer hala boÅŸ slot varsa, eksik atama olarak kalÄ±r.
  
  // DEBUG: BoÅŸ kalan slotlarÄ± analiz et
  const bosSlotAnaliz = [];
  for (let d = 1; d <= gunSayisi; d++) {
    const bosSlotSayisi = siraliGorevler.length - Object.keys(atanan[d]).length;
    if (bosSlotSayisi > 0) {
      // Bu gÃ¼nde neden boÅŸ slot kaldÄ±?
      const tip = getGunTipi(yil, ay, d);
      
      // Mazeretli sayÄ±sÄ±
      const mazeretliSayisi = personelListesi.filter(p => 
        p.mazeretler?.includes(d) || p.yillikIzinler?.includes(d) || p.nobetIzinleri?.includes(d)
      ).length;
      
      // Ara gÃ¼n kuralÄ± nedeniyle mÃ¼sait olmayan sayÄ±sÄ±
      const araGunEngeli = personelListesi.filter(p => {
        if (p.mazeretler?.includes(d) || p.yillikIzinler?.includes(d) || p.nobetIzinleri?.includes(d)) return false;
        return kisiAtama[p.id].gunler.some(g => Math.abs(g - d) <= 1); // Minimum 1 gÃ¼n ara
      }).length;
      
      // GerÃ§ekten mÃ¼sait olan sayÄ±sÄ±
      const musaitSayisi = personelListesi.length - mazeretliSayisi - araGunEngeli;
      
      bosSlotAnaliz.push({
        gun: d,
        tip: GUN_TIPI_LABEL[tip],
        bosSlot: bosSlotSayisi,
        mazeretli: mazeretliSayisi,
        araGunEngeli: araGunEngeli,
        musait: musaitSayisi
      });
    }
  }
  
  // Console'a yazdÄ±r (debug iÃ§in)
  if (bosSlotAnaliz.length > 0) {
    console.log('=== BOÅ SLOT ANALÄ°ZÄ° ===');
    console.table(bosSlotAnaliz);
    console.log('Toplam boÅŸ slot:', bosSlotAnaliz.reduce((s, x) => s + x.bosSlot, 0));
  }
  
  // Global deÄŸiÅŸkene kaydet (UI'da gÃ¶stermek iÃ§in)
  window.bosSlotAnaliz = bosSlotAnaliz;
  
  // Eksik atama hesapla
  devirListesi = [];
  personelListesi.forEach(p => {
    GUN_TIPLERI.forEach(tip => {
      const kalan = kisiAtama[p.id].hedefKalan[tip];
      if (kalan > 0) {
        devirListesi.push({
          personel: p.ad,
          tip: GUN_TIPI_LABEL[tip],
          eksik: kalan,
          sebep: 'Mazeret/Ara gÃ¼n kuralÄ±'
        });
      }
    });
  });
  
  // Sonucu kaydet
  hesaplananListe = { atanan, kisiAtama, siraliGorevler };
  
  // Ã–nizlemeyi gÃ¼ncelle
  onizlemeGuncelle();
}

function onizlemeGuncelle() {
  if (!hesaplananListe) return;
  
  const { yil, ay } = getYilAy();
  const gunSayisi = getGunSayisi(yil, ay);
  const { atanan, kisiAtama, siraliGorevler } = hesaplananListe;
  
  // Ä°statistikler
  let toplamAtanan = 0;
  let toplamSlot = gunSayisi * siraliGorevler.length;
  
  for (let d = 1; d <= gunSayisi; d++) {
    toplamAtanan += Object.keys(atanan[d]).length;
  }
  
  document.getElementById('stat-toplam').textContent = toplamAtanan;
  document.getElementById('stat-doluluk').textContent = `%${Math.round(toplamAtanan / toplamSlot * 100)}`;
  document.getElementById('stat-devir').textContent = devirListesi.length;
  
  // Eksik atama ve deÄŸiÅŸim kayÄ±tlarÄ±
  const devirDiv = document.getElementById('devir-listesi');
  const devirIcerik = document.getElementById('devir-icerik');
  
  let icerikHtml = '';
  
  // GÃ¼n tipi deÄŸiÅŸim kayÄ±tlarÄ±
  if (gunTipiDegisimKayitlari.length > 0) {
    icerikHtml += `
      <div class="rule-box mb-3" style="background:#dbeafe; border-left:4px solid #3b82f6;">
        <strong>ğŸ”„ GÃ¼n Tipi DeÄŸiÅŸimleri (${gunTipiDegisimKayitlari.length} adet)</strong>
        <div class="help mb-3">Hedef karÅŸÄ±lanamadÄ±ÄŸÄ± iÃ§in alternatif gÃ¼n tipine kaydÄ±rÄ±ldÄ±.</div>
        <div style="max-height:150px; overflow-y:auto;">
          ${gunTipiDegisimKayitlari.map(d => 
            `<div class="badge badge-info" style="margin:2px;">${d.personel}: ${d.orijinalTip} â†’ ${d.yeniTip} (${d.gun}. gÃ¼n)</div>`
          ).join('')}
        </div>
      </div>
    `;
  }
  
  // BOÅ SLOT ANALÄ°ZÄ° (yeni eklendi)
  if (window.bosSlotAnaliz && window.bosSlotAnaliz.length > 0) {
    const toplamBos = window.bosSlotAnaliz.reduce((s, x) => s + x.bosSlot, 0);
    icerikHtml += `
      <div class="rule-box mb-3" style="background:#fef3c7; border-left:4px solid #f59e0b;">
        <strong>ğŸ” BoÅŸ Slot Analizi (${toplamBos} boÅŸ slot)</strong>
        <div class="help mb-3">Hangi gÃ¼nlerde neden boÅŸ slot kaldÄ±ÄŸÄ±nÄ± gÃ¶sterir.</div>
        <div style="max-height:200px; overflow-y:auto;">
          <table style="width:100%; font-size:12px; border-collapse:collapse;">
            <thead>
              <tr style="background:#fef3c7;">
                <th style="padding:4px; text-align:left;">GÃ¼n</th>
                <th style="padding:4px; text-align:center;">Tip</th>
                <th style="padding:4px; text-align:center;">BoÅŸ</th>
                <th style="padding:4px; text-align:center;">Mazeretli</th>
                <th style="padding:4px; text-align:center;">Ara GÃ¼n Engeli</th>
                <th style="padding:4px; text-align:center;">MÃ¼sait</th>
              </tr>
            </thead>
            <tbody>
              ${window.bosSlotAnaliz.map(x => `
                <tr style="border-bottom:1px solid #e5e7eb;">
                  <td style="padding:4px;">${x.gun}. gÃ¼n</td>
                  <td style="padding:4px; text-align:center;">${x.tip}</td>
                  <td style="padding:4px; text-align:center; color:#dc2626; font-weight:bold;">${x.bosSlot}</td>
                  <td style="padding:4px; text-align:center;">${x.mazeretli}</td>
                  <td style="padding:4px; text-align:center;">${x.araGunEngeli}</td>
                  <td style="padding:4px; text-align:center; color:${x.musait < 5 ? '#dc2626' : '#16a34a'};">${x.musait}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }
  
  // Eksik atamalar
  if (devirListesi.length > 0) {
    icerikHtml += `
      <div class="help mb-3">Bu kiÅŸilerin hedefi mazeret veya ara gÃ¼n kuralÄ± nedeniyle karÅŸÄ±lanamadÄ±.</div>
      ${devirListesi.map(d => 
        `<div class="badge badge-warn" style="margin:2px;">${d.personel}: ${d.eksik}x ${d.tip}</div>`
      ).join('')}
    `;
  }
  
  if (devirListesi.length > 0 || gunTipiDegisimKayitlari.length > 0) {
    devirDiv.style.display = 'block';
    devirDiv.querySelector('h4').textContent = devirListesi.length > 0 
      ? `âš ï¸ Eksik Atamalar (${devirListesi.length})` 
      : 'âœ… TÃ¼m Hedefler KarÅŸÄ±landÄ±';
    devirIcerik.innerHTML = icerikHtml;
  } else {
    devirDiv.style.display = 'none';
  }
  
  // Ã–nizleme tablosu
  const thead = document.getElementById('preview-thead');
  const tbody = document.getElementById('preview-tbody');
  
  thead.innerHTML = `
    <tr>
      <th>Tarih</th>
      <th>GÃ¼n</th>
      ${siraliGorevler.map(g => `<th>${g.ad}</th>`).join('')}
    </tr>
  `;
  
  const gunIsimleri = ['Paz', 'Pzt', 'Sal', 'Ã‡ar', 'Per', 'Cum', 'Cmt'];
  tbody.innerHTML = '';
  
  for (let d = 1; d <= gunSayisi; d++) {
    const tarih = new Date(yil, ay - 1, d);
    const tip = getGunTipi(yil, ay, d);
    const isWeekend = tip === 'cmt' || tip === 'pzr';
    
    const tr = document.createElement('tr');
    if (isWeekend) tr.classList.add('preview-weekend');
    
    let html = `
      <td>${String(d).padStart(2, '0')}.${String(ay).padStart(2, '0')}.${yil}</td>
      <td>${gunIsimleri[tarih.getDay()]}</td>
    `;
    
    siraliGorevler.forEach((g, idx) => {
      const pid = atanan[d][idx];
      const personel = personelListesi.find(p => p.id === pid);
      html += `<td class="${!personel ? 'preview-empty' : ''}">${personel?.ad || '-'}</td>`;
    });
    
    tr.innerHTML = html;
    tbody.appendChild(tr);
  }
  
  // KiÅŸi bazlÄ± Ã¶zet
  const kisiOzetTbody = document.getElementById('kisi-ozet-tbody');
  kisiOzetTbody.innerHTML = '';
  
  personelListesi.forEach(p => {
    const atama = kisiAtama[p.id];
    const toplam = atama.gunler.length;
    const saat = GUN_TIPLERI.reduce((s, t) => s + atama.tipSayilari[t] * getSaatDeger(t), 0);
    
    let durum = 'âœ…';
    let durumClass = 'badge-ok';
    
    GUN_TIPLERI.forEach(t => {
      if (atama.tipSayilari[t] !== p.hedef[t]) {
        durum = 'âš ï¸';
        durumClass = 'badge-warn';
      }
    });
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="font-weight:700;">${p.ad || '(isimsiz)'}</td>
      ${GUN_TIPLERI.map(t => {
        const hedef = p.hedef[t];
        const gercek = atama.tipSayilari[t];
        const cls = gercek === hedef ? 'badge-ok' : (Math.abs(gercek - hedef) <= 1 ? 'badge-warn' : 'badge-bad');
        return `<td><span class="badge ${cls}">${gercek}/${hedef}</span></td>`;
      }).join('')}
      <td><strong>${toplam}</strong></td>
      <td>${saat}s</td>
      <td><span class="badge ${durumClass}">${durum}</span></td>
    `;
    kisiOzetTbody.appendChild(tr);
  });
}

async function listeyiIndir() {
  if (!hesaplananListe) {
    alert('Ã–nce listeyi oluÅŸturun!');
    return;
  }
  
  // Backend'den gelen Excel URL varsa direkt indir
  if (window.sonExcelUrl) {
    window.open(window.sonExcelUrl, '_blank');
    return;
  }
  
  // Yoksa yerel olarak oluÅŸtur
  const { yil, ay } = getYilAy();
  const gunSayisi = getGunSayisi(yil, ay);
  const { atanan, siraliGorevler } = hesaplananListe;
  
  // ExcelJS ile Excel oluÅŸtur
  const workbook = new ExcelJS.Workbook();
  const ws = workbook.addWorksheet('NÃ¶bet Listesi');
  
  // BaÅŸlÄ±klar
  const headers = ['Tarih', 'GÃ¼n', ...siraliGorevler.map(g => g.ad)];
  ws.addRow(headers);
  
  // BaÅŸlÄ±k stili
  ws.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
  ws.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4472C4' } };
  ws.getRow(1).alignment = { horizontal: 'center' };
  
  const gunIsimleri = ['Paz', 'Pzt', 'Sal', 'Ã‡ar', 'Per', 'Cum', 'Cmt'];
  
  for (let d = 1; d <= gunSayisi; d++) {
    const tarih = new Date(yil, ay - 1, d);
    const tip = getGunTipi(yil, ay, d);
    const gunAdi = gunIsimleri[tarih.getDay()];
    
    const rowData = [
      `${String(d).padStart(2, '0')}.${String(ay).padStart(2, '0')}.${yil}`,
      gunAdi
    ];
    
    siraliGorevler.forEach((g, idx) => {
      const pid = atanan[d][idx];
      const personel = personelListesi.find(p => p.id === pid);
      rowData.push(personel?.ad || '-');
    });
    
    const row = ws.addRow(rowData);
    
    // Hafta sonu sarÄ±
    if (tip === 'cmt' || tip === 'pzr') {
      row.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFE699' } };
    }
  }
  
  // SÃ¼tun geniÅŸlikleri
  ws.columns.forEach((col, i) => {
    col.width = i === 0 ? 12 : (i === 1 ? 6 : 20);
  });
  
  // Ä°ndir
  const buffer = await workbook.xlsx.writeBuffer();
  const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Nobet_${yil}_${ay}.xlsx`;
  a.click();
  URL.revokeObjectURL(url);
}

// ============================================
// KAYDET / YÃœKLE
// ============================================
function kaydet() {
  const uid = auth?.currentUser?.uid || 'LOCAL';
  const data = {
    personelListesi,
    resmiTatiller,
    kurallar,
    gorevler,
    manuelAtamalar,
    gorevKisitlamalari,
    kisitlamaExclusive,
    gorevKapasiteAyar,
    devirListesi,
    ayarlar: {
      yil: document.getElementById('inp-yil').value,
      ay: document.getElementById('inp-ay').value,
      gunluk: document.getElementById('inp-gunluk').value,
      aragun: document.getElementById('inp-aragun').value,
      detayli: true, // Her zaman detaylÄ± mod
      saatler: {
        hici: document.getElementById('saat-hici').value,
        prs: document.getElementById('saat-prs').value,
        cum: document.getElementById('saat-cum').value,
        cmt: document.getElementById('saat-cmt').value,
        pzr: document.getElementById('saat-pzr').value
      }
    },
    step: currentStep
  };
  localStorage.setItem(`nobet_v2_${uid}`, JSON.stringify(data));
}

function yukle() {
  const uid = auth?.currentUser?.uid || 'LOCAL';
  const saved = localStorage.getItem(`nobet_v2_${uid}`);
  
  if (saved) {
    try {
      const data = JSON.parse(saved);
      personelListesi = data.personelListesi || [];
      resmiTatiller = data.resmiTatiller || [];
      kurallar = data.kurallar || [];
      gorevler = data.gorevler || [];
      manuelAtamalar = data.manuelAtamalar || [];
      gorevKisitlamalari = data.gorevKisitlamalari || [];
      kisitlamaExclusive = data.kisitlamaExclusive || false;
      gorevKapasiteAyar = data.gorevKapasiteAyar || {};
      devirListesi = data.devirListesi || [];
      
      // Checkbox'Ä± gÃ¼ncelle
      const exclusiveCheckbox = document.getElementById('kisitlama-exclusive');
      if (exclusiveCheckbox) exclusiveCheckbox.checked = kisitlamaExclusive;
      
      if (data.ayarlar) {
        document.getElementById('inp-yil').value = data.ayarlar.yil || 2025;
        document.getElementById('inp-ay').value = data.ayarlar.ay || 12;
        document.getElementById('inp-gunluk').value = data.ayarlar.gunluk || 5;
        document.getElementById('inp-aragun').value = (data.ayarlar.aragun != null) ? data.ayarlar.aragun : 2;
        // detayli-mod artÄ±k her zaman true, checkbox kaldÄ±rÄ±ldÄ±
        
        if (data.ayarlar.saatler) {
          document.getElementById('saat-hici').value = data.ayarlar.saatler.hici || 8;
          document.getElementById('saat-prs').value = data.ayarlar.saatler.prs || 8;
          document.getElementById('saat-cum').value = data.ayarlar.saatler.cum || 16;
          document.getElementById('saat-cmt').value = data.ayarlar.saatler.cmt || 24;
          document.getElementById('saat-pzr').value = data.ayarlar.saatler.pzr || 16;
        }
      }
      
      tatilListesiGuncelle();
      kuralListesiGuncelle();
      gorevKisitlamaListesiGuncelle();
      goStep(data.step || 1);
    } catch (e) {
      console.error('Veri yÃ¼kleme hatasÄ±:', e);
      goStep(1);
    }
  } else {
    goStep(1);
  }
}

// Sayfa yÃ¼klendiÄŸinde
document.addEventListener('DOMContentLoaded', () => {
  tatilListesiGuncelle();
});
</script>
</body>
</html>
